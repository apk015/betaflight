import{$ as e,c as O,M as g,b as Lt,G as N,T as D,f as Tt,d as io,t as wt}from"./DarkTheme-2fd54461.js";import{F as s,a as h,m as b,v as ro,w as St,x as $,E as Pt,n as kt,b as no,o as ao}from"./main-ef562b84.js";import{l as Bt,a as Gt,b as Ht,c as _o,s as lo}from"./transform-8625d4bb.js";import{e as co}from"./extent-4cf1c809.js";class Ct{constructor(t){this.FrameColor="rgb(186, 186, 186)",this.PropEdgeColor="rgb(255, 187, 0)",this.PropColor="rgb(186, 186, 186, 0.4)",this.PropEdgeLineWidth=3,this.MotorNumberTextFont=`${t*.1}px 'Open Sans', 'Segoe UI', Tahoma, sans-serif`,this.MotorNumberTextColor="rgb(0, 0, 0)",this.MotorMouseHoverColor="rgba(255, 187, 0, 0.4)",this.MotorSpinningColor="rgba(255, 0, 0, 0.4)",this.MotorReadyColor="rgba(0,128,0,0.4)",this.ArrowColor="rgb(182,67,67)",this.DirectionArrowPoints=[{x:-.03*t,y:.11*t},{x:-.03*t,y:-.01*t},{x:-.07*t,y:-.01*t},{x:0*t,y:-.13*t},{x:.07*t,y:-.01*t},{x:.03*t,y:-.01*t},{x:.03*t,y:.11*t}];let o=.28*t;this["Quad X"]={PropRadius:.2*t,ArmWidth:.1*t,Motors:[{x:o,y:o},{x:o,y:-o},{x:-o,y:o},{x:-o,y:-o}]},o=.28*t,this["Quad X 1234"]={PropRadius:.2*t,ArmWidth:.1*t,Motors:[{x:-o,y:-o},{x:o,y:-o},{x:o,y:o},{x:-o,y:o}]},o=.32*t,this["Quad +"]={PropRadius:.15*t,ArmWidth:.1*t,Motors:[{x:0,y:o},{x:o,y:0},{x:-o,y:0},{x:0,y:-o}]},o=.3*t,this.Tricopter={PropRadius:.15*t,ArmWidth:.1*t,Motors:[{x:0,y:o},{x:o,y:-o},{x:-o,y:-o}]},o=.35*t,this["Hex +"]={PropRadius:.14*t,ArmWidth:.1*t,Motors:[]};let r=Math.PI/3,n=0;n=r*1,this["Hex +"].Motors.push({x:Math.sin(n)*o,y:Math.cos(n)*o}),n=r*2,this["Hex +"].Motors.push({x:Math.sin(n)*o,y:Math.cos(n)*o}),n=-r*1,this["Hex +"].Motors.push({x:Math.sin(n)*o,y:Math.cos(n)*o}),n=-r*2,this["Hex +"].Motors.push({x:Math.sin(n)*o,y:Math.cos(n)*o}),n=r*3,this["Hex +"].Motors.push({x:Math.sin(n)*o,y:Math.cos(n)*o}),n=r*0,this["Hex +"].Motors.push({x:Math.sin(n)*o,y:Math.cos(n)*o}),o=.35*t,this["Hex X"]={PropRadius:.14*t,ArmWidth:.1*t,Motors:[]},r=Math.PI/3,n=r*1,this["Hex X"].Motors.push({x:Math.cos(n)*o,y:Math.sin(n)*o}),n=-r*1,this["Hex X"].Motors.push({x:Math.cos(n)*o,y:Math.sin(n)*o}),n=r*2,this["Hex X"].Motors.push({x:Math.cos(n)*o,y:Math.sin(n)*o}),n=-r*2,this["Hex X"].Motors.push({x:Math.cos(n)*o,y:Math.sin(n)*o}),n=r*0,this["Hex X"].Motors.push({x:Math.cos(n)*o,y:Math.sin(n)*o}),n=r*3,this["Hex X"].Motors.push({x:Math.cos(n)*o,y:Math.sin(n)*o}),this._addOcto("Octo Flat +",-Math.PI/2,t),this._addOcto("Octo Flat X",-Math.PI/2+Math.PI/8,t),this._addOctoX8(t),this._addBicopter(t),this._addVTailQuad(t),this._addATailQuad(t),this._addY4(t),this._addY6(t)}_addY6(t){const o=.3*t;this.Y6={PropRadius:.15*t,ArmWidth:.1*t,Motors:[{x:0,y:o*.7,top:!0},{x:o*.7,y:-o*.7,top:!0},{x:-o*.7,y:-o*.7,top:!0},{x:0,y:o*1.1,bottom:!0},{x:o*1.1,y:-o*1.1,bottom:!0},{x:-o*1.1,y:-o*1.1,bottom:!0}]}}_addY4(t){const o=.3*t;this.Y4={PropRadius:.15*t,ArmWidth:.1*t,Motors:[{x:0,y:o*.7,top:!0},{x:o,y:-o},{x:0,y:o*1.1,bottom:!0},{x:-o,y:-o}]}}_addVTailQuad(t){const o=.3*t;this["V-tail Quad"]={PropRadius:.15*t,ArmWidth:.1*t,Motors:[{x:o*.7,y:o*.7},{x:o,y:-o},{x:-o*.7,y:o*.7},{x:-o,y:-o}]}}_addATailQuad(t){const o=.3*t;this["A-tail Quad"]={PropRadius:.15*t,ArmWidth:.1*t,Motors:[{x:-o*.7,y:o*.7},{x:o,y:-o},{x:o*.7,y:o*.7},{x:-o,y:-o}]}}_addBicopter(t){const o=.35*t;this.Bicopter={PropRadius:.2*t,ArmWidth:.1*t,Motors:[{x:-o,y:0},{x:o,y:0}]}}_addOctoX8(t){const o=.2*t,r=.28*t;this["Octo X8"]={PropRadius:.12*t,ArmWidth:.1*t,Motors:[{x:o,y:o,top:!0},{x:o,y:-o,top:!0},{x:-o,y:o,top:!0},{x:-o,y:-o,top:!0},{x:r,y:r,bottom:!0},{x:r,y:-r,bottom:!0},{x:-r,y:r,bottom:!0},{x:-r,y:-r,bottom:!0}]}}_addOcto(t,o,r){const n=.35*r;this[t]={PropRadius:.1*r,ArmWidth:.1*r,Motors:[]};const f=Math.PI/4;let d=-f*2+o;this[t].Motors.push({x:Math.cos(d)*n,y:Math.sin(d)*n}),d=f*0+o,this[t].Motors.push({x:Math.cos(d)*n,y:Math.sin(d)*n}),d=f*2+o,this[t].Motors.push({x:Math.cos(d)*n,y:Math.sin(d)*n}),d=f*4+o,this[t].Motors.push({x:Math.cos(d)*n,y:Math.sin(d)*n}),d=-f*1+o,this[t].Motors.push({x:Math.cos(d)*n,y:Math.sin(d)*n}),d=f*1+o,this[t].Motors.push({x:Math.cos(d)*n,y:Math.sin(d)*n}),d=f*3+o,this[t].Motors.push({x:Math.cos(d)*n,y:Math.sin(d)*n}),d=-f*3+o,this[t].Motors.push({x:Math.cos(d)*n,y:Math.sin(d)*n})}}class ho{constructor(t,o,r,n){this._spinMotorCallback=n,this._canvas=t,this._motorClickCallback=r,this._width=this._canvas.width(),this._height=this._canvas.height(),this._screenSize=Math.min(this._width,this._height),this._config=new Ct(this._screenSize),this._canvas.prop({width:this._width,height:this._height}),this._droneConfiguration=o,this._ctx=this._canvas[0].getContext("2d"),this._ctx.translate(this._width/2,this._height/2),this._canvas.mousemove(f=>{this._onMouseMove(f)}),this._canvas.mouseleave(()=>{this._onMouseLeave()}),this._canvas.mousedown(()=>{this._onMouseDown()}),this._canvas.mouseup(()=>{this._onMouseUp(event)}),this._canvas.click(()=>{this._onMouseClick()}),this.startOver()}pause(){this._keepDrawing=!1}startOver(){this.readyMotors=[],this.remappingReady=!1,this._motorIndexToSpinOnMouseDown=-1,this._keepDrawing=!0,this._mouse={x:0,y:0},window.requestAnimationFrame(()=>{this._drawOnce()})}_drawOnce(){this._ctx.clearRect(-this._width/2,-this._height/2,this._width,this._height),this._drawBottomMotors(),this._drawFrame(),this._drawDirectionArrow(),this._markMotors(),this._drawTopMotors(),this._keepDrawing&&window.requestAnimationFrame(()=>{this._drawOnce()})}_onMouseDown(){this.remappingReady&&(this._motorIndexToSpinOnMouseDown=this._getMouseHoverMotorIndex(),this._spinMotorCallback&&this._spinMotorCallback(this._motorIndexToSpinOnMouseDown))}_onMouseUp(){this._motorIndexToSpinOnMouseDown!==-1&&(this._motorIndexToSpinOnMouseDown=-1,this._spinMotorCallback&&this._spinMotorCallback(this._motorIndexToSpinOnMouseDown))}_onMouseClick(){const t=this._getMouseHoverMotorIndex();this._motorClickCallback&&t!==-1&&!this.readyMotors.includes(t)&&this._motorClickCallback(t)}_onMouseMove(t){const o=this._canvas[0].getBoundingClientRect();this._mouse.x=t.clientX-o.left-this._width/2,this._mouse.y=t.clientY-o.top-this._height/2}_onMouseLeave(){this._mouse.x=Number.MIN_SAFE_INTEGER,this._mouse.y=Number.MIN_SAFE_INTEGER,this._motorIndexToSpinOnMouseDown!==-1&&(this._motorIndexToSpinOnMouseDown=-1,this._spinMotorCallback&&this._spinMotorCallback(this._motorIndexToSpinOnMouseDown))}_markMotors(){const t=this._config[this._droneConfiguration].Motors,o=this._getMouseHoverMotorIndex();if(this._motorIndexToSpinOnMouseDown===-1){for(let r=0;r<this.readyMotors.length;r++){const n=this.readyMotors[r];this._ctx.beginPath(),this._ctx.arc(t[n].x,t[n].y,this._config[this._droneConfiguration].PropRadius,0,2*Math.PI),this._ctx.closePath(),this._ctx.fillStyle=this._config.MotorReadyColor,this._ctx.fill()}o!==-1&&!this.readyMotors.includes(o)&&(this._ctx.beginPath(),this._ctx.arc(t[o].x,t[o].y,this._config[this._droneConfiguration].PropRadius,0,2*Math.PI),this._ctx.closePath(),this._ctx.fillStyle=this._config.MotorMouseHoverColor,this._ctx.fill())}else{const r=this._motorIndexToSpinOnMouseDown;for(let n=0;n<t.length;n++)this._ctx.fillStyle=this._config.MotorReadyColor,r===n?this._ctx.fillStyle=this._config.MotorSpinningColor:o===n&&(this._ctx.fillStyle=this._config.MotorMouseHoverColor),this._ctx.beginPath(),this._ctx.arc(t[n].x,t[n].y,this._config[this._droneConfiguration].PropRadius,0,2*Math.PI),this._ctx.closePath(),this._ctx.fill()}}_getMouseHoverMotorIndex(){const t=this._mouse.x,o=this._mouse.y;let r=-1,n=Number.MAX_SAFE_INTEGER,f=-1;const d=this._config[this._droneConfiguration].Motors;for(let E=0;E<d.length;E++){const P=Math.sqrt((t-d[E].x)*(t-d[E].x)+(o-d[E].y)*(o-d[E].y));P<this._config[this._droneConfiguration].PropRadius&&P<n&&(n=P,r=E,"top"in d[E]&&(f=E))}return f>-1&&(r=f),r}_drawTopMotors(){this._drawMotors(!1)}_drawBottomMotors(){this._drawMotors(!0),this._clipTopMotors()}_clipTopMotors(){const t=this._config[this._droneConfiguration].Motors;for(let o=0;o<t.length;o++)"top"in t[o]&&this._clipSingleMotor(o)}_drawMotors(t){this._ctx.lineWidth=this._config.PropEdgeLineWidth,this._ctx.strokeStyle=this._config.PropEdgeColor;const o=this._config[this._droneConfiguration].Motors;this._ctx.fillStyle=this._config.PropColor;for(let r=0;r<o.length;r++)"bottom"in o[r]===t&&this._drawSingleMotor(r)}_clipSingleMotor(t){this._ctx.save();const o=this._config[this._droneConfiguration].Motors[t];this._ctx.beginPath();const r=this._config[this._droneConfiguration].PropRadius;this._arcSingleMotor(t),this._ctx.clip(),this._ctx.clearRect(o.x-r,o.y-r,r*2,r*2),this._ctx.closePath(),this._ctx.restore()}_drawSingleMotor(t){this._ctx.beginPath(),this._arcSingleMotor(t),this._ctx.stroke(),this._ctx.closePath()}_arcSingleMotor(t){const o=this._config[this._droneConfiguration].Motors[t];this._ctx.arc(o.x,o.y,this._config[this._droneConfiguration].PropRadius,0,2*Math.PI)}_drawDirectionArrow(){this._ctx.beginPath(),this._ctx.moveTo(this._config.DirectionArrowPoints[0].x,this._config.DirectionArrowPoints[0].y);for(let t=1;t<this._config.DirectionArrowPoints.length;t++)this._ctx.lineTo(this._config.DirectionArrowPoints[t].x,this._config.DirectionArrowPoints[t].y);this._ctx.closePath(),this._ctx.fillStyle=this._config.ArrowColor,this._ctx.fill()}_drawFrame(){this._ctx.beginPath(),this._ctx.lineWidth=this._config[this._droneConfiguration].ArmWidth,this._ctx.lineCap="round",this._ctx.strokeStyle=this._config.FrameColor;const t=this._config[this._droneConfiguration].Motors;switch(this._droneConfiguration){case"Quad X":case"Quad +":case"Octo X8":this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(t[3].x,t[3].y),this._ctx.moveTo(t[1].x,t[1].y),this._ctx.lineTo(t[2].x,t[2].y);break;case"Quad X 1234":this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(t[2].x,t[2].y),this._ctx.moveTo(t[3].x,t[3].y),this._ctx.lineTo(t[1].x,t[1].y);break;case"Tricopter":this._ctx.moveTo(t[1].x,t[1].y),this._ctx.lineTo(t[2].x,t[2].y),this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(t[0].x,t[2].y);break;case"Hex +":case"Hex X":this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(t[3].x,t[3].y),this._ctx.moveTo(t[1].x,t[1].y),this._ctx.lineTo(t[2].x,t[2].y),this._ctx.moveTo(t[4].x,t[4].y),this._ctx.lineTo(t[5].x,t[5].y);break;case"Octo Flat +":case"Octo Flat X":this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(t[2].x,t[2].y),this._ctx.moveTo(t[1].x,t[1].y),this._ctx.lineTo(t[3].x,t[3].y),this._ctx.moveTo(t[4].x,t[4].y),this._ctx.lineTo(t[6].x,t[6].y),this._ctx.moveTo(t[5].x,t[5].y),this._ctx.lineTo(t[7].x,t[7].y);break;case"Bicopter":this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(t[1].x,t[1].y);break;case"V-tail Quad":this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(0,t[0].y*1.3),this._ctx.lineTo(t[2].x,t[2].y),this._ctx.moveTo(0,t[0].y*1.3),this._ctx.lineTo(0,t[1].y),this._ctx.moveTo(t[1].x,t[1].y),this._ctx.lineTo(t[3].x,t[3].y);break;case"A-tail Quad":this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(0,t[0].y*.7),this._ctx.lineTo(t[2].x,t[2].y),this._ctx.moveTo(0,t[0].y*.7),this._ctx.lineTo(0,t[1].y),this._ctx.moveTo(t[1].x,t[1].y),this._ctx.lineTo(t[3].x,t[3].y);break;case"Y4":this._ctx.moveTo(t[1].x,t[1].y),this._ctx.lineTo(t[3].x,t[3].y),this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(t[0].x,t[3].y);break;case"Y6":this._ctx.moveTo(t[1].x,t[1].y),this._ctx.lineTo(t[2].x,t[2].y),this._ctx.moveTo(t[0].x,t[0].y),this._ctx.lineTo(t[0].x,t[1].y);break}this._ctx.stroke()}}class uo{constructor(t,o,r,n,f){this._contentDiv=t,this._onLoadedCallback=o,this._droneConfiguration=r,this._motorStopValue=n,this._motorSpinValue=f,this._config=new Ct(100),this._currentJerkingTimeout=-1,this._currentJerkingMotor=-1,this._currentSpinningMotor=-1,this._contentDiv.load("./components/MotorOutputReordering/Body.html",()=>{this._setupdialog()})}_readDom(){this._domAgreeSafetyCheckBox=e("#motorsEnableTestMode-dialogMotorOutputReorder"),this._domStartButton=e("#dialogMotorOutputReorderAgreeButton"),this._domStartOverButton=e("#motorsRemapDialogStartOver"),this._domSaveButton=e("#motorsRemapDialogSave"),this._domMainContentBlock=e("#dialogMotorOutputReorderMainContent"),this._domWarningContentBlock=e("#dialogMotorOutputReorderWarning"),this._domActionHintBlock=e("#motorOutputReorderActionHint"),this._domCanvas=e("#motorOutputReorderCanvas")}_setupdialog(){O.localizePage(),this._readDom(),this._resetGui(),this._domAgreeSafetyCheckBox.change(()=>{const t=this._domAgreeSafetyCheckBox.is(":checked");this._domStartButton.toggle(t)}),this._domStartButton.click(()=>{this._onStartButtonClicked()}),this._domStartOverButton.click(()=>{this._startOver()}),this._domSaveButton.click(()=>{this._save()}),this._onLoadedCallback()}close(){this._stopAnyMotorJerking(),this._stopMotor(),this._stopUserInteraction(),this._resetGui()}_resetGui(){this._domMainContentBlock.hide(),this._domWarningContentBlock.show(),this._domStartButton.hide(),this._domAgreeSafetyCheckBox.prop("checked",!1),this._domAgreeSafetyCheckBox.change(),this._showSaveStartOverButtons(!1)}_save(){function t(){g.send_message(h.MSP_EEPROM_WRITE,!1,!1,o)}function o(){Lt(O.getMessage("configurationEepromSaved")),N.tab_switch_cleanup(()=>g.send_message(h.MSP_SET_REBOOT,!1,!1,ro(D.motors)))}s.MOTOR_OUTPUT_ORDER=Array.from(this._newMotorOutputReorder),g.send_message(h.MSP2_SET_MOTOR_OUTPUT_REORDERING,b.crunch(h.MSP2_SET_MOTOR_OUTPUT_REORDERING)),t()}_calculateNewMotorOutputReorder(){this._newMotorOutputReorder=[];for(let t=0;t<this.motorOutputReorderCanvas.readyMotors.length;t++)this._newMotorOutputReorder.push(this._remapMotorIndex(t))}_remapMotorIndex(t){return s.MOTOR_OUTPUT_ORDER[this.motorOutputReorderCanvas.readyMotors.indexOf(t)]}_startOver(){this._showSaveStartOverButtons(!1),this._startUserInteraction()}_showSaveStartOverButtons(t){t?(this._domStartOverButton.show(),this._domSaveButton.show()):(this._domStartOverButton.hide(),this._domSaveButton.hide())}_onStartButtonClicked(){this._domActionHintBlock.text(O.getMessage("motorOutputReorderDialogSelectSpinningMotor")),this._domWarningContentBlock.hide(),this._domMainContentBlock.show(),this._startUserInteraction()}_stopUserInteraction(){this.motorOutputReorderCanvas&&this.motorOutputReorderCanvas.pause()}_startUserInteraction(){this.motorOutputReorderCanvas?this.motorOutputReorderCanvas.startOver():this.motorOutputReorderCanvas=new ho(this._domCanvas,this._droneConfiguration,t=>{this._onMotorClick(t)},t=>{let o=-1;t!==-1&&(o=this.motorOutputReorderCanvas.readyMotors.indexOf(t)),this._spinMotor(o)}),this._startMotorJerking(0)}_stopAnyMotorJerking(){this._currentJerkingTimeout!==-1&&(clearTimeout(this._currentJerkingTimeout),this._currentJerkingTimeout=-1,this._spinMotor(-1)),this._currentJerkingMotor=-1}_startMotorJerking(t){this._stopAnyMotorJerking(),this._currentJerkingMotor=t,this._motorStartTimeout(t)}_motorStartTimeout(t){this._spinMotor(t),this._currentJerkingTimeout=setTimeout(()=>{this._motorStopTimeout(t)},250)}_motorStopTimeout(t){this._spinMotor(-1),this._currentJerkingTimeout=setTimeout(()=>{this._motorStartTimeout(t)},500)}_spinMotor(t){this._currentSpinningMotor=t;const o=[];for(let r=0;r<this._config[this._droneConfiguration].Motors.length;r++)r===t?o.push16(this._motorSpinValue):o.push16(this._motorStopValue);g.send_message(h.MSP_SET_MOTOR,o)}_stopMotor(){this._currentSpinningMotor!==-1&&this._spinMotor(-1)}_onMotorClick(t){this.motorOutputReorderCanvas.readyMotors.push(t),this._currentJerkingMotor++,this._currentJerkingMotor<this._config[this._droneConfiguration].Motors.length?this._startMotorJerking(this._currentJerkingMotor):(this._stopAnyMotorJerking(),this._domActionHintBlock.text(O.getMessage("motorOutputReorderDialogRemapIsDone")),this._calculateNewMotorOutputReorder(),this.motorOutputReorderCanvas.remappingReady=!0,this._showSaveStartOverButtons(!0))}}class mo{constructor(t){this._intervalId=null,this._interval=t,this._queue=[],this._purging=!1}pushCommand(t,o){this._queue.push([t,o])}pushPause(t){const o=Math.ceil(t/this._interval);for(let r=0;r<o;r++)this.pushCommand(null,null)}start(){this._intervalId===null&&(this._intervalId=setInterval(()=>{this._checkQueue()},this._interval))}stop(){this._intervalId!==null&&(clearInterval(this._intervalId),this._intervalId=null)}stopWhenEmpty(){this._purging=!0}clear(){this._queue=[]}_checkQueue(){if(this._queue.length!==0){const t=this._queue.shift();t[0]!==null&&g.send_message(t[0],t[1])}else this._purging&&(this._purging=!1,this.stop())}}class R{static get ALL_MOTORS(){return 255}}R.dshotCommands_e={DSHOT_CMD_MOTOR_STOP:0,DSHOT_CMD_BEACON1:1,DSHOT_CMD_BEACON2:2,DSHOT_CMD_BEACON3:3,DSHOT_CMD_BEACON4:4,DSHOT_CMD_BEACON5:5,DSHOT_CMD_ESC_INFO:6,DSHOT_CMD_SPIN_DIRECTION_1:7,DSHOT_CMD_SPIN_DIRECTION_2:8,DSHOT_CMD_3D_MODE_OFF:9,DSHOT_CMD_3D_MODE_ON:10,DSHOT_CMD_SETTINGS_REQUEST:11,DSHOT_CMD_SAVE_SETTINGS:12,DSHOT_CMD_SPIN_DIRECTION_NORMAL:20,DSHOT_CMD_SPIN_DIRECTION_REVERSED:21,DSHOT_CMD_LED0_ON:22,DSHOT_CMD_LED1_ON:23,DSHOT_CMD_LED2_ON:24,DSHOT_CMD_LED3_ON:25,DSHOT_CMD_LED0_OFF:26,DSHOT_CMD_LED1_OFF:27,DSHOT_CMD_LED2_OFF:28,DSHOT_CMD_LED3_OFF:29,DSHOT_CMD_AUDIO_STREAM_MODE_ON_OFF:30,DSHOT_CMD_SILENT_MODE_ON_OFF:31,DSHOT_CMD_MAX:47};R.dshotCommandType_e={DSHOT_CMD_TYPE_INLINE:0,DSHOT_CMD_TYPE_BLOCKING:1};class go{constructor(t,o,r){this._numberOfMotors=t.numberOfMotors,this._motorStopValue=t.motorStopValue,this._motorSpinValue=t.motorSpinValue,this._motorDriverStopMotorsPauseMs=r,this._state=[];for(let n=0;n<this._numberOfMotors;n++)this._state.push(this._motorStopValue);this._stateStack=[],this._EscDshotCommandQueue=new mo(o)}activate(){this._EscDshotCommandQueue.start()}deactivate(){this._EscDshotCommandQueue.stopWhenEmpty()}stopMotor(t){this._spinMotor(t,this._motorStopValue)}spinMotor(t){this._spinMotor(t,this._motorSpinValue)}spinAllMotors(){this._spinAllMotors(this._motorSpinValue)}stopAllMotors(){this._spinAllMotors(this._motorStopValue)}stopAllMotorsNow(){this._EscDshotCommandQueue.clear(),this._spinAllMotors(this._motorStopValue)}setEscSpinDirection(t,o){let r=!1;R.ALL_MOTORS===t?r=this._isAnythingSpinning():r=this._isMotorSpinning(t),r?(this._pushState(),this._spinMotor(t,this._motorStopValue),this._EscDshotCommandQueue.pushPause(this._motorDriverStopMotorsPauseMs),this._sendEscSpinDirection(t,o),this._popState(),this._sendState()):this._sendEscSpinDirection(t,o)}_pushState(){const t=[...this._state];this._stateStack.push(t)}_popState(){const t=this._stateStack.pop();this._state=[...t]}_isAnythingSpinning(){let t=!1;for(let o=0;o<this._numberOfMotors;o++)if(this._motorStopValue!==this._state[o]){t=!0;break}return t}_isMotorSpinning(t){return this._motorStopValue!==this._state[t]}_sendEscSpinDirection(t,o){const r=[];r.push8(R.dshotCommandType_e.DSHOT_CMD_TYPE_BLOCKING),r.push8(t),r.push8(2),r.push8(o),r.push8(R.dshotCommands_e.DSHOT_CMD_SAVE_SETTINGS),this._EscDshotCommandQueue.pushCommand(h.MSP2_SEND_DSHOT_COMMAND,r);let n="";if(t===R.ALL_MOTORS)n+=i18n.getMessage("motorsText");else{const f=t+1;n+=i18n.getMessage(`motorNumber${f}`)}n+=": ",o===R.dshotCommands_e.DSHOT_CMD_SPIN_DIRECTION_1?n+=i18n.getMessage("escDshotDirectionDialog-CommandNormal"):n+=i18n.getMessage("escDshotDirectionDialog-CommandReverse"),Lt(n)}_spinMotor(t,o){R.ALL_MOTORS===t?this._spinAllMotors(o):(this._state[t]=o,this._sendState())}_spinAllMotors(t){for(let o=0;o<this._numberOfMotors;o++)this._state[o]=t;this._sendState()}_sendState(){const t=[];for(let o=0;o<this._numberOfMotors;o++)t.push16(this._state[o]);this._EscDshotCommandQueue.pushCommand(h.MSP_SET_MOTOR,t)}}class T{constructor(t,o,r){this._buttonTimeoutMs=400;const n=100,f=400;this._motorDriver=new go(r,n,f),this._escProtocolIsDshot=r.escProtocolIsDshot,this._numberOfMotors=r.numberOfMotors,this._contentDiv=t,this._onLoadedCallback=o,this._currentSpinningMotor=-1,this._selectedMotor=-1,this._motorIsSpinning=!1,this._allMotorsAreSpinning=!1,this._spinDirectionToggleIsActive=!0,this._activationButtonTimeoutId=null,this._contentDiv.load("./components/EscDshotDirection/Body.html",()=>{this._initializeDialog()})}static get PUSHED_BUTTON_CLASS(){return"pushed"}static get HIGHLIGHTED_BUTTON_CLASS(){return"highlighted"}static get RED_TEXT_CLASS(){return"red-text"}static get _BUTTON_PUSH_DOWN_EVENT_TYPE(){return"mousedown"}static get _BUTTON_RELEASE_EVENT_TYPE(){return"mouseup mouseout"}_readDom(){this._domAgreeSafetyCheckBox=e("#escDshotDirectionDialog-safetyCheckbox"),this._domStartButton=e("#escDshotDirectionDialog-Start"),this._domStartWizardButton=e("#escDshotDirectionDialog-StartWizard"),this._domMainContentBlock=e("#escDshotDirectionDialog-MainContent"),this._domWarningContentBlock=e("#escDshotDirectionDialog-Warning"),this._domMixerImg=e("#escDshotDirectionDialog-MixerPreviewImg"),this._domMotorButtonsBlock=e("#escDshotDirectionDialog-SelectMotorButtonsWrapper"),this._domSpinDirectionWrapper=e("#escDshotDirectionDialog-CommandsWrapper"),this._domActionHint=e("#escDshotDirectionDialog-ActionHint"),this._domSpinNormalButton=e("#escDshotDirectionDialog-RotationNormal"),this._domSpinReverseButton=e("#escDshotDirectionDialog-RotationReverse"),this._domSecondHint=e("#escDshotDirectionDialog-SecondHint"),this._domSecondActionDiv=e("#escDshotDirectionDialog-SecondActionBlock"),this._domConfigErrors=e("#escDshotDirectionDialog-ConfigErrors"),this._domWrongProtocolMessage=e("#escDshotDirectionDialog-WrongProtocol"),this._domWrongMixerMessage=e("#escDshotDirectionDialog-WrongMixer"),this._domWrongFirmwareMessage=e("#escDshotDirectionDialog-WrongFirmware"),this._domWizardBlock=e("#escDshotDirectionDialog-WizardDialog"),this._domNormalDialogBlock=e("#escDshotDirectionDialog-NormalDialog"),this._domSpinningWizard=e("#escDshotDirectionDialog-SpinningWizard"),this._domSpinWizardButton=e("#escDshotDirectionDialog-SpinWizard"),this._domStopWizardButton=e("#escDshotDirectionDialog-StopWizard"),this._domWizardMotorButtonsBlock=e("#escDshotDirectionDialog-WizardMotorButtons"),this._domStartWizardBlock=e("#escDshotDirectionDialog-StartWizardBlock"),this._domStartNormalBlock=e("#escDshotDirectionDialog-StartNormalBlock"),this._topHintText=O.getMessage("escDshotDirectionDialog-SelectMotor"),this._releaseToStopText=O.getMessage("escDshotDirectionDialog-ReleaseToStop"),this._releaseButtonToStopText=O.getMessage("escDshotDirectionDialog-ReleaseButtonToStop"),this._normalText=O.getMessage("escDshotDirectionDialog-CommandNormal"),this._reverseText=O.getMessage("escDshotDirectionDialog-CommandReverse"),this._secondHintText=O.getMessage("escDshotDirectionDialog-SetDirectionHint")}_initializeDialog(){this._readDom(),this._createMotorButtons(),this._createWizardMotorButtons(),this._domSecondActionDiv.toggle(!1),O.localizePage(),this._resetGui(),this._domAgreeSafetyCheckBox.on("change",()=>{const o=this._domAgreeSafetyCheckBox.is(":checked");this._domStartNormalBlock.toggle(o),this._domStartWizardBlock.toggle(o)}),this._domStartButton.on("click",()=>{this._onStartButtonClicked()}),this._domStartWizardButton.on("click",()=>{this._onStartWizardButtonClicked()}),this._domSpinWizardButton.on("click",()=>{this._onSpinWizardButtonClicked()}),this._domStopWizardButton.on("click",()=>{this._onStopWizardButtonClicked()});const t=St(s.MIXER_CONFIG.mixer,s.MIXER_CONFIG.reverseMotorDir,s.CONFIG.apiVersion);this._domMixerImg.attr("src",t),this._onLoadedCallback()}_activateNormalReverseButtons(t){this._activationButtonTimeoutId=setTimeout(()=>{this._subscribeDirectionSpinButton(this._domSpinNormalButton,R.dshotCommands_e.DSHOT_CMD_SPIN_DIRECTION_1,this._normalText),this._subscribeDirectionSpinButton(this._domSpinReverseButton,R.dshotCommands_e.DSHOT_CMD_SPIN_DIRECTION_2,this._reverseText)},t)}_deactivateNormalReverseButtons(){this._activationButtonTimeoutId!==null&&clearTimeout(this._activationButtonTimeoutId),this._domSpinNormalButton.off(),this._domSpinReverseButton.off()}_subscribeDirectionSpinButton(t,o,r){t.on(T._BUTTON_PUSH_DOWN_EVENT_TYPE,()=>{this._sendCurrentEscSpinDirection(o),this._motorIsSpinning=!0,t.text(this._releaseToStopText),t.addClass(T.HIGHLIGHTED_BUTTON_CLASS),this._motorDriver.spinMotor(this._selectedMotor),this._domSecondHint.html(this._releaseButtonToStopText),this._domSecondHint.addClass(T.RED_TEXT_CLASS)}),t.on(T._BUTTON_RELEASE_EVENT_TYPE,()=>{this._motorIsSpinning&&(t.text(r),this._motorIsSpinning=!1,t.removeClass(T.HIGHLIGHTED_BUTTON_CLASS),this._motorDriver.stopAllMotors(),this._domSecondHint.text(this._secondHintText),this._domSecondHint.removeClass(T.RED_TEXT_CLASS),this._deactivateNormalReverseButtons(),this._activateNormalReverseButtons(this._buttonTimeoutMs))})}_sendCurrentEscSpinDirection(t){this._motorDriver.setEscSpinDirection(this._selectedMotor,t)}_createMotorButtons(){this._motorButtons={};for(let t=0;t<this._numberOfMotors;t++)this._addMotorButton(t+1,t);this._addMotorButton("All",R.ALL_MOTORS)}_addMotorButton(t,o){const r=e(`<a href="#" class="regular-button ${T.PUSHED_BUTTON_CLASS}"></a>`).text(t);this._domMotorButtonsBlock.append(r),this._motorButtons[o]=r,r.on(T._BUTTON_PUSH_DOWN_EVENT_TYPE,()=>{this._domSecondActionDiv.toggle(!0),this._motorIsSpinning=!0,this._domActionHint.html(this._releaseButtonToStopText),this._domActionHint.addClass(T.RED_TEXT_CLASS),this._changeSelectedMotor(o),r.addClass(T.HIGHLIGHTED_BUTTON_CLASS),this._motorDriver.spinMotor(this._selectedMotor)}),r.on(T._BUTTON_RELEASE_EVENT_TYPE,()=>{this._motorIsSpinning&&(this._domActionHint.html(this._topHintText),this._domActionHint.removeClass(T.RED_TEXT_CLASS),this._motorIsSpinning=!1,r.removeClass(T.HIGHLIGHTED_BUTTON_CLASS),this._motorDriver.stopAllMotors(),this._deactivateNormalReverseButtons(),this._activateNormalReverseButtons(this._buttonTimeoutMs))})}_createWizardMotorButtons(){this._wizardMotorButtons={};for(let t=0;t<this._numberOfMotors;t++)this._addWizardMotorButton(t+1,t)}_activateWizardMotorButtons(t){this._activationButtonTimeoutId=setTimeout(()=>{for(let o=0;o<this._numberOfMotors;o++)this._activateWizardMotorButton(o)},t)}_deactivateWizardMotorButtons(){this._activationButtonTimeoutId!==null&&clearTimeout(this._activationButtonTimeoutId);for(let t=0;t<this._numberOfMotors;t++)this._wizardMotorButtons[t].off()}_addWizardMotorButton(t,o){const r=e('<a href="#" class="regular-button"></a>').text(t);this._domWizardMotorButtonsBlock.append(r),this._wizardMotorButtons[o]=r}_activateWizardMotorButton(t){const o=this._wizardMotorButtons[t];o.on("click",()=>{this._wizardMotorButtonClick(o,t)})}_wizardMotorButtonClick(t,o){this._deactivateWizardMotorButtons(),t.hasClass(T.PUSHED_BUTTON_CLASS)?(t.removeClass(T.PUSHED_BUTTON_CLASS),this._motorDriver.setEscSpinDirection(o,R.dshotCommands_e.DSHOT_CMD_SPIN_DIRECTION_1)):(this._motorDriver.setEscSpinDirection(o,R.dshotCommands_e.DSHOT_CMD_SPIN_DIRECTION_2),t.addClass(T.PUSHED_BUTTON_CLASS)),this._activateWizardMotorButtons(this._buttonTimeoutMs)}_changeSelectedMotor(t){this._selectedMotor>=0&&this._motorButtons[this._selectedMotor].addClass(T.PUSHED_BUTTON_CLASS),this._selectedMotor=t,this._selectedMotor>-1&&this._motorButtons[this._selectedMotor].removeClass(T.PUSHED_BUTTON_CLASS)}close(){this._motorDriver.stopAllMotorsNow(),this._motorDriver.deactivate(),this._resetGui()}_resetGui(){this._toggleMainContent(!1),this._domStartNormalBlock.hide(),this._domStartWizardBlock.hide(),this._domAgreeSafetyCheckBox.prop("checked",!1),this._domAgreeSafetyCheckBox.trigger("change"),this._domSecondActionDiv.toggle(!1),this._changeSelectedMotor(-1),this._checkForConfigurationErrors()}_checkForConfigurationErrors(){let t=!1;this._domWrongProtocolMessage.hide(),this._domWrongMixerMessage.hide(),this._domWrongFirmwareMessage.hide(),this._escProtocolIsDshot||(t=!0,this._domWrongProtocolMessage.show()),this._numberOfMotors<=0&&(t=!0,this._domWrongMixerMessage.show()),t?(this._domMainContentBlock.hide(),this._domWarningContentBlock.hide(),this._domStartNormalBlock.hide(),this._domStartWizardBlock.hide(),this._domConfigErrors.show()):this._domConfigErrors.hide()}_onStartButtonClicked(){this._toggleMainContent(!0),this._domWizardBlock.toggle(!1),this._domNormalDialogBlock.toggle(!0),this._motorDriver.activate()}_onStartWizardButtonClicked(){this._domSpinningWizard.toggle(!1),this._domSpinWizardButton.toggle(!0),this._toggleMainContent(!0),this._domWizardBlock.toggle(!0),this._domNormalDialogBlock.toggle(!1),this._motorDriver.activate()}_onSpinWizardButtonClicked(){for(let t=0;t<this._numberOfMotors;t++)this._wizardMotorButtons[t].removeClass(T.PUSHED_BUTTON_CLASS);this._motorDriver.setEscSpinDirection(R.ALL_MOTORS,R.dshotCommands_e.DSHOT_CMD_SPIN_DIRECTION_1),this._domSpinWizardButton.toggle(!1),this._domSpinningWizard.toggle(!0),this._motorDriver.spinAllMotors(),this._activateWizardMotorButtons(0)}_onStopWizardButtonClicked(){this._domSpinWizardButton.toggle(!0),this._domSpinningWizard.toggle(!1),this._motorDriver.stopAllMotorsNow(),this._deactivateWizardMotorButtons()}_toggleMainContent(t){this._domWarningContentBlock.toggle(!t),this._domMainContentBlock.toggle(t),this._domConfigErrors.toggle(!1)}}const j={previousDshotBidir:null,previousFilterDynQ:null,previousFilterDynCount:null,analyticsChanges:{},configHasChanged:!1,configChanges:{},feature3DEnabled:!1,sensor:"gyro",sensorGyroRate:20,sensorGyroScale:2e3,sensorAccelRate:20,sensorAccelScale:2,sensorSelectValues:{gyroScale:{1:1,2:2,3:3,4:4,5:5,10:10,25:25,50:50,100:100,200:200,300:300,400:400,500:500,1e3:1e3,2e3:2e3},accelScale:{"0.05":.05,"0.1":.1,"0.2":.2,"0.3":.3,"0.4":.4,"0.5":.5,1:1,2:2}},DSHOT_PROTOCOL_MIN_VALUE:0,DSHOT_DISARMED_VALUE:1e3,DSHOT_MAX_VALUE:2e3,DSHOT_3D_NEUTRAL:1500};j.initialize=async function(C){const t=this;t.armed=!1,t.escProtocolIsDshot=!1,t.configHasChanged=!1,t.configChanges={};const o=s.getFilterDefaults();N.active_tab="motors",await g.promise(h.MSP_PID_ADVANCED),await g.promise(h.MSP_FEATURE_CONFIG),await g.promise(h.MSP_MIXER_CONFIG),(s.MOTOR_CONFIG.use_dshot_telemetry||s.MOTOR_CONFIG.use_esc_sensor)&&await g.promise(h.MSP_MOTOR_TELEMETRY),await g.promise(h.MSP_MOTOR_CONFIG),await g.promise(h.MSP_MOTOR_3D_CONFIG),await g.promise(h.MSP2_MOTOR_OUTPUT_REORDERING),await g.promise(h.MSP_ADVANCED_CONFIG),await g.promise(h.MSP_FILTER_CONFIG),await g.promise(h.MSP_ARMING_CONFIG),r();function r(){e("#content").load("./tabs/motors.html",Wt)}function n(){t.armed=no(s.CONFIG.mode,0)}function f(){for(let a=0;a<3;a++)s.SENSOR_DATA.accelerometer[a]=0,s.SENSOR_DATA.gyroscope[a]=0}function d(a){const u=Array.from({length:a});for(let M=0;M<a;M++)u[M]=[],u[M].min=-1,u[M].max=1;return u}function E(a,u,M){for(let c=0;c<a.length;c++){const p=M[c];a[c].push([u,p]),p<a[c].min&&(a[c].min=p),p>a[c].max&&(a[c].max=p)}for(;a[0].length>300;)for(const c of a)c.shift();return u+1}const P={top:20,right:30,bottom:10,left:20};function rt(a){a.width=a.targetElement.width()-P.left-P.right,a.height=a.targetElement.height()-P.top-P.bottom,a.widthScale.range([0,a.width]),a.heightScale.range([a.height,0]),a.xGrid.tickSize(-a.height,0,0),a.yGrid.tickSize(-a.width,0,0)}function Z(a,u,M){const c={selector:a,targetElement:e(a),dynamicHeightDomain:!M};return c.widthScale=Bt().clamp(!0).domain([u-299,u]),c.heightScale=Bt().clamp(!0).domain(M||[1,-1]),c.xGrid=Gt(),c.yGrid=Ht(),rt(c),c.xGrid.scale(c.widthScale).tickSize(-c.height).tickValues(c.widthScale.ticks(5).concat(c.widthScale.domain())).tickFormat(""),c.yGrid.scale(c.heightScale).tickSize(-c.width).tickValues(c.heightScale.ticks(5).concat(c.heightScale.domain())).tickFormat(""),c.xAxis=Gt().scale(c.widthScale).ticks(5).tickFormat(function(p){return p}),c.yAxis=Ht().scale(c.heightScale).ticks(5).tickFormat(function(p){return p}),c.line=_o().x(function(p){return c.widthScale(p[0])}).y(function(p){return c.heightScale(p[1])}),c}function xt(a,u,M){const c=lo(a.selector);if(a.dynamicHeightDomain){const v=[];e.each(u,function(F,U){v.push(U.min),v.push(U.max)}),a.heightScale.domain(co(v))}a.widthScale.domain([M-299,M]),c.select(".x.grid").call(a.xGrid),c.select(".y.grid").call(a.yGrid),c.select(".x.axis").call(a.xAxis),c.select(".y.axis").call(a.yAxis);const A=c.select("g.data").selectAll("path").data(u,function(v,F){return F});A.enter().append("path").attr("class","line"),A.attr("d",a.line)}function It(a){e.get(a,function(u){const M=e(u).find("svg");e(".mixerPreview").html(M)},"xml")}function Vt(a){const u=St(a,s.MIXER_CONFIG.reverseMotorDir);It(u);const M=new Ct(100),c=e("#motorOutputReorderDialogOpen"),p=$[a-1].name in M&&s.MOTOR_OUTPUT_ORDER&&s.MOTOR_OUTPUT_ORDER.length>0;c.toggle(p),t.escProtocolIsDshot=Pt.IsProtocolDshot(s.CONFIG.apiVersion,s.PID_ADVANCED_CONFIG.fast_pwm_protocol)}function Wt(){O.localizePage(),n(),t.feature3DEnabled=s.FEATURE_CONFIG.features.isEnabled("3D");const a=e("#motorsEnableTestMode");t.analyticsChanges={},a.prop("checked",t.armed),s.MOTOR_CONFIG.use_dshot_telemetry||s.MOTOR_CONFIG.use_esc_sensor||e(".motor_testing .telemetry").hide();function u(i=!1){e(".btn .tool").toggleClass("disabled",t.configHasChanged||i),e(".btn .save").toggleClass("disabled",!t.configHasChanged),e(".btn .stop").toggleClass("disabled",!i)}const M={mixer:s.MIXER_CONFIG.mixer,reverseMotorSwitch:s.MIXER_CONFIG.reverseMotorDir,escprotocol:s.PID_ADVANCED_CONFIG.fast_pwm_protocol+1,feature4:s.FEATURE_CONFIG.features.isEnabled("MOTOR_STOP"),feature12:s.FEATURE_CONFIG.features.isEnabled("3D"),feature27:s.FEATURE_CONFIG.features.isEnabled("ESC_SENSOR"),dshotBidir:s.MOTOR_CONFIG.use_dshot_telemetry,motorPoles:s.MOTOR_CONFIG.motor_poles,digitalIdlePercent:s.PID_ADVANCED_CONFIG.digitalIdlePercent,idleMinRpm:s.ADVANCED_TUNING.idleMinRpm,_3ddeadbandlow:s.MOTOR_3D_CONFIG.deadband3d_low,_3ddeadbandhigh:s.MOTOR_3D_CONFIG.deadband3d_high,_3dneutral:s.MOTOR_3D_CONFIG.neutral,unsyncedPWMSwitch:s.PID_ADVANCED_CONFIG.use_unsyncedPwm,unsyncedpwmfreq:s.PID_ADVANCED_CONFIG.motor_pwm_rate,minthrottle:s.MOTOR_CONFIG.minthrottle,maxthrottle:s.MOTOR_CONFIG.maxthrottle,mincommand:s.MOTOR_CONFIG.mincommand};u();function c(i){if(i.target!==i.currentTarget){const _=i.target.id===""?i.target.name:i.target.id;let l=i.target.type==="checkbox"?i.target.checked:i.target.value;switch(i.target.type){case"checkbox":_==="reverseMotorSwitch"&&(l=l===!1?0:1);break;case"number":l=ao(l)?parseInt(l):parseFloat(l);break;case"select-one":l=parseInt(l);break;default:console.log(`Undefined case ${i.target.type} encountered, please check code`)}t.configChanges[_]=l,_ in M?l!==M[_]?t.configHasChanged=!0:(delete t.configChanges[_],Object.keys(t.configChanges).length===0&&(console.log("All configuration changes reverted"),t.configHasChanged=!1)):(console.log(`Unknown item ${_} found with type ${i.target.type}, please add to the defaultConfiguration object.`),t.configHasChanged=!0),a.trigger("change"),u()}i.stopPropagation()}document.querySelector(".configuration").addEventListener("change",c);const p=e("select.mixerList");for(let i=0;i<$.length;i++)$.forEach(function(_,l){_.pos===i&&p.append(`<option value="${l+1}">${_.name.toUpperCase()}</option>`)});p.sortSelect();function A(){const i=St(s.MIXER_CONFIG.mixer,s.MIXER_CONFIG.reverseMotorDir);It(i)}const v=e("#reverseMotorSwitch");v.change(function(){s.MIXER_CONFIG.reverseMotorDir=e(this).prop("checked")?1:0,A()}),v.prop("checked",s.MIXER_CONFIG.reverseMotorDir!==0).change(),p.change(function(){const i=parseInt(e(this).val());let _;i!==s.MIXER_CONFIG.mixer&&(_=e(this).find("option:selected").text()),t.analyticsChanges.Mixer=_,s.MIXER_CONFIG.mixer=i,A()}),p.val(s.MIXER_CONFIG.mixer).change();function F(){g.promise(h.MSP_MOTOR).then(()=>{const i=s.MIXER_CONFIG.mixer,_=$[i-1].motors;t.numberOfValidOutputs=_;for(let l=0;l<s.MOTOR_DATA.length;l++)if(s.MOTOR_DATA[l]===0){if(t.numberOfValidOutputs=l,_>t.numberOfValidOutputs&&_>0){const S=O.getMessage("motorsDialogMixerReset",{mixerName:$[i-1].name,mixerMotors:_,outputs:t.numberOfValidOutputs});Ut(S)}return}})}Vt(s.MIXER_CONFIG.mixer);const U=9;s.PID_ADVANCED_CONFIG.fast_pwm_protocol!==U&&F(),f();let q=0;const nt=d(3);let at=Z("#graph",q,[-2,2]),tt=[0,0,0],J=0;const _t=d(3);let lt=Z("#graph",J,[-2,2]),ot=[0,0,0];const et=[0,0,0];let ct=!1;const $t=e(".motors-bat-voltage"),qt=e(".motors-bat-mah-drawing"),Jt=e(".motors-bat-mah-drawn"),k={x:[],y:[],z:[],rms:[]};e(".plot_control .x, .plot_control .y, .plot_control .z, .plot_control .rms").each(function(){const i=e(this);i.hasClass("x")?k.x.push(i):i.hasClass("y")?k.y.push(i):i.hasClass("z")?k.z.push(i):i.hasClass("rms")&&k.rms.push(i)});function Rt(i,_){e('.tab-motors select[name="scale"]').find("option").remove(),e.each(i,function(l,S){e('.tab-motors select[name="scale"]').append(new Option(l,S))}),e('.tab-motors select[name="scale"]').val(_)}function Et(i){e('.tab-motors select[name="rate"]').val(i)}e(".tab-motors .sensor select").change(function(){switch(D.motors.sensor=e('.tab-motors select[name="sensor_choice"]').val(),Tt({motors_tab_sensor_settings:{sensor:D.motors.sensor}}),D.motors.sensor){case"gyro":Rt(D.motors.sensorSelectValues.gyroScale,D.motors.sensorGyroScale),Et(D.motors.sensorGyroRate);break;case"accel":Rt(D.motors.sensorSelectValues.accelScale,D.motors.sensorAccelScale),Et(D.motors.sensorAccelRate);break}e(".tab-motors .rate select:first").change()}),e(".tab-motors .rate select, .tab-motors .scale select").change(function(){const i=parseInt(e('.tab-motors select[name="rate"]').val(),10),_=parseFloat(e('.tab-motors select[name="scale"]').val());switch(N.interval_kill_all(["motor_and_status_pull","motors_power_data_pull_slow"]),D.motors.sensor){case"gyro":Tt({motors_tab_gyro_settings:{rate:i,scale:_}}),D.motors.sensorGyroRate=i,D.motors.sensorGyroScale=_,at=Z("#graph",q,[-_,_]),N.interval_add("IMU_pull",function(){g.send_message(h.MSP_RAW_IMU,!1,!1,S)},i,!0);break;case"accel":Tt({motors_tab_accel_settings:{rate:i,scale:_}}),D.motors.sensorAccelRate=i,D.motors.sensorAccelScale=_,lt=Z("#graph",J,[-_,_]),N.interval_add("IMU_pull",function(){g.send_message(h.MSP_RAW_IMU,!1,!1,l)},i,!0);break}function l(){if(!ct){for(let m=0;m<3;m++)et[m]=s.SENSOR_DATA.accelerometer[m]*-1;ct=!0}const x=[et[0]+s.SENSOR_DATA.accelerometer[0],et[1]+s.SENSOR_DATA.accelerometer[1],et[2]+s.SENSOR_DATA.accelerometer[2]];rt(lt),J=E(_t,J,x),xt(lt,_t,J);for(let m=0;m<3;m++)Math.abs(x[m])>Math.abs(ot[m])&&(ot[m]=x[m]);w(x,_t,ot)}function S(){const x=[s.SENSOR_DATA.gyroscope[0],s.SENSOR_DATA.gyroscope[1],s.SENSOR_DATA.gyroscope[2]];rt(at),q=E(nt,q,x),xt(at,nt,q);for(let m=0;m<3;m++)Math.abs(x[m])>Math.abs(tt[m])&&(tt[m]=x[m]);w(x,nt,tt)}function w(x,m,V){let I=0;for(let y=0,ft=m.length;y<ft;y++)for(let Q=0,Dt=m[y].length;Q<Dt;Q++)I+=m[y][Q][1]*m[y][Q][1];const W=Math.sqrt(I/(m[0].length+m[1].length+m[2].length));k.x[0].text(`${x[0].toFixed(2)} ( ${V[0].toFixed(2)} )`),k.y[0].text(`${x[1].toFixed(2)} ( ${V[1].toFixed(2)} )`),k.z[0].text(`${x[2].toFixed(2)} ( ${V[2].toFixed(2)} )`),k.rms[0].text(W.toFixed(4))}});const B=io(["motors_tab_sensor_settings","motors_tab_gyro_settings","motors_tab_accel_settings"]);B.motors_tab_sensor_settings&&e('.tab-motors select[name="sensor_choice"]').val(B.motors_tab_sensor_settings.sensor),B.motors_tab_gyro_settings&&(D.motors.sensorGyroRate=B.motors_tab_gyro_settings.rate,D.motors.sensorGyroScale=B.motors_tab_gyro_settings.scale),B.motors_tab_accel_settings&&(D.motors.sensorAccelRate=B.motors_tab_accel_settings.rate,D.motors.sensorAccelScale=B.motors_tab_accel_settings.scale),e(".tab-motors .sensor select:first").change();function zt(){s.ANALOG.last_received_timestamp&&($t.text(O.getMessage("motorsVoltageValue",[s.ANALOG.voltage])),qt.text(O.getMessage("motorsADrawingValue",[s.ANALOG.amperage.toFixed(2)])),Jt.text(O.getMessage("motorsmAhDrawnValue",[s.ANALOG.mAhdrawn])))}N.interval_add("motors_power_data_pull_slow",zt,250,!0),e("a.reset_max").click(function(){tt=[0,0,0],ot=[0,0,0],ct=!1});let L,st,ht;t.escProtocolIsDshot?(L=t.DSHOT_DISARMED_VALUE,st=t.DSHOT_MAX_VALUE,ht=t.DSHOT_3D_NEUTRAL):(L=s.MOTOR_CONFIG.mincommand,st=s.MOTOR_CONFIG.maxthrottle,ht=s.MOTOR_3D_CONFIG.neutral>1575||s.MOTOR_3D_CONFIG.neutral<1425?1500:s.MOTOR_3D_CONFIG.neutral);let X=L;t.feature3DEnabled&&(X=ht);const dt=e(".motors .bar-wrapper");for(let i=0;i<8;i++)dt.append(`                <div class="m-block motor-${i}">                <div class="meter-bar">                <div class="label"></div>                <div class="indicator">                <div class="label">                <div class="label"></div>                </div>                </div>                </div>                </div>            `);e("div.sliders input").prop("min",L).prop("max",st),e("div.values li:not(:last)").text(L);const ut=e(".tab-motors .features");s.FEATURE_CONFIG.features.generateElements(ut);const vt=Pt.GetAvailableProtocols(s.CONFIG.apiVersion),z=e("select.escprotocol");for(let i=0;i<vt.length;i++)z.append(`<option value="${i+1}">${vt[i]}</option>`);z.sortSelect("DISABLED");const it=e("input[id='unsyncedPWMSwitch']"),mt=e("div.unsyncedpwmfreq");it.on("change",function(){e(this).is(":checked")?mt.show():mt.hide()});const K=e('input[id="dshotBidir"]');it.prop("checked",s.PID_ADVANCED_CONFIG.use_unsyncedPwm!==0).trigger("change"),e('input[name="unsyncedpwmfreq"]').val(s.PID_ADVANCED_CONFIG.motor_pwm_rate),e('input[name="digitalIdlePercent"]').val(s.PID_ADVANCED_CONFIG.digitalIdlePercent),e('input[name="idleMinRpm"]').val(s.ADVANCED_TUNING.idleMinRpm),K.prop("checked",s.MOTOR_CONFIG.use_dshot_telemetry).trigger("change"),t.previousDshotBidir=s.MOTOR_CONFIG.use_dshot_telemetry,t.previousFilterDynQ=s.FILTER_CONFIG.dyn_notch_q,t.previousFilterDynCount=s.FILTER_CONFIG.dyn_notch_count,K.on("change",function(){const i=K.is(":checked"),_=i!==s.MOTOR_CONFIG.use_dshot_telemetry?"On":"Off";t.analyticsChanges.BidirectionalDshot=_,s.MOTOR_CONFIG.use_dshot_telemetry=i;const l=s.FILTER_CONFIG.gyro_rpm_notch_harmonics===0;s.FILTER_CONFIG.dyn_notch_count=t.previousFilterDynCount,s.FILTER_CONFIG.dyn_notch_q=t.previousFilterDynQ;const S={title:O.getMessage("dialogDynFiltersChangeTitle"),text:O.getMessage("dialogDynFiltersChangeNote"),buttonYesText:O.getMessage("presetsWarningDialogYesButton"),buttonNoText:O.getMessage("presetsWarningDialogNoButton"),buttonYesCallback:()=>w(),buttonNoCallback:null},w=function(){s.MOTOR_CONFIG.use_dshot_telemetry&&!t.previousDshotBidir?(s.FILTER_CONFIG.dyn_notch_count=o.dyn_notch_count_rpm,s.FILTER_CONFIG.dyn_notch_q=o.dyn_notch_q_rpm):!s.MOTOR_CONFIG.use_dshot_telemetry&&t.previousDshotBidir&&(s.FILTER_CONFIG.dyn_notch_count=o.dyn_notch_count,s.FILTER_CONFIG.dyn_notch_q=o.dyn_notch_q)};s.MOTOR_CONFIG.use_dshot_telemetry!==t.previousDshotBidir&&!l?N.showYesNoDialog(S):(s.FILTER_CONFIG.dyn_notch_count=t.previousFilterDynCount,s.FILTER_CONFIG.dyn_notch_q=t.previousFilterDynQ)}),e('input[name="motorPoles"]').val(s.MOTOR_CONFIG.motor_poles);function gt(){const i=e("select.escprotocol option:selected").text(),_=i!=="DISABLED";let l=!1;switch(i){case"DSHOT150":case"DSHOT300":case"DSHOT600":case"PROSHOT1000":l=!0;break}const S=l&&K.is(":checked")||e("input[name='ESC_SENSOR']").is(":checked");e("div.minthrottle").toggle(_&&!l),e("div.maxthrottle").toggle(_&&!l),e("div.mincommand").toggle(_&&!l),e("div.checkboxPwm").toggle(_&&!l),mt.toggle(_&&!l),e("div.digitalIdlePercent").toggle(_&&l),e("div.idleMinRpm").toggle(_&&l&&s.MOTOR_CONFIG.use_dshot_telemetry),s.ADVANCED_TUNING.idleMinRpm&&s.MOTOR_CONFIG.use_dshot_telemetry&&e("div.digitalIdlePercent").hide(),e(".escSensor").toggle(_&&l),e("div.checkboxDshotBidir").toggle(_&&l),e("div.motorPoles").toggle(_&&S),e(".escMotorStop").toggle(_),e("#escProtocolDisabled").toggle(!_),it.trigger("change")}z.val(s.PID_ADVANCED_CONFIG.fast_pwm_protocol+1),z.on("change",function(){const i=parseInt(e(this).val())-1;let _;i!==s.PID_ADVANCED_CONFIG.fast_pwm_protocol&&(_=e(this).find("option:selected").text()),t.analyticsChanges.EscProtocol=_,gt()}).trigger("change"),K.change(gt).trigger("change"),e("input[name='ESC_SENSOR']").on("change",gt).trigger("change"),e('input[name="minthrottle"]').val(s.MOTOR_CONFIG.minthrottle),e('input[name="maxthrottle"]').val(s.MOTOR_CONFIG.maxthrottle),e('input[name="mincommand"]').val(s.MOTOR_CONFIG.mincommand),e(".tab-motors ._3d").show(),e('input[name="_3ddeadbandlow"]').val(s.MOTOR_3D_CONFIG.deadband3d_low),e('input[name="_3ddeadbandhigh"]').val(s.MOTOR_3D_CONFIG.deadband3d_high),e('input[name="_3dneutral"]').val(s.MOTOR_3D_CONFIG.neutral);function yt(){s.FEATURE_CONFIG.features.isEnabled("3D")?e("._3dSettings").show():e("._3dSettings").hide()}e("input.feature",ut).on("change",function(){const i=e(this);switch(s.FEATURE_CONFIG.features.updateData(i),kt(s.FEATURE_CONFIG.features),i.attr("name")){case"MOTOR_STOP":break;case"3D":yt();break}}),e(ut).filter("select").change(function(){const i=e(this);s.FEATURE_CONFIG.features.updateData(i),kt(s.FEATURE_CONFIG.features)}),yt();function Nt(){e("div.sliders input").val(X)}function Kt(i){i&&!t.armed?(e("div.sliders input").slice(0,t.numberOfValidOutputs).prop("disabled",!1),e("div.sliders input:last").prop("disabled",!1)):(Nt(),e("div.sliders input").prop("disabled",!0)),e("div.sliders input").trigger("input")}Nt();const jt=["PageUp","PageDown","End","Home","ArrowUp","ArrowDown","AltLeft","AltRight"];a.on("change",function(){let i=a.is(":checked");if(t.configHasChanged){if(i){const l=O.getMessage("motorsDialogSettingsChanged");Xt(l),i=!1}a.prop("checked",!1)}function _(l){a.is(":checked")&&(jt.includes(l.code)||(a.prop("checked",!1).trigger("change"),document.removeEventListener("keydown",S=>_(S))))}if(i){const l=[];l.push8(R.dshotCommandType_e.DSHOT_CMD_TYPE_BLOCKING),l.push8(255),l.push8(1),l.push8(13),g.send_message(h.MSP2_SEND_DSHOT_COMMAND,l),document.addEventListener("keydown",S=>_(S))}u(i),Kt(i),e("div.sliders input").trigger("input"),b.setArmingEnabled(i,i)});let Mt=[],pt=!1;e("div.sliders input:not(.master)").on("input",function(){const i=e(this).index();let _=[];e("div.values li").eq(i).text(e(this).val());for(let l=0;l<t.numberOfValidOutputs;l++){const S=parseInt(e("div.sliders input").eq(l).val());_.push16(S)}Mt.push(_),pt||(pt=setTimeout(function(){_=Mt.pop(),g.send_message(h.MSP_SET_MOTOR,_),Mt=[],pt=!1},10))}),e("div.sliders input:not(.master)").on("input wheel",function(i){t.scrollSlider(e(this),i)}),e("div.sliders input.master").on("input",function(){const i=e(this).val();e("div.sliders input:not(:disabled, :last)").val(i),e("div.values li:not(:last)").slice(0,t.numberOfValidOutputs).text(i),e("div.sliders input:not(:last):first").trigger("input")}),e("div.sliders input.master").on("input wheel",function(i){t.scrollSlider(e(this),i)});let Ot=!1;for(let i=0;i<t.numberOfValidOutputs;i++)t.feature3DEnabled?(s.MOTOR_DATA[i]<s.MOTOR_3D_CONFIG.deadband3d_low||s.MOTOR_DATA[i]>s.MOTOR_3D_CONFIG.deadband3d_high)&&(Ot=!0):s.MOTOR_DATA[i]>X&&(Ot=!0);if(Ot){a.prop("checked",!0).trigger("change");const i=e("div.sliders input:not(.master)");let _=s.MOTOR_DATA[0];for(let l=0;l<s.MOTOR_DATA.length;l++)s.MOTOR_DATA[l]>0&&(i.eq(l).val(s.MOTOR_DATA[l]),_!==s.MOTOR_DATA[l]&&(_=!1));i.trigger("input"),_&&e("div.sliders input.master").val(_).trigger("input")}function Zt(){g.send_message(h.MSP_MOTOR,!1,!1,to)}function to(){s.MOTOR_CONFIG.use_dshot_telemetry||s.MOTOR_CONFIG.use_esc_sensor?g.send_message(h.MSP_MOTOR_TELEMETRY,!1,!1,bt):bt()}function oo(){const i=[],_=a.is(":checked");for(let l=0;l<t.numberOfValidOutputs;l++)i[l]=_?s.MOTOR_DATA[l]:X;return i}const At=st-L;function bt(){const i=t.armed,_=e("div.m-block:first").height(),l=oo(),S=6,w=100;let x=0,m=l.every((I,W,y)=>I===y[0]),V=!1;for(let I=0;I<l.length;I++){const W=l[I],y=W-L,ft=_-(y*(_/At)).clamp(0,_),Q=(y*(_/At)).clamp(0,_),Dt=parseInt(y*.009);if(e(`.motor-${I} .label`,dt).text(W),e(`.motor-${I} .indicator`,dt).css({"margin-top":`${ft}px`,height:`${Q}px`,"background-color":`rgba(255,187,0,1.${Dt})`}),I<s.MOTOR_CONFIG.motor_count&&(s.MOTOR_CONFIG.use_dshot_telemetry||s.MOTOR_CONFIG.use_esc_sensor)){let G=s.MOTOR_TELEMETRY_DATA.rpm[I];G>999999&&(G=`${(G/1e6).toFixed(5-(G/1e6).toFixed(0).toString().length)}M`),m&&(x+=Math.round(G*w)/w),G=G.toString().padStart(S);let Y=O.getMessage("motorsRPM",{motorsRpmValue:G});if(s.MOTOR_CONFIG.use_dshot_telemetry){let H=s.MOTOR_TELEMETRY_DATA.invalidPercent[I];V=H>100;let so=V?"warning":"";H=(H/100).toFixed(2).toString().padStart(S),Y+=`<br><span class="${so}">`,Y+=O.getMessage("motorsRPMError",{motorsErrorValue:H}),Y+="</span>"}if(s.MOTOR_CONFIG.use_dshot_telemetry||s.MOTOR_CONFIG.use_esc_sensor){let H=s.MOTOR_TELEMETRY_DATA.temperature[I];H=H.toString().padStart(S),Y+="<br>",Y+=O.getMessage("motorsESCTemperature",{motorsESCTempValue:H})}e(`.motor_testing .telemetry .motor-${I}`).html(Y)}}if(s.MOTOR_CONFIG.use_dshot_telemetry&&!V&&m){const I=(Math.round(x/l.length*w)/w).toFixed(0),W=I.toString().padStart(S),y=O.getMessage("motorsRPM",{motorsRpmValue:W});e(".motor_testing .telemetry .motor-master").html(y)}else e(".motor_testing .telemetry .motor-master").html("");n(),i!==t.armed&&(console.log("arm state change detected"),a.change())}e("a.save").on("click",async function(){N.interval_kill_all(["motor_and_status_pull","motors_power_data_pull_slow"]),s.MOTOR_CONFIG.minthrottle=parseInt(e('input[name="minthrottle"]').val()),s.MOTOR_CONFIG.maxthrottle=parseInt(e('input[name="maxthrottle"]').val()),s.MOTOR_CONFIG.mincommand=parseInt(e('input[name="mincommand"]').val()),s.MOTOR_CONFIG.motor_poles=parseInt(e('input[name="motorPoles"]').val()),s.MOTOR_3D_CONFIG.deadband3d_low=parseInt(e('input[name="_3ddeadbandlow"]').val()),s.MOTOR_3D_CONFIG.deadband3d_high=parseInt(e('input[name="_3ddeadbandhigh"]').val()),s.MOTOR_3D_CONFIG.neutral=parseInt(e('input[name="_3dneutral"]').val()),s.PID_ADVANCED_CONFIG.fast_pwm_protocol=parseInt(z.val()-1),s.PID_ADVANCED_CONFIG.use_unsyncedPwm=it.is(":checked")?1:0,s.PID_ADVANCED_CONFIG.motor_pwm_rate=parseInt(e('input[name="unsyncedpwmfreq"]').val()),s.PID_ADVANCED_CONFIG.digitalIdlePercent=parseFloat(e('input[name="digitalIdlePercent"]').val()),await g.promise(h.MSP_SET_FEATURE_CONFIG,b.crunch(h.MSP_SET_FEATURE_CONFIG)),await g.promise(h.MSP_SET_MIXER_CONFIG,b.crunch(h.MSP_SET_MIXER_CONFIG)),await g.promise(h.MSP_SET_MOTOR_CONFIG,b.crunch(h.MSP_SET_MOTOR_CONFIG)),await g.promise(h.MSP_SET_MOTOR_3D_CONFIG,b.crunch(h.MSP_SET_MOTOR_3D_CONFIG)),await g.promise(h.MSP_SET_ADVANCED_CONFIG,b.crunch(h.MSP_SET_ADVANCED_CONFIG)),await g.promise(h.MSP_SET_ARMING_CONFIG,b.crunch(h.MSP_SET_ARMING_CONFIG)),await g.promise(h.MSP_SET_FILTER_CONFIG,b.crunch(h.MSP_SET_FILTER_CONFIG)),wt.sendSaveAndChangeEvents(wt.EVENT_CATEGORIES.FLIGHT_CONTROLLER,t.analyticsChanges,"motors"),t.analyticsChanges={},t.configHasChanged=!1,b.writeConfiguration(!0)}),e("a.stop").on("click",()=>a.prop("checked",!1).trigger("change")),N.interval_add("motor_and_status_pull",Zt,50,!0),Qt(eo,X);function eo(){Yt(Ft,X)}function Ft(){N.content_ready(C)}Ft()}function Ut(a){const u=e("#dialog-mixer-reset")[0];e("#dialog-mixer-reset-content").html(a),u.hasAttribute("open")||(u.showModal(),e("#dialog-mixer-reset-confirmbtn").click(function(){u.close()}))}function Xt(a){const u=e("#dialog-settings-changed")[0];e("#dialog-settings-changed-content").html(a),u.hasAttribute("open")||(u.showModal(),e("#dialog-settings-reset-confirmbtn").click(function(){D.motors.refresh()}),e("#dialog-settings-changed-confirmbtn").click(function(){u.close()}))}function Qt(a,u){const M=e("#dialogMotorOutputReorder"),c=u+60,p=new uo(e("#dialogMotorOutputReorderContent"),a,$[s.MIXER_CONFIG.mixer-1].name,u,c);e("#dialogMotorOutputReorder-closebtn").click(A);function A(){M[0].close(),p.close(),e(document).off("keydown",v)}function v(F){F.which===27&&A()}e("#motorOutputReorderDialogOpen").click(function(){e(document).on("keydown",v),M[0].showModal()})}function Yt(a,u){const M=e("#escDshotDirectionDialog"),c=u+60,p={numberOfMotors:t.numberOfValidOutputs,motorStopValue:u,motorSpinValue:c,escProtocolIsDshot:t.escProtocolIsDshot},A=new T(e("#escDshotDirectionDialog-Content"),a,p);e("#escDshotDirectionDialog-closebtn").on("click",v);function v(){M[0].close(),A.close(),e(document).off("keydown",F)}function F(U){U.which===27&&v()}e("#escDshotDirectionDialog-Open").click(function(){e(document).on("keydown",F),M[0].showModal()}),a()}};j.refresh=function(C){const t=this;N.tab_switch_cleanup(function(){t.initialize(),C&&C()})};j.cleanup=function(C){C&&C()};j.scrollSlider=function(C,t){var d,E;if(C.prop("disabled")||!((d=t.originalEvent)!=null&&d.deltaY&&((E=t.originalEvent)!=null&&E.altKey)))return;t.preventDefault();const o=25,r=t.originalEvent.deltaY>0?-o:o,n=parseInt(C.val())+r,f=Math.round(n/o)*o;C.val(f),C.trigger("input")};D.motors=j;export{j as motors};
