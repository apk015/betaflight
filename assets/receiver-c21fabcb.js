import{G as I,M as l,$ as e,T as Oe,c as h,A as Ge,a as Pe,j as ae,b as se,D as Me,w as Xe,f as ie,d as L,t as re,C as Te}from"./DarkTheme-2fd54461.js";import{a as r,j as De,p as ke,F as t,q as $,s as D,n as oe,b as Be,t as ye,m as b}from"./main-ef562b84.js";import{R as Ue}from"./RateCurve-af4639be.js";import{s as Ve,l as ce,a as le,b as he,c as ze}from"./transform-8625d4bb.js";const w={rateChartHeight:117,analyticsChanges:{},needReboot:!1,elrsBindingPhraseEnabled:!1};w.initialize=function(d){const i=this;I.active_tab="receiver";function k(u){return(L("binding_phrase_map").binding_phrase_map||{})[u]??0}function B(u,p){const m=L("binding_phrase_map").binding_phrase_map??{};m[u]=p,ie({binding_phrase_map:m})}function fe(u){let p=[0,0,0,0,0,0];if(u){const m=`-DMY_BINDING_PHRASE="${u}"`,y=ye.MD5(m).toString().match(/.{1,2}/g).map(g=>parseInt(g,16)),N=new DataView(new ArrayBuffer(6));for(let g=0;g<6;g++)N.setUint8(g,y[g]);p=Array.from(new Uint8Array(N.buffer))}return p}function _e(){l.send_message(r.MSP_RC,!1,!1,ue)}function ue(){l.send_message(r.MSP_RSSI_CONFIG,!1,!1,me)}function me(){l.send_message(r.MSP_RC_TUNING,!1,!1,ge)}function ge(){l.send_message(r.MSP_RX_MAP,!1,!1,pe)}function pe(){l.send_message(r.MSP_RC_DEADBAND,!1,!1,Re)}function Re(){l.send_message(r.MSP_RX_CONFIG,!1,!1,Se)}function Se(){l.send_message(r.MSP_MIXER_CONFIG,!1,!1,ve)}function ve(){e("#content").load("./tabs/receiver.html",Ce)}l.send_message(r.MSP_FEATURE_CONFIG,!1,!1,_e);function Ce(){self.analyticsChanges={};const u=e(".tab-receiver .features");t.FEATURE_CONFIG.features.generateElements(u),h.localizePage(),e('.deadband input[name="yaw_deadband"]').val(t.RC_DEADBAND_CONFIG.yaw_deadband),e('.deadband input[name="deadband"]').val(t.RC_DEADBAND_CONFIG.deadband),e('.deadband input[name="3ddeadbandthrottle"]').val(t.RC_DEADBAND_CONFIG.deadband3d_throttle),e('.sticks input[name="stick_min"]').val(t.RX_CONFIG.stick_min),e('.sticks input[name="stick_center"]').val(t.RX_CONFIG.stick_center),e('.sticks input[name="stick_max"]').val(t.RX_CONFIG.stick_max);const p=[h.getMessage("controlAxisRoll"),h.getMessage("controlAxisPitch"),h.getMessage("controlAxisYaw"),h.getMessage("controlAxisThrottle")],m=e(".tab-receiver .bars");let H=1;const y=t.RC.active_channels>0?t.RC.active_channels:8;for(let n=0;n<y;n++){let a;n<p.length?a=p[n]:a=h.getMessage(`controlAxisAux${H++}`),m.append(`                <ul>                    <li class="name">${a}</li>                    <li class="meter">                        <div class="meter-bar">                            <div class="label"></div>                            <div class="fill${t.RC.active_channels===0?"disabled":""}">                                <div class="label"></div>                            </div>                        </div>                    </li>                </ul>            `)}const N={min:800,max:2200},g=[];e(".meter .fill",m).each(function(){g.push(e(this))});const P=[];e(".meter",m).each(function(){P.push(e(".label",this))}),i.resize=function(){const n=e(".meter:first",m).width(),a=e(".meter .label:first",m).width(),o=n/2-a/2;for(let c=0;c<P.length;c++)P[c].css("margin-left",o)},e(window).on("resize",i.resize).resize();let M=["A","E","R","T","1","2","3","4"],R=[];for(let n=0;n<t.RC_MAP.length;n++)R[t.RC_MAP[n]]=M[n];const Y=R.join("");e('input[name="rcmap"]').val(Y);const U=Y;e('input[name="rcmap"]').on("input",function(){let n=e(this).val();n.length>8&&(n=n.substr(0,8),e(this).val(n))}),e('input[name="rcmap"]').focusout(function(){const n=e(this).val();R=n.split("");const a=[];if(n.length!==8)return e(this).val(U),!1;for(let o=0;o<n.length;o++){if(M.indexOf(R[o])<0)return e(this).val(U),!1;if(a.indexOf(R[o])<0)a.push(R[o]);else return e(this).val(U),!1}}),e('select[name="rcmap_helper"]').val(0),e('select[name="rcmap_helper"]').change(function(){e('input[name="rcmap"]').val(e(this).val())});const K=e('select[name="rssi_channel"]');K.append(`<option value="0">${h.getMessage("receiverRssiChannelDisabledOption")}</option>`);for(let n=5;n<t.RC.active_channels+1;n++){const a=`controlAxisAux${n-4}`;K.append(`<option value="${n}">${h.getMessage(a)}</option>`)}e('select[name="rssi_channel"]').val(t.RSSI_CONFIG.channel);const A=e("select.serialRX");t.getSerialRxTypes().forEach((n,a)=>{A.append(`<option value="${a}">${n}</option>`)}),A.change(function(){const n=parseInt(e(this).val());let a;n!==t.RX_CONFIG.serialrx_provider&&(a=e(this).find("option:selected").text(),E(!0)),i.analyticsChanges.SerialRx=a,t.RX_CONFIG.serialrx_provider=n}),A.val(t.RX_CONFIG.serialrx_provider),D.gte(t.CONFIG.apiVersion,Ge)?A.sortSelect("NONE").select2():A.sortSelect().select2(),e(document).on("select2:open","select.serialRX",()=>{const n=document.querySelectorAll(".select2-container--open .select2-search__field");e(this).one("mouseup keyup",()=>{setTimeout(()=>{n[n.length-1].focus()},0)})});const W=["NRF24_V202_250K","NRF24_V202_1M","NRF24_SYMA_X","NRF24_SYMA_X5C","NRF24_CX10","CX10A","NRF24_H8_3D","NRF24_INAV","FRSKY_D","FRSKY_X","A7105_FLYSKY","A7105_FLYSKY_2A","NRF24_KN","SFHSS","SPEKTRUM","FRSKY_X_LBT","REDPINE","FRSKY_X_V2","FRSKY_X_LBT_V2","EXPRESSLRS"],X=e("select.spiRx");for(let n=0;n<W.length;n++)X.append(`<option value="${n}">${W[n]}</option>`);if(X.change(function(){const n=parseInt(e(this).val());let a;n!==t.RX_CONFIG.rxSpiProtocol&&(a=e(this).find("option:selected").text(),E(!0)),i.analyticsChanges.SPIRXProtocol=a,t.RX_CONFIG.rxSpiProtocol=n}),X.val(t.RX_CONFIG.rxSpiProtocol),X.sortSelect().select2(),e(document).on("select2:open","select.spiRx",()=>{const n=document.querySelectorAll(".select2-container--open .select2-search__field");e(this).one("mouseup keyup",()=>{setTimeout(()=>{n[n.length-1].focus()},0)})}),t.FEATURE_CONFIG.features.isEnabled("RX_SPI")&&t.RX_CONFIG.rxSpiProtocol==19&&D.gte(t.CONFIG.apiVersion,Pe)){i.elrsBindingPhraseEnabled=!0;const n=e("span.elrsUid"),a=t.RX_CONFIG.elrsUid.join(",");n.text(a);const o=e("input.elrsBindingPhrase"),c=k(a);c&&o.val(c),o.on("keyup",function(){const _=o.val();_?n.text(fe(_)):n.text("0.0.0.0.0.0"),E(!0)})}else i.elrsBindingPhraseEnabled=!1;i.elrsBindingPhraseEnabled&&D.gte(t.CONFIG.apiVersion,ae)?e('input[name="elrsModelId-number"]').val(t.RX_CONFIG.elrsModelId):e('input[name="elrsModelId-number"]').parent().hide();function E(n=!1){n&&(i.needReboot=!0),i.needReboot?(e(".update_btn").hide(),e(".save_btn").show()):(e(".update_btn").show(),e(".save_btn").hide())}e("input.feature",u).change(function(){const n=e(this);t.FEATURE_CONFIG.features.updateData(n),oe(t.FEATURE_CONFIG.features),(n.attr("name")==="RSSI_ADC"||n.attr("name")==="TELEMETRY")&&E(!0)});function j(){e("div.serialRXBox").toggle(t.FEATURE_CONFIG.features.isEnabled("RX_SERIAL"))}function q(){e("div.spiRxBox").toggle(t.FEATURE_CONFIG.features.isEnabled("RX_SPI"))}function J(){e("#elrsContainer").toggle(i.elrsBindingPhraseEnabled),e("input.elrsUid").toggle(i.elrsBindingPhraseEnabled)}e("#rxModeSelect").sortSelect(h.getMessage("featureNone")),e(u).filter("select").change(function(){const n=e(this);t.FEATURE_CONFIG.features.updateData(n),oe(t.FEATURE_CONFIG.features),n.attr("name")==="rxMode"&&(j(),q(),J(),E(!0))}),j(),q(),J(),E(),e("a.refresh").click(function(){i.refresh(function(){se(h.getMessage("receiverDataRefreshed"))})});function Q(n=!1){t.RX_CONFIG.stick_max=parseInt(e('.sticks input[name="stick_max"]').val()),t.RX_CONFIG.stick_center=parseInt(e('.sticks input[name="stick_center"]').val()),t.RX_CONFIG.stick_min=parseInt(e('.sticks input[name="stick_min"]').val()),t.RC_DEADBAND_CONFIG.yaw_deadband=parseInt(e('.deadband input[name="yaw_deadband"]').val()),t.RC_DEADBAND_CONFIG.deadband=parseInt(e('.deadband input[name="deadband"]').val()),t.RC_DEADBAND_CONFIG.deadband3d_throttle=e('.deadband input[name="3ddeadbandthrottle"]').val(),M=["A","E","R","T","1","2","3","4"],R=e('input[name="rcmap"]').val().split("");for(let f=0;f<t.RC_MAP.length;f++)t.RC_MAP[f]=R.indexOf(M[f]);if(t.RSSI_CONFIG.channel=parseInt(e('select[name="rssi_channel"]').val()),t.RX_CONFIG.rcSmoothingSetpointCutoff=parseInt(e('input[name="rcSmoothingSetpointHz-number"]').val()),t.RX_CONFIG.rcSmoothingFeedforwardCutoff=parseInt(e('input[name="rcSmoothingFeedforwardCutoff-number"]').val()),t.RX_CONFIG.rcSmoothingAutoFactor=parseInt(e('input[name="rcSmoothingAutoFactor-number"]').val()),i.elrsBindingPhraseEnabled){const f=e("span.elrsUid")[0].innerText.split(",").map(C=>parseInt(C,10));if(f.length===6){t.RX_CONFIG.elrsUid=f;const C=e("span.elrsUid")[0].innerText,F=e("input.elrsBindingPhrase").val();B(C,F)}else t.RX_CONFIG.elrsUid=[0,0,0,0,0,0];D.gte(t.CONFIG.apiVersion,ae)&&(t.RX_CONFIG.elrsModelId=parseInt(e('input[name="elrsModelId-number"]').val()))}function a(){l.send_message(r.MSP_SET_RSSI_CONFIG,b.crunch(r.MSP_SET_RSSI_CONFIG),!1,o)}function o(){l.send_message(r.MSP_SET_RC_DEADBAND,b.crunch(r.MSP_SET_RC_DEADBAND),!1,c)}function c(){const f=n?_:v;l.send_message(r.MSP_SET_RX_CONFIG,b.crunch(r.MSP_SET_RX_CONFIG),!1,f)}function _(){l.send_message(r.MSP_SET_FEATURE_CONFIG,b.crunch(r.MSP_SET_FEATURE_CONFIG),!1,v)}function v(){b.writeConfiguration(n)}re.sendSaveAndChangeEvents(re.EVENT_CATEGORIES.FLIGHT_CONTROLLER,i.analyticsChanges,"receiver"),i.analyticsChanges={},l.send_message(r.MSP_SET_RX_MAP,b.crunch(r.MSP_SET_RX_MAP),!1,a)}e("a.update").click(function(){Q(!1)}),e("a.save").click(function(){Q(!0),i.needReboot=!1}),e("a.sticks").on("click",function(){const o=function(_){return Te.connectionValid&&I.active_tab!=="cli"?(b.setRawRx(_),!0):!1},c=open("/receiver_msp/receiver_msp.html","receiver_msp",`location=no,width=370,height=${550+(window.screen.height-window.screen.availHeight)}`);c.setRawRx=o,Me.isDarkThemeEnabled(function(_){Xe.passValue(c,"darkTheme",_)})});let Z=!1;Z=Be(t.CONFIG.targetCapabilities,t.TARGET_CAPABILITIES_FLAGS.SUPPORTS_RX_BIND),e("a.bind").click(function(){l.send_message(r.MSP2_BETAFLIGHT_BIND),se(h.getMessage("receiverButtonBindMessage"))}),e(".bind_btn").toggle(Z);const Fe=t.RX_CONFIG.rcSmoothingMode;e(".tab-receiver .rcSmoothing").show();const ee=e('select[name="rcSmoothing-select"]');ee.change(function(){t.RX_CONFIG.rcSmoothingMode=parseFloat(e(this).val()),de()}),ee.val(Fe);const V=e('input[name="rcSmoothingSetpointHz-number"]'),z=e('input[name="rcSmoothingFeedforwardCutoff-number"]');V.val(t.RX_CONFIG.rcSmoothingSetpointCutoff),z.val(t.RX_CONFIG.rcSmoothingFeedforwardCutoff),e(".tab-receiver .rcSmoothing-setpoint-cutoff").show(),e('select[name="rcSmoothing-setpoint-manual-select"]').val("1"),t.RX_CONFIG.rcSmoothingSetpointCutoff===0&&(e(".tab-receiver .rcSmoothing-setpoint-cutoff").hide(),e('select[name="rcSmoothing-setpoint-manual-select"]').val("0")),e('select[name="rcSmoothing-setpoint-manual-select"]').change(function(){e(this).val()==="0"&&(V.val(0),e(".tab-receiver .rcSmoothing-setpoint-cutoff").hide()),e(this).val()==="1"&&(V.val(t.RX_CONFIG.rcSmoothingSetpointCutoff),e(".tab-receiver .rcSmoothing-setpoint-cutoff").show())}).change(),e(".tab-receiver .rcSmoothing-feedforward-cutoff").show(),e('select[name="rcSmoothing-feedforward-select"]').val("1"),t.RX_CONFIG.rcSmoothingFeedforwardCutoff===0&&(e('select[name="rcSmoothing-feedforward-select"]').val("0"),e(".tab-receiver .rcSmoothing-feedforward-cutoff").hide()),e('select[name="rcSmoothing-feedforward-select"]').change(function(){e(this).val()==="0"&&(e(".tab-receiver .rcSmoothing-feedforward-cutoff").hide(),z.val(0)),e(this).val()==="1"&&(e(".tab-receiver .rcSmoothing-feedforward-cutoff").show(),z.val(t.RX_CONFIG.rcSmoothingFeedforwardCutoff))}).change(),e('select[name="rcSmoothing-setpoint-manual-select"], select[name="rcSmoothing-feedforward-select"]').change(function(){e('select[name="rcSmoothing-setpoint-manual-select"]').val()==="0"||e('select[name="rcSmoothing-feedforward-select"]').val()==="0"?e(".tab-receiver .rcSmoothing-auto-factor").show():e(".tab-receiver .rcSmoothing-auto-factor").hide()}),e('select[name="rcSmoothing-setpoint-manual-select"]').change(),e('input[name="rcSmoothingAutoFactor-number"]').val(t.RX_CONFIG.rcSmoothingAutoFactor),e(".receiverRcSmoothingAutoFactorHelp").attr("title",h.getMessage("receiverRcSmoothingAutoFactorHelp2")),de(),e(".sticks_btn").toggle(t.FEATURE_CONFIG.features.isEnabled("RX_MSP"));const S={ch1:[],ch2:[],ch3:[],ch4:[]};e(".plot_control .ch1, .plot_control .ch2, .plot_control .ch3, .plot_control .ch4").each(function(){const n=e(this);n.hasClass("ch1")?S.ch1.push(n):n.hasClass("ch2")?S.ch2.push(n):n.hasClass("ch3")?S.ch3.push(n):n.hasClass("ch4")&&S.ch4.push(n)});let x;const T=e('select[name="rx_refresh_rate"]');e("a.reset_rate").click(function(){x=50,T.val(x).change()}),T.change(function(){x=parseInt(e(this).val(),10),ie({rx_refresh_rate:x});function n(){l.send_message(r.MSP_RC,!1,!1,Ie)}const a=new Array(t.RC.active_channels);for(let G=0;G<a.length;G++)a[G]=[];let o=0;const c=Ve("svg"),_=e("#RX_plot"),v={top:20,right:0,bottom:10,left:40};let f,C,F,O;function be(){f=_.width()-v.left-v.right,C=_.height()-v.top-v.bottom,F.range([0,f]),O.range([C,0])}function Ie(){if(t.RC.active_channels>0){for(let s=0;s<t.RC.active_channels;s++)g[s].css("width",`${((t.RC.channels[s]-N.min)/(N.max-N.min)*100).clamp(0,100)}%`),P[s].text(t.RC.channels[s]);S.ch1[0].text(t.RC.channels[0]),S.ch2[0].text(t.RC.channels[1]),S.ch3[0].text(t.RC.channels[2]),S.ch4[0].text(t.RC.channels[3]);for(let s=0;s<t.RC.active_channels;s++)a[s].push([o,t.RC.channels[s]]);for(;a[0].length>300;)for(let s=0;s<a.length;s++)a[s].shift()}F=ce().domain([o-299,o]),O=ce().domain([800,2200]),be();const G=le().scale(F).tickSize(-C).tickFormat(""),we=he().scale(O).tickSize(-f).tickFormat(""),Ne=le().scale(F).tickFormat(function(s){return s}),Ee=he().scale(O).tickFormat(function(s){return s}),Ae=ze().x(function(s){return F(s[0])}).y(function(s){return O(s[1])});c.select(".x.grid").call(G),c.select(".y.grid").call(we),c.select(".x.axis").call(Ne),c.select(".y.axis").call(Ee);const ne=c.select("g.data").selectAll("path").data(a,function(s,xe){return xe});ne.enter().append("path").attr("class","line"),ne.attr("d",Ae),o++}I.interval_remove("receiver_pull"),I.interval_add("receiver_pull",n,x,!0)});const te=L("rx_refresh_rate");te.rxRefreshRate?T.val(te.rxRefreshRate).change():T.change(),i.initModelPreview(),i.renderModel(),I.interval_add("receiver_pull_for_model_preview",i.getReceiverData,33,!1),I.content_ready(d)}};w.getReceiverData=function(){l.send_message(r.MSP_RC,!1,!1)};w.initModelPreview=function(){this.keepRendering=!0,this.model=new De(e(".model_preview"),e(".model_preview canvas")),this.rateCurve=new Ue(!1),this.currentRates=this.rateCurve.getCurrentRates(),e(window).on("resize",e.bind(this.model.resize,this.model))};w.renderModel=function(){if(this.keepRendering&&(requestAnimationFrame(this.renderModel.bind(this)),this.clock||(this.clock=new ke),t.RC.channels[0]&&t.RC.channels[1]&&t.RC.channels[2])){const d=this.clock.getDelta(),i=d*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[0],this.currentRates.roll_rate,this.currentRates.rc_rate,this.currentRates.rc_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.roll_rate_limit),k=d*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[1],this.currentRates.pitch_rate,this.currentRates.rc_rate_pitch,this.currentRates.rc_pitch_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.pitch_rate_limit),B=d*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[2],this.currentRates.yaw_rate,this.currentRates.rc_rate_yaw,this.currentRates.rc_yaw_expo,this.currentRates.superexpo,this.currentRates.yawDeadband,this.currentRates.yaw_rate_limit);this.model.rotateBy(-$(k),-$(B),-$(i))}};w.cleanup=function(d){this.keepRendering=!1,e(window).off("resize",this.resize),this.model&&(e(window).off("resize",e.proxy(this.model.resize,this.model)),this.model.dispose()),d&&d()};w.refresh=function(d){const i=this;I.tab_switch_cleanup(function(){i.initialize(),d&&d()})};function de(){const d=t.RX_CONFIG.rcSmoothingMode;e(".tab-receiver .rcSmoothing-feedforward-cutoff").show(),e(".tab-receiver .rcSmoothing-setpoint-cutoff").show(),e(".tab-receiver .rcSmoothing-feedforward-manual").show(),e(".tab-receiver .rcSmoothing-setpoint-manual").show(),(t.RX_CONFIG.rcSmoothingFeedforwardCutoff===0||t.RX_CONFIG.rcSmoothingSetpointCutoff===0)&&e(".tab-receiver .rcSmoothing-auto-factor").show(),e(".tab-receiver .rcSmoothingOff").text(h.getMessage("off")),e(".tab-receiver .rcSmoothingOn").text(h.getMessage("on")),d===0&&(e(".tab-receiver .rcSmoothing-feedforward-cutoff").hide(),e(".tab-receiver .rcSmoothing-setpoint-cutoff").hide(),e(".tab-receiver .rcSmoothing-feedforward-manual").hide(),e(".tab-receiver .rcSmoothing-setpoint-manual").hide(),e(".tab-receiver .rcSmoothing-auto-factor").hide()),t.RX_CONFIG.rcSmoothingFeedforwardCutoff===0&&e(".tab-receiver .rcSmoothing-feedforward-cutoff").hide(),t.RX_CONFIG.rcSmoothingSetpointCutoff===0&&e(".tab-receiver .rcSmoothing-setpoint-cutoff").hide()}Oe.receiver=w;export{w as receiver};
