import{$ as e,M as y,G as Ee,a as q,T as Ue,c as F,b as Se,t as Be}from"./DarkTheme-2fd54461.js";import{F as t,l as Ze,a as h,m as K,s as b,o as We,j as et,p as tt,q as Xe,k as it}from"./main-ef562b84.js";import{R as nt}from"./RateCurve-af4639be.js";const Qe={redWhiteGreen:[{percentage:-1,color:{r:255,g:0,b:0,a:1}},{percentage:0,color:{r:255,g:255,b:255,a:1}},{percentage:1,color:{r:0,g:255,b:0,a:1}}],pidSlider:[{percentage:-1,color:{r:197,g:197,b:197,a:1}},{percentage:0,color:{r:255,g:255,b:255,a:0}},{percentage:1,color:{r:255,g:84,b:14,a:1}}]};function rt(n,i=null){i=i||Qe.redWhiteGreen,n=Math.min(1,Math.max(-1,n));let o;for(o=1;o<i.length-1&&!(n<i[o].percentage);o++);const c=i[o-1],g=i[o],l=g.percentage-c.percentage,T=(n-c.percentage)/l,_=1-T,p=T,E={r:Math.floor(c.color.r*_+g.color.r*p),g:Math.floor(c.color.g*_+g.color.g*p),b:Math.floor(c.color.b*_+g.color.b*p),a:c.color.a*_+g.color.a*p};return`rgba(${[E.r,E.g,E.b,E.a].join(",")})`}const s={sliderPidsMode:2,sliderDGain:1,sliderPIGain:1,sliderFeedforwardGain:1,sliderDMaxGain:1,sliderIGain:1,sliderRollPitchRatio:1,sliderPitchPIGain:1,sliderMasterMultiplier:1,pidSlidersUnavailable:!1,GyroSliderUnavailable:!1,DTermSliderUnavailable:!1,sliderGyroFilter:1,sliderGyroFilterMultiplier:1,sliderDTermFilter:1,sliderDTermFilterMultiplier:1,dMinFeatureEnabled:!0,defaultPDRatio:0,PID_DEFAULT:[],FILTER_DEFAULT:{},SLIDER_DEFAULT:{},NON_EXPERT_SLIDER_MIN:70,NON_EXPERT_SLIDER_MAX:140,NON_EXPERT_SLIDER_MIN_GYRO:50,NON_EXPERT_SLIDER_MAX_GYRO:150,NON_EXPERT_SLIDER_MIN_DTERM:80,NON_EXPERT_SLIDER_MAX_DTERM:120,cachedPidSliderValues:!1,cachedGyroSliderValues:!1,cachedDTermSliderValues:!1,expertMode:!1};s.initialize=function(){this.PID_DEFAULT=t.getPidDefaults(),this.FILTER_DEFAULT=t.getFilterDefaults(),this.SLIDER_DEFAULT=t.getSliderDefaults(),this.setExpertMode(Ze()),this.cachedPidSliderValues=!1,this.cachedGyroSliderValues=!1,this.cachedDTermSliderValues=!1,this.initPidSlidersPosition(),this.initGyroFilterSliderPosition(),this.initDTermFilterSliderPosition(),this.validateTuningSliders(),this.updatePidSlidersDisplay(),this.updateGyroFilterSliderDisplay(),this.updateDTermFilterSliderDisplay(),this.updateFilterSlidersWarning(),e(".subtab-pid .slidersDisabled").hide(),e(".subtab-filter .slidersDisabled").hide()};s.updateExpertModePidSlidersDisplay=function(){const n=t.TUNING_SLIDERS.slider_d_gain<this.NON_EXPERT_SLIDER_MIN||t.TUNING_SLIDERS.slider_d_gain>this.NON_EXPERT_SLIDER_MAX,i=t.TUNING_SLIDERS.slider_pi_gain<this.NON_EXPERT_SLIDER_MIN||t.TUNING_SLIDERS.slider_pi_gain>this.NON_EXPERT_SLIDER_MAX,o=t.TUNING_SLIDERS.slider_feedforward_gain<this.NON_EXPERT_SLIDER_MIN||t.TUNING_SLIDERS.slider_feedforward_gain>this.NON_EXPERT_SLIDER_MAX,c=t.TUNING_SLIDERS.slider_dmax_gain!==t.DEFAULT_TUNING_SLIDERS.slider_dmax_gain,g=t.TUNING_SLIDERS.slider_i_gain!==t.DEFAULT_TUNING_SLIDERS.slider_i_gain,l=t.TUNING_SLIDERS.slider_roll_pitch_ratio!==t.DEFAULT_TUNING_SLIDERS.slider_roll_pitch_ratio,T=t.TUNING_SLIDERS.slider_pitch_pi_gain!==t.DEFAULT_TUNING_SLIDERS.slider_pitch_pi_gain,_=t.TUNING_SLIDERS.slider_master_multiplier!==t.DEFAULT_TUNING_SLIDERS.slider_master_multiplier,p=n||i||o,E=c||g||l||T||_;e(".baseSliderDGain").toggleClass("disabledSliders",!this.sliderPidsMode||n&&!this.expertMode),e(".baseSliderPIGain").toggleClass("disabledSliders",!this.sliderPidsMode||i&&!this.expertMode),e(".baseSliderFeedforwardGain").toggleClass("disabledSliders",!this.sliderPidsMode||o&&!this.expertMode),e(".advancedSlider").toggleClass("disabledSliders",!this.sliderPidsMode||!this.expertMode),e(".advancedSliderDmaxGain").toggle(c||this.expertMode),e(".advancedSliderIGain").toggle(g||this.expertMode),e(".advancedSliderRollPitchRatio").toggle(l||this.expertMode),e(".advancedSliderPitchPIGain").toggle(T||this.expertMode),e(".advancedSliderMaster").toggle(_||this.expertMode),e("#sliderDGain").prop("disabled",!this.sliderPidsMode||n&&!this.expertMode),e("#sliderPIGain").prop("disabled",!this.sliderPidsMode||i&&!this.expertMode),e("#sliderFeedforwardGain").prop("disabled",!this.sliderPidsMode||o&&!this.expertMode),e("#sliderDMaxGain").prop("disabled",!this.sliderPidsMode||c&&!this.expertMode),e("#sliderIGain").prop("disabled",!this.sliderPidsMode||g&&!this.expertMode),e("#sliderRollPitchRatio").prop("disabled",!this.sliderPidsMode||l&&!this.expertMode),e("#sliderPitchPIGain").prop("disabled",!this.sliderPidsMode||T&&!this.expertMode),e("#sliderMasterMultiplier").prop("disabled",!this.sliderPidsMode||_&&!this.expertMode),e(".subtab-pid .expertSettingsDetectedNote").toggle(!this.sliderPidsMode||(p||E)&&!this.expertMode)};s.updateExpertModeFilterSlidersDisplay=function(){const n=(t.TUNING_SLIDERS.slider_gyro_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_GYRO||t.TUNING_SLIDERS.slider_gyro_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_GYRO)&&!this.expertMode,i=(t.TUNING_SLIDERS.slider_dterm_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_DTERM||t.TUNING_SLIDERS.slider_dterm_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_DTERM)&&!this.expertMode,o=e('.pid_filter input[name="gyroLowpassDynMinFrequency"]'),c=e('.pid_filter input[name="gyroLowpassFrequency"]'),g=e('.pid_filter input[name="gyroLowpass2Frequency"]'),l=e('.pid_filter input[name="dtermLowpassDynMinFrequency"]'),T=e('.pid_filter input[name="dtermLowpassFrequency"]'),_=e('.pid_filter input[name="dtermLowpass2Frequency"]'),p=parseInt(o.val())===0&&parseInt(c.val())===0&&parseInt(g.val())===0,E=parseInt(l.val())===0&&parseInt(T.val())===0&&parseInt(_.val())===0,A=!this.sliderGyroFilter||n||p,G=!this.sliderDTermFilter||i||E;e(".sliderGyroFilter").toggleClass("disabledSliders",A),e(".sliderDTermFilter").toggleClass("disabledSliders",G),e("#sliderGyroFilterMultiplier").prop("disabled",A),e("#sliderDTermFilterMultiplier").prop("disabled",G),e(".subtab-filter .expertSettingsDetectedNote").toggle(n||i)};s.setExpertMode=function(n){this.expertMode=n,this.updateExpertModePidSlidersDisplay(),this.updateExpertModeFilterSlidersDisplay(),e(".tab-pid_tuning .legacySlider").hide(),e(".legacyNonExpertModeSlidersNote").hide(),e(".subtab-pid .nonExpertModeSlidersNote").toggle(!this.pidSlidersUnavailable&&!this.expertMode),e(".subtab-filter .nonExpertModeSlidersNote").toggle((!this.GyroSliderUnavailable||!this.DTermSliderUnavailable)&&!this.expertMode)};s.scaleSliderValue=function(n){return n>1?Math.round(((n-1)*2+1)*10)/10:n};s.downscaleSliderValue=function(n){return n>1?(n-1)/2+1:n};s.initPidSlidersPosition=function(){this.sliderPidsMode=t.TUNING_SLIDERS.slider_pids_mode,this.sliderDGain=t.TUNING_SLIDERS.slider_d_gain/100,this.sliderPIGain=t.TUNING_SLIDERS.slider_pi_gain/100,this.sliderFeedforwardGain=t.TUNING_SLIDERS.slider_feedforward_gain/100,this.sliderDMaxGain=t.TUNING_SLIDERS.slider_dmax_gain/100,this.sliderIGain=t.TUNING_SLIDERS.slider_i_gain/100,this.sliderRollPitchRatio=t.TUNING_SLIDERS.slider_roll_pitch_ratio/100,this.sliderPitchPIGain=t.TUNING_SLIDERS.slider_pitch_pi_gain/100,this.sliderMasterMultiplier=t.TUNING_SLIDERS.slider_master_multiplier/100,e('output[name="sliderDGain-number"]').val(this.sliderDGain),e('output[name="sliderPIGain-number"]').val(this.sliderPIGain),e('output[name="sliderFeedforwardGain-number"]').val(this.sliderFeedforwardGain),e('output[name="sliderDMaxGain-number"]').val(this.sliderDMaxGain),e('output[name="sliderIGain-number"]').val(this.sliderIGain),e('output[name="sliderRollPitchRatio-number"]').val(this.sliderRollPitchRatio),e('output[name="sliderPitchPIGain-number"]').val(this.sliderPitchPIGain),e('output[name="sliderMasterMultiplier-number"]').val(this.sliderMasterMultiplier),e("#sliderDGain").val(this.sliderDGain),e("#sliderPIGain").val(this.sliderPIGain),e("#sliderFeedforwardGain").val(this.sliderFeedforwardGain),e("#sliderDMaxGain").val(this.sliderDMaxGain),e("#sliderIGain").val(this.sliderIGain),e("#sliderRollPitchRatio").val(this.sliderRollPitchRatio),e("#sliderPitchPIGain").val(this.sliderPitchPIGain),e("#sliderMasterMultiplier").val(this.sliderMasterMultiplier)};s.initGyroFilterSliderPosition=function(){this.sliderGyroFilter=t.TUNING_SLIDERS.slider_gyro_filter,this.sliderGyroFilterMultiplier=t.TUNING_SLIDERS.slider_gyro_filter_multiplier/100,e("#sliderGyroFilterMultiplier").val(this.sliderGyroFilterMultiplier),e('output[name="sliderGyroFilterMultiplier-number"]').val(this.sliderGyroFilterMultiplier)};s.initDTermFilterSliderPosition=function(){this.sliderDTermFilter=t.TUNING_SLIDERS.slider_dterm_filter,this.sliderDTermFilterMultiplier=t.TUNING_SLIDERS.slider_dterm_filter_multiplier/100,e("#sliderDTermFilterMultiplier").val(this.sliderDTermFilterMultiplier),e('output[name="sliderDTermFilterMultiplier-number"]').val(this.sliderDTermFilterMultiplier)};s.gyroFilterSliderEnable=function(){this.sliderGyroFilter=1,this.calculateNewGyroFilters()};s.dtermFilterSliderEnable=function(){this.sliderDTermFilter=1,this.calculateNewDTermFilters()};s.gyroFilterSliderDisable=function(){t.TUNING_SLIDERS.slider_gyro_filter=0,this.updateGyroFilterSliderDisplay()};s.dtermFilterSliderDisable=function(){t.TUNING_SLIDERS.slider_dterm_filter=0,this.updateDTermFilterSliderDisplay()};s.updateSlidersWarning=function(n=!1){const c=2.5*t.PIDS[0][0],g=42,l=t.PIDS[0][0]>70||t.PIDS[0][1]>c||t.PIDS[0][2]>60||t.ADVANCED_TUNING.dMinRoll>g;e(".subtab-pid .slidersWarning").toggle(l&&!n)};s.updateFilterSlidersWarning=function(){e(".subtab-filter .slidersWarning").toggle(this.sliderGyroFilterMultiplier>=1.55||this.sliderGyroFilterMultiplier<=.45||this.sliderDTermFilterMultiplier>=1.25||this.sliderDTermFilterMultiplier<=.75)};s.updatePidSlidersDisplay=function(){e("#pid_main .ROLL .pid_data input, #pid_main .PITCH .pid_data input").each((n,i)=>e(i).prop("disabled",this.sliderPidsMode>0)),e("#pid_main .YAW .pid_data input").each((n,i)=>e(i).prop("disabled",this.sliderPidsMode===2)),this.updateExpertModePidSlidersDisplay(),e("#sliderPidsModeSelect").val(this.sliderPidsMode),this.updateSlidersWarning(this.pidSlidersUnavailable)};s.updateGyroFilterSliderDisplay=function(){const n=e('.pid_filter input[name="gyroLowpassDynMinFrequency"]'),i=e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]'),o=e('.pid_filter input[name="gyroLowpassFrequency"]'),c=e('.pid_filter input[name="gyroLowpass2Frequency"]'),g=(t.TUNING_SLIDERS.slider_gyro_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_GYRO||t.TUNING_SLIDERS.slider_gyro_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_GYRO)&&!this.expertMode;t.TUNING_SLIDERS.slider_gyro_filter===0?(this.GyroSliderUnavailable=!0,this.sliderGyroFilter=0):(this.GyroSliderUnavailable=!1,this.sliderGyroFilter=1,this.cachedGyroSliderValues=!0),n.val(t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz).prop("disabled",this.sliderGyroFilter),i.val(t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz).prop("disabled",this.sliderGyroFilter),o.val(t.FILTER_CONFIG.gyro_lowpass_hz).prop("disabled",this.sliderGyroFilter),c.val(t.FILTER_CONFIG.gyro_lowpass2_hz).prop("disabled",this.sliderGyroFilter),e('output[name="sliderGyroFilterMultiplier-number"]').val(this.sliderGyroFilterMultiplier);const T=t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz===0&&t.FILTER_CONFIG.gyro_lowpass_hz===0&&t.FILTER_CONFIG.gyro_lowpass2_hz===0||g||this.GyroSliderUnavailable;e('select[id="sliderGyroFilterModeSelect"]').val(this.sliderGyroFilter),e(".sliderGyroFilter").toggleClass("disabledSliders",T),e('input[id="sliderGyroFilterMultiplier"]').prop("disabled",T),this.updateFilterSlidersWarning()};s.updateDTermFilterSliderDisplay=function(){const n=e('.pid_filter input[name="dtermLowpassDynMinFrequency"]'),i=e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]'),o=e('.pid_filter input[name="dtermLowpassFrequency"]'),c=e('.pid_filter input[name="dtermLowpass2Frequency"]'),g=(t.TUNING_SLIDERS.slider_dterm_filter_multiplier<this.NON_EXPERT_SLIDER_MIN_DTERM||t.TUNING_SLIDERS.slider_dterm_filter_multiplier>this.NON_EXPERT_SLIDER_MAX_DTERM)&&!this.expertMode;t.TUNING_SLIDERS.slider_dterm_filter===0?(this.DTermSliderUnavailable=!0,this.sliderDTermFilter=0):(this.DTermSliderUnavailable=!1,this.sliderDTermFilter=1,this.cachedDTermSliderValues=!0),n.val(t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz).prop("disabled",this.sliderDTermFilter),i.val(t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz).prop("disabled",this.sliderDTermFilter),o.val(t.FILTER_CONFIG.dterm_lowpass_hz).prop("disabled",this.sliderDTermFilter),c.val(t.FILTER_CONFIG.dterm_lowpass2_hz).prop("disabled",this.sliderDTermFilter);const T=t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz===0&&t.FILTER_CONFIG.dterm_lowpass_hz===0&&t.FILTER_CONFIG.dterm_lowpass2_hz===0||g||this.DTermSliderUnavailable;e('output[name="sliderDTermFilterMultiplier-number"]').val(this.sliderDTermFilterMultiplier),e('select[id="sliderDTermFilterModeSelect"]').val(this.sliderDTermFilter),e(".sliderDTermFilter").toggleClass("disabledSliders",T),e('input[id="sliderDTermFilterMultiplier"]').prop("disabled",T),this.updateFilterSlidersWarning()};s.updateFilterSlidersDisplay=function(){this.updateGyroFilterSliderDisplay(),this.updateDTermFilterSliderDisplay(),e(".subtab-filter .nonExpertModeSlidersNote").toggle((!this.GyroSliderUnavailable||!this.DTermSliderUnavailable)&&!this.expertMode)};s.updateFormPids=function(n=!1){n||(t.PID_NAMES.forEach(function(i,o){e(`.pid_tuning .${i} input`).each(function(g){o<3&&g<3&&e(this).val(t.PIDS[o][g])})}),e('.pid_tuning input[name="dMinRoll"]').val(t.ADVANCED_TUNING.dMinRoll),e('.pid_tuning input[name="dMinPitch"]').val(t.ADVANCED_TUNING.dMinPitch),e('.pid_tuning input[name="dMinYaw"]').val(t.ADVANCED_TUNING.dMinYaw),e('.pid_tuning .ROLL input[name="f"]').val(t.ADVANCED_TUNING.feedforwardRoll),e('.pid_tuning .PITCH input[name="f"]').val(t.ADVANCED_TUNING.feedforwardPitch),e('.pid_tuning .YAW input[name="f"]').val(t.ADVANCED_TUNING.feedforwardYaw)),e('output[name="sliderDGain-number"]').val(this.sliderDGain),e('output[name="sliderPIGain-number"]').val(this.sliderPIGain),e('output[name="sliderFeedforwardGain-number"]').val(this.sliderFeedforwardGain),e('output[name="sliderDMaxGain-number"]').val(this.sliderDMaxGain),e('output[name="sliderIGain-number"]').val(this.sliderIGain),e('output[name="sliderRollPitchRatio-number"]').val(this.sliderRollPitchRatio),e('output[name="sliderPitchPIGain-number"]').val(this.sliderPitchPIGain),e('output[name="sliderMasterMultiplier-number"]').val(this.sliderMasterMultiplier),this.updateSlidersWarning()};s.calculateNewPids=function(n=!1){t.TUNING_SLIDERS.slider_pids_mode=this.sliderPidsMode,t.TUNING_SLIDERS.slider_d_gain=Math.round(this.sliderDGain*20)*5,t.TUNING_SLIDERS.slider_pi_gain=Math.round(this.sliderPIGain*20)*5,t.TUNING_SLIDERS.slider_feedforward_gain=Math.round(this.sliderFeedforwardGain*20)*5,t.TUNING_SLIDERS.slider_dmax_gain=Math.round(this.sliderDMaxGain*20)*5,t.TUNING_SLIDERS.slider_i_gain=Math.round(this.sliderIGain*20)*5,t.TUNING_SLIDERS.slider_roll_pitch_ratio=Math.round(this.sliderRollPitchRatio*20)*5,t.TUNING_SLIDERS.slider_pitch_pi_gain=Math.round(this.sliderPitchPIGain*20)*5,t.TUNING_SLIDERS.slider_master_multiplier=Math.round(this.sliderMasterMultiplier*20)*5,this.readSimplifiedPids()};s.calculateNewGyroFilters=function(){this.readSimplifiedGyroFilters()};s.calculateNewDTermFilters=function(){this.readSimplifiedDTermFilters()};s.readSimplifiedPids=function(n=!1){t.TUNING_SLIDERS.slider_pids_mode=this.sliderPidsMode,t.TUNING_SLIDERS.slider_master_multiplier=Math.round(this.sliderMasterMultiplier*100),t.TUNING_SLIDERS.slider_roll_pitch_ratio=Math.round(this.sliderRollPitchRatio*100),t.TUNING_SLIDERS.slider_i_gain=Math.round(this.sliderIGain*100),t.TUNING_SLIDERS.slider_d_gain=Math.round(this.sliderDGain*100),t.TUNING_SLIDERS.slider_pi_gain=Math.round(this.sliderPIGain*100),t.TUNING_SLIDERS.slider_dmax_gain=Math.round(this.sliderDMaxGain*100),t.TUNING_SLIDERS.slider_feedforward_gain=Math.round(this.sliderFeedforwardGain*100),t.TUNING_SLIDERS.slider_pitch_pi_gain=Math.round(this.sliderPitchPIGain*100),y.promise(h.MSP_CALCULATE_SIMPLIFIED_PID,K.crunch(h.MSP_CALCULATE_SIMPLIFIED_PID)).then(()=>this.updateFormPids(n))};s.readSimplifiedGyroFilters=function(){t.TUNING_SLIDERS.slider_gyro_filter=this.sliderGyroFilter,t.TUNING_SLIDERS.slider_gyro_filter_multiplier=this.sliderGyroFilterMultiplier*100,t.FILTER_CONFIG.gyro_lowpass_hz=parseInt(e('.pid_filter input[name="gyroLowpassFrequency"]').val()),t.FILTER_CONFIG.gyro_lowpass2_hz=parseInt(e('.pid_filter input[name="gyroLowpass2Frequency"]').val()),t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="gyroLowpassDynMinFrequency"]').val()),y.promise(h.MSP_CALCULATE_SIMPLIFIED_GYRO,K.crunch(h.MSP_CALCULATE_SIMPLIFIED_GYRO)).then(()=>this.updateGyroFilterSliderDisplay())};s.readSimplifiedDTermFilters=function(){t.TUNING_SLIDERS.slider_dterm_filter=this.sliderDTermFilter,t.TUNING_SLIDERS.slider_dterm_filter_multiplier=this.sliderDTermFilterMultiplier*100,t.FILTER_CONFIG.dterm_lowpass_hz=parseInt(e('.pid_filter input[name="dtermLowpassFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass2_hz=parseInt(e('.pid_filter input[name="dtermLowpass2Frequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="dtermLowpassDynMinFrequency"]').val()),y.promise(h.MSP_CALCULATE_SIMPLIFIED_DTERM,K.crunch(h.MSP_CALCULATE_SIMPLIFIED_DTERM)).then(()=>this.updateDTermFilterSliderDisplay())};s.validateTuningSliders=function(){y.promise(h.MSP_VALIDATE_SIMPLIFIED_TUNING).then(()=>{this.sliderPidsMode=t.TUNING_SLIDERS.slider_pids_valid>0?t.TUNING_SLIDERS.slider_pids_mode:0,this.sliderGyroFilter=t.TUNING_SLIDERS.slider_gyro_valid,this.sliderDTermFilter=t.TUNING_SLIDERS.slider_dterm_valid,t.TUNING_SLIDERS.slider_pids_mode=t.TUNING_SLIDERS.slider_pids_valid?t.TUNING_SLIDERS.slider_pids_mode:0,t.TUNING_SLIDERS.slider_gyro_filter=t.TUNING_SLIDERS.slider_gyro_valid?t.TUNING_SLIDERS.slider_gyro_filter:0,t.TUNING_SLIDERS.slider_dterm_filter=t.TUNING_SLIDERS.slider_dterm_valid?t.TUNING_SLIDERS.slider_dterm_filter:0,e("#sliderPidsModeSelect").val(this.sliderPidsMode),e("#sliderGyroFilterModeSelect").val(this.sliderGyroFilter),e("#sliderDTermFilterModeSelect").val(this.sliderDTermFilter),this.updatePidSlidersDisplay(),this.updateGyroFilterSliderDisplay(),this.updateDTermFilterSliderDisplay()})};const L={RATE_PROFILE_MASK:128,showAllPids:!1,updating:!0,dirty:!1,previousFilterDynQ:null,previousFilterDynCount:null,currentProfile:null,currentRateProfile:null,currentRatesType:null,previousRatesType:null,SETPOINT_WEIGHT_RANGE_LOW:2.55,SETPOINT_WEIGHT_RANGE_HIGH:20,SETPOINT_WEIGHT_RANGE_LEGACY:2.54,activeSubtab:"pid",analyticsChanges:{},CONFIGURATOR_PIDS:[],CONFIGURATOR_ADVANCED_TUNING:{},CONFIGURATOR_FILTER_CONFIG:{},CONFIGURATOR_RC_TUNING:{},CONFIGURATOR_FEATURE_CONFIG:{},CONFIGURATOR_TUNING_SLIDERS:{}};L.initialize=function(n){const i=this;Ee.active_tab!=="pid_tuning"&&(Ee.active_tab="pid_tuning",i.activeSubtab="pid");const o=t.getFilterDefaults();y.promise(h.MSP_PID_CONTROLLER).then(()=>y.promise(h.MSP_PIDNAMES)).then(()=>y.promise(h.MSP_PID)).then(()=>y.promise(h.MSP_PID_ADVANCED)).then(()=>y.promise(h.MSP_RC_TUNING)).then(()=>y.promise(h.MSP_FILTER_CONFIG)).then(()=>y.promise(h.MSP_RC_DEADBAND)).then(()=>y.promise(h.MSP_MOTOR_CONFIG)).then(()=>b.gte(t.CONFIG.apiVersion,q)?y.promise(h.MSP2_GET_TEXT,K.crunch(h.MSP2_GET_TEXT,h.PID_PROFILE_NAME)):!0).then(()=>b.gte(t.CONFIG.apiVersion,q)?y.promise(h.MSP2_GET_TEXT,K.crunch(h.MSP2_GET_TEXT,h.RATE_PROFILE_NAME)):!0).then(()=>y.promise(h.MSP_SIMPLIFIED_TUNING)).then(()=>y.promise(h.MSP_ADVANCED_CONFIG)).then(()=>y.send_message(h.MSP_MIXER_CONFIG,!1,!1,c));function c(){e("#content").load("./tabs/pid_tuning.html",ce)}const g=!1;function l(){i.setProfile(),i.setRateProfile(),b.gte(t.CONFIG.apiVersion,"1.45.0")?(e('input[name="pidProfileName"]').val(t.CONFIG.pidProfileNames[t.CONFIG.profile]),e('input[name="rateProfileName"]').val(t.CONFIG.rateProfileNames[t.CONFIG.rateProfile])):e(".profile_name").hide(),t.PID_NAMES.forEach(function(a,u){e(`.pid_tuning .${a} input`).each((X,P)=>{t.PIDS[u][X]!==void 0&&e(P).val(t.PIDS_ACTIVE[u][X])})}),e('.pid_tuning input[name="rc_rate"]').val(t.RC_TUNING.RC_RATE.toFixed(2)),e('.pid_tuning input[name="roll_pitch_rate"]').val(t.RC_TUNING.roll_pitch_rate.toFixed(2)),e('.pid_tuning input[name="roll_rate"]').val(t.RC_TUNING.roll_rate.toFixed(2)),e('.pid_tuning input[name="pitch_rate"]').val(t.RC_TUNING.pitch_rate.toFixed(2)),e('.pid_tuning input[name="yaw_rate"]').val(t.RC_TUNING.yaw_rate.toFixed(2)),e('.pid_tuning input[name="rc_expo"]').val(t.RC_TUNING.RC_EXPO.toFixed(2)),e('.pid_tuning input[name="rc_yaw_expo"]').val(t.RC_TUNING.RC_YAW_EXPO.toFixed(2)),e('.throttle input[name="mid"]').val(t.RC_TUNING.throttle_MID.toFixed(2)),e('.throttle input[name="expo"]').val(t.RC_TUNING.throttle_EXPO.toFixed(2)),b.gte(t.CONFIG.apiVersion,q)?(e('select[id="tpaMode"]').val(t.ADVANCED_TUNING.tpaMode),e('input[id="tpaRate"]').val(t.ADVANCED_TUNING.tpaRate*100),e('input[id="tpaBreakpoint"]').val(t.ADVANCED_TUNING.tpaBreakpoint)):(e('.tpa-old input[name="tpa"]').val(t.RC_TUNING.dynamic_THR_PID.toFixed(2)),e('.tpa-old input[name="tpa-breakpoint"]').val(t.RC_TUNING.dynamic_THR_breakpoint)),e(".vbatpidcompensation").toggle(g),e('input[id="vbatpidcompensation"]').prop("checked",t.ADVANCED_TUNING.vbatPidCompensation!==0),e("#pid-tuning .delta select").val(t.ADVANCED_TUNING.deltaMethod),e('.pid_tuning input[name="rc_rate_yaw"]').val(t.RC_TUNING.rcYawRate.toFixed(2)),e('.pid_filter input[name="gyroLowpassFrequency"]').val(t.FILTER_CONFIG.gyro_lowpass_hz),e('.pid_filter input[name="dtermLowpassFrequency"]').val(t.FILTER_CONFIG.dterm_lowpass_hz),e('.pid_filter input[name="yawLowpassFrequency"]').val(t.FILTER_CONFIG.yaw_lowpass_hz),e("#pid-tuning .rate").text(F.getMessage("pidTuningSuperRate")),e('.pid_filter input[name="gyroNotch1Frequency"]').val(t.FILTER_CONFIG.gyro_notch_hz),e('.pid_filter input[name="gyroNotch1Cutoff"]').val(t.FILTER_CONFIG.gyro_notch_cutoff),e('.pid_filter input[name="dTermNotchFrequency"]').val(t.FILTER_CONFIG.dterm_notch_hz),e('.pid_filter input[name="dTermNotchCutoff"]').val(t.FILTER_CONFIG.dterm_notch_cutoff),e('input[name="dtermSetpointTransition-number"]').val(t.ADVANCED_TUNING.dtermSetpointTransition/100),e('input[name="dtermSetpoint-number"]').val(t.ADVANCED_TUNING.dtermSetpointWeight/100),e('.pid_filter input[name="gyroNotch2Frequency"]').val(t.FILTER_CONFIG.gyro_notch2_hz),e('.pid_filter input[name="gyroNotch2Cutoff"]').val(t.FILTER_CONFIG.gyro_notch2_cutoff),e('.pid_tuning input[name="angleLimit"]').val(t.ADVANCED_TUNING.levelAngleLimit),e('.pid_tuning input[name="sensitivity"]').hide(),e(".pid_tuning .levelSensitivityHeader").empty();const m=e("#antiGravitySwitch"),N=e('.antigravity input[name="itermAcceleratorGain"]');e('.pid_filter select[name="dtermLowpassType"]').val(t.FILTER_CONFIG.dterm_lowpass_type);const I=0;b.gte(t.CONFIG.apiVersion,q)?(N.val(t.ADVANCED_TUNING.antiGravityGain/10),m.prop("checked",t.ADVANCED_TUNING.antiGravityGain!==I)):(e('.antigravity input[name="itermThrottleThreshold"]').val(t.ADVANCED_TUNING.itermThrottleThreshold),N.val(t.ADVANCED_TUNING.itermAcceleratorGain/1e3),m.prop("checked",t.ADVANCED_TUNING.itermAcceleratorGain!==I)),b.gte(t.CONFIG.apiVersion,q)&&N.attr({min:"0.1",max:"25.0",step:"0.1"}),m.on("change",function(){if(m.is(":checked")){if(b.gte(t.CONFIG.apiVersion,q))N.val(Number.parseFloat(t.ADVANCED_TUNING.antiGravityGain/10||8).toFixed(1));else if(t.ADVANCED_TUNING.itermAcceleratorGain===I)N.val(3.5);else{const u=t.ADVANCED_TUNING.itermAcceleratorGain/1e3;N.val(u)}e(".antigravity .suboption").show(),e(".antigravity .antiGravityThres").toggle(b.lt(t.CONFIG.apiVersion,q)&&t.ADVANCED_TUNING.itermAcceleratorGain===0),e(".antigravity .antiGravityMode").toggle(b.lt(t.CONFIG.apiVersion,q))}else b.gte(t.CONFIG.apiVersion,q)?N.val(I/1e3):(e('.antigravity select[id="antiGravityMode"]').val(0),N.val(I)),e(".antigravity .suboption").hide()}),m.trigger("change"),e('.pid_tuning input[name="rc_rate_pitch"]').val(t.RC_TUNING.rcPitchRate.toFixed(2)),e('.pid_tuning input[name="rc_pitch_expo"]').val(t.RC_TUNING.RC_PITCH_EXPO.toFixed(2)),e('.pid_filter input[name="gyroLowpass2Frequency"]').val(t.FILTER_CONFIG.gyro_lowpass2_hz),e('.pid_filter select[name="gyroLowpassType"]').val(t.FILTER_CONFIG.gyro_lowpass_type),e('.pid_filter select[name="gyroLowpass2Type"]').val(t.FILTER_CONFIG.gyro_lowpass2_type),e('.pid_filter input[name="dtermLowpass2Frequency"]').val(t.FILTER_CONFIG.dterm_lowpass2_hz),e('.pid_filter select[name="dtermLowpass2Type"]').val(t.FILTER_CONFIG.dterm_lowpass2_type),e('input[id="itermrotation"]').prop("checked",t.ADVANCED_TUNING.itermRotation!==0),e('input[id="smartfeedforward"]').prop("checked",t.ADVANCED_TUNING.smartFeedforward!==0);const C=e('input[id="itermrelax"]');if(C.prop("checked",t.ADVANCED_TUNING.itermRelax!==0),e('select[id="itermrelaxAxes"]').val(t.ADVANCED_TUNING.itermRelax>0?t.ADVANCED_TUNING.itermRelax:1),e('select[id="itermrelaxType"]').val(t.ADVANCED_TUNING.itermRelaxType),e('input[name="itermRelaxCutoff"]').val(t.ADVANCED_TUNING.itermRelaxCutoff),C.change(function(){e(this).is(":checked")?(e(".itermrelax .suboption").show(),e(".itermRelaxCutoff").show()):e(".itermrelax .suboption").hide()}),C.change(),e('input[name="absoluteControlGain-number"]').val(t.ADVANCED_TUNING.absoluteControlGain).trigger("input"),e('input[name="throttleBoost-number"]').val(t.ADVANCED_TUNING.throttleBoost).trigger("input"),e('input[name="acroTrainerAngleLimit-number"]').val(t.ADVANCED_TUNING.acroTrainerAngleLimit).trigger("input"),e('.pid_tuning .YAW input[name="d"]').val(t.PIDS[2][2]),e('.pid_tuning .ROLL input[name="f"]').val(t.ADVANCED_TUNING.feedforwardRoll),e('.pid_tuning .PITCH input[name="f"]').val(t.ADVANCED_TUNING.feedforwardPitch),e('.pid_tuning .YAW input[name="f"]').val(t.ADVANCED_TUNING.feedforwardYaw),e('input[name="feedforwardTransition-number"]').val(Number.parseFloat(t.ADVANCED_TUNING.feedforwardTransition/100).toFixed(2)),b.lt(t.CONFIG.apiVersion,q)){const a=e('.antigravity select[id="antiGravityMode"]');a.on("change",function(){const u=a.val();e(".antiGravityThres").toggle(u!==0)}),a.val(t.ADVANCED_TUNING.antiGravityMode).trigger("change")}e('select[id="throttleLimitType"]').val(t.RC_TUNING.throttleLimitType),e('.throttle_limit input[name="throttleLimitPercent"]').val(t.RC_TUNING.throttleLimitPercent),e('.pid_filter input[name="gyroLowpassDynMinFrequency"]').val(t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz),e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]').val(t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz),e('.pid_filter select[name="gyroLowpassDynType"]').val(t.FILTER_CONFIG.gyro_lowpass_type),e('.pid_filter input[name="dtermLowpassDynMinFrequency"]').val(t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz),e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]').val(t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz),e('.pid_filter select[name="dtermLowpassDynType"]').val(t.FILTER_CONFIG.dterm_lowpass_type),e('.pid_tuning input[name="dMinRoll"]').val(t.ADVANCED_TUNING.dMinRoll),e('.pid_tuning input[name="dMinPitch"]').val(t.ADVANCED_TUNING.dMinPitch),e('.pid_tuning input[name="dMinYaw"]').val(t.ADVANCED_TUNING.dMinYaw),e('.dminGroup input[name="dMinGain"]').val(t.ADVANCED_TUNING.dMinGain),e('.dminGroup input[name="dMinAdvance"]').val(t.ADVANCED_TUNING.dMinAdvance),e('input[id="useIntegratedYaw"]').prop("checked",t.ADVANCED_TUNING.useIntegratedYaw!==0),e(".smartfeedforward").hide();const V=t.CONFIG.sampleRateHz/t.PID_ADVANCED_CONFIG.pid_process_denom;let S=t.FEATURE_CONFIG.features.isEnabled("DYNAMIC_FILTER");S=S||t.FILTER_CONFIG.dyn_notch_count!==0,S=S&&V>=2e3;const j=e('.pid_filter select[name="dynamicNotchRange"]'),B=e('.pid_filter input[name="dynamicNotchWidthPercent"]'),U=e('.pid_filter input[name="dynamicNotchCount"]'),Q=e('.pid_filter input[name="dynamicNotchQ"]'),oe=e('.pid_filter input[name="dynamicNotchMinHz"]'),ee=e('.pid_filter input[name="dynamicNotchMaxHz"]');j.val(t.FILTER_CONFIG.dyn_notch_range),B.val(t.FILTER_CONFIG.dyn_notch_width_percent),U.val(t.FILTER_CONFIG.dyn_notch_count),Q.val(t.FILTER_CONFIG.dyn_notch_q),oe.val(t.FILTER_CONFIG.dyn_notch_min_hz),ee.val(t.FILTER_CONFIG.dyn_notch_max_hz),e('.pid_filter input[id="dynamicNotchEnabled"]').on("change",function(){const a=parseInt(U.val()),u=e(this).is(":checked");u&&!a&&U.val(o.dyn_notch_count),e(".dynamicNotch span.suboption").toggle(u),e(".dynamicNotchMaxHz").toggle(u),e(".dynamicNotchCount").toggle(u)}).prop("checked",S).trigger("change"),e(".rpmFilter").toggle(t.MOTOR_CONFIG.use_dshot_telemetry);const J=e('.pid_filter input[name="rpmFilterHarmonics"]'),M=e('.pid_filter input[name="rpmFilterMinHz"]');J.val(t.FILTER_CONFIG.gyro_rpm_notch_harmonics),M.val(t.FILTER_CONFIG.gyro_rpm_notch_min_hz),e(".pid_filter #rpmFilterEnabled").on("change",function(){const a=J.val(),u=e(this).is(":checked")&&a!==0;J.attr("disabled",!u),M.attr("disabled",!u),i.previousFilterDynQ=t.FILTER_CONFIG.dyn_notch_q,i.previousFilterDynCount=t.FILTER_CONFIG.dyn_notch_count,a==0&&J.val(o.gyro_rpm_notch_harmonics);const f={title:F.getMessage("dialogDynFiltersChangeTitle"),text:F.getMessage("dialogDynFiltersChangeNote"),buttonYesText:F.getMessage("presetsWarningDialogYesButton"),buttonNoText:F.getMessage("presetsWarningDialogNoButton"),buttonYesCallback:()=>X(),buttonNoCallback:null},X=function(){u?(U.val(o.dyn_notch_count_rpm),Q.val(o.dyn_notch_q_rpm)):(U.val(o.dyn_notch_count),Q.val(o.dyn_notch_q))};u!==(t.FILTER_CONFIG.gyro_rpm_notch_harmonics!==0)?Ee.showYesNoDialog(f):(U.val(i.previousFilterDynCount),Q.val(i.previousFilterDynQ)),e(".rpmFilter span.suboption").toggle(u)}).prop("checked",t.FILTER_CONFIG.gyro_rpm_notch_harmonics!==0).trigger("change"),b.gte(t.CONFIG.apiVersion,q)&&e('input[name="idleMinRpm-number"]').attr("max",200),e('.tab-pid_tuning input[name="motorLimit"]').val(t.ADVANCED_TUNING.motorOutputLimit),e('.tab-pid_tuning select[name="cellCount"]').val(t.ADVANCED_TUNING.autoProfileCellCount),e('input[name="idleMinRpm-number"]').val(t.ADVANCED_TUNING.idleMinRpm).prop("disabled",!t.MOTOR_CONFIG.use_dshot_telemetry),t.MOTOR_CONFIG.use_dshot_telemetry?e("span.pidTuningIdleMinRpmDisabled").text(F.getMessage("pidTuningIdleMinRpm")):e("span.pidTuningIdleMinRpmDisabled").text(F.getMessage("pidTuningIdleMinRpmDisabled"));const Y=e('select[id="ratesType"]'),$=[{name:"Betaflight"},{name:"Raceflight"},{name:"KISS"},{name:"Actual"},{name:"QuickRates"}];for(let a=0;a<$.length;a++)Y.append(`<option value="${a}">${$[a].name}</option>`);Y.sortSelect(),i.currentRatesType=t.RC_TUNING.rates_type,i.previousRatesType=null,Y.val(i.currentRatesType),i.changeRatesType(i.currentRatesType),e('.pid_filter input[name="dtermLowpassExpo"]').val(t.FILTER_CONFIG.dyn_lpf_curve_expo),e('select[id="feedforwardAveraging"]').val(t.ADVANCED_TUNING.feedforward_averaging),e('input[name="feedforwardSmoothFactor"]').val(t.ADVANCED_TUNING.feedforward_smooth_factor),e('input[name="feedforwardBoost"]').val(t.ADVANCED_TUNING.feedforward_boost),e('input[name="feedforwardMaxRateLimit"]').val(t.ADVANCED_TUNING.feedforward_max_rate_limit),e('input[name="feedforwardJitterFactor"]').val(t.ADVANCED_TUNING.feedforward_jitter_factor);const de=t.BATTERY_CONFIG.voltageMeterSource!==1,le=e('input[id="vbatSagCompensation"]').attr("disabled",de).change();le.prop("checked",t.ADVANCED_TUNING.vbat_sag_compensation!==0),e('input[name="vbatSagValue"]').val(t.ADVANCED_TUNING.vbat_sag_compensation>0?t.ADVANCED_TUNING.vbat_sag_compensation:100),le.change(function(){const a=e(this).is(":checked");e(".vbatSagCompensation .suboption").toggle(a)}).change();const re=e('input[id="thrustLinearization"]');re.prop("checked",t.ADVANCED_TUNING.thrustLinearization!==0),e('input[name="thrustLinearValue"]').val(t.ADVANCED_TUNING.thrustLinearization>0?t.ADVANCED_TUNING.thrustLinearization:20),re.change(function(){const a=e(this).is(":checked");e(".thrustLinearization .suboption").toggle(a)}).change(),e('input[id="useIntegratedYaw"]').change(function(){const a=e(this).is(":checked");e("#pidTuningIntegratedYawCaution").toggle(a)}).change();function te(a,u){const f=parseInt(a.val()),X=parseInt(u.val()),P=Math.min(Math.max(f,0),250);X>P&&u.val(P)}e('.pid_tuning .ROLL input[name="d"]').change(function(){const a=e('.pid_tuning input[name="dMinRoll"]');te(e(this),a)}).change(),e('.pid_tuning .PITCH input[name="d"]').change(function(){const a=e('.pid_tuning input[name="dMinPitch"]');te(e(this),a)}).change(),e('.pid_tuning .YAW input[name="d"]').change(function(){const a=e('.pid_tuning input[name="dMinYaw"]');te(e(this),a)}).change();function ue(a,u){const f=parseInt(u.val()),X=parseInt(a.val()),P=Math.min(Math.max(X,0),250);f<P&&u.val(P)}e('.pid_tuning input[name="dMinRoll"]').change(function(){const a=e('.pid_tuning .ROLL input[name="d"]');ue(e(this),a)}).change(),e('.pid_tuning input[name="dMinPitch"]').change(function(){const a=e('.pid_tuning .PITCH input[name="d"]');ue(e(this),a)}).change(),e('.pid_tuning input[name="dMinYaw"]').change(function(){const a=e('.pid_tuning .YAW input[name="d"]');ue(e(this),a)}).change(),e('.pid_tuning .ROLL input[name="d"]').change(function(){const a=e('.pid_tuning input[name="dMinRoll"]');te(e(this),a)}).change(),e('.pid_tuning .PITCH input[name="d"]').change(function(){const a=e('.pid_tuning input[name="dMinPitch"]');te(e(this),a)}).change(),e('.pid_tuning .YAW input[name="d"]').change(function(){const a=e('.pid_tuning input[name="dMinYaw"]');te(e(this),a)}).change(),e('input[id="gyroNotch1Enabled"]').change(function(){const a=e(this).is(":checked"),u=t.FILTER_CONFIG.gyro_notch_hz>0?t.FILTER_CONFIG.gyro_notch_hz:o.gyro_notch_hz;e('.pid_filter input[name="gyroNotch1Frequency"]').val(a?u:0).attr("disabled",!a).attr("min",a?1:0).change(),e('.pid_filter input[name="gyroNotch1Cutoff"]').attr("disabled",!a).change(),e(".gyroNotch1 span.suboption").toggle(a)}),e('input[id="gyroNotch2Enabled"]').change(function(){const a=e(this).is(":checked"),u=t.FILTER_CONFIG.gyro_notch2_hz>0?t.FILTER_CONFIG.gyro_notch2_hz:o.gyro_notch2_hz;e('.pid_filter input[name="gyroNotch2Frequency"]').val(a?u:0).attr("disabled",!a).attr("min",a?1:0).change(),e('.pid_filter input[name="gyroNotch2Cutoff"]').attr("disabled",!a).change(),e(".gyroNotch2 span.suboption").toggle(a)}),e('input[id="dtermNotchEnabled"]').change(function(){const a=e(this).is(":checked"),u=t.FILTER_CONFIG.dterm_notch_hz>0?t.FILTER_CONFIG.dterm_notch_hz:o.dterm_notch_hz;e('.pid_filter input[name="dTermNotchFrequency"]').val(a?u:0).attr("disabled",!a).attr("min",a?1:0).change(),e('.pid_filter input[name="dTermNotchCutoff"]').attr("disabled",!a).change(),e(".dtermNotch span.suboption").toggle(a)});const Ne=e('.pid_filter input[name="gyroLowpassDynMinFrequency"]'),Ie=e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]'),me=e('.pid_filter input[name="gyroLowpassFrequency"]'),Fe=e('.pid_filter input[name="gyroLowpass2Frequency"]'),Ge=e('.pid_filter input[id="gyroLowpassEnabled"]'),De=e('.pid_filter input[id="gyroLowpass2Enabled"]'),be=e(".gyroLowpass span.suboption"),Le=e(".gyroLowpass span.suboption.static"),Z=e(".gyroLowpass span.suboption.dynamic"),he=e(".gyroLowpass2 span.suboption"),ye=e('.pid_filter select[name="gyroLowpassFilterMode"]'),r=e('.pid_filter input[name="dtermLowpassDynMinFrequency"]'),d=e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]'),R=e('.pid_filter input[name="dtermLowpassFrequency"]'),O=e('.pid_filter input[name="dtermLowpass2Frequency"]'),ge=e('input[id="dtermLowpassEnabled"]'),Ce=e('input[id="dtermLowpass2Enabled"]'),Oe=e(".dtermLowpass span.suboption"),ze=e(".dtermLowpass span.suboption.static"),ke=e(".dtermLowpass span.suboption.dynamic"),se=e(".dtermLowpass2 span.suboption"),fe=e('.pid_filter select[name="dtermLowpassFilterMode"]');Ge.change(function(){const a=e(this).is(":checked");a?t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz>0||t.FILTER_CONFIG.gyro_lowpass_hz>0?ye.val(t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz>0?1:0).change():ye.val(1).change():(Ne.val(0),Ie.val(0),me.val(0),i.calculateNewGyroFilters()),be.toggle(a),Le.toggle(a&&t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz===0),Z.toggle(a&&t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz!==0)}),ye.change(function(){const a=parseInt(e(this).val()),u=t.FILTER_CONFIG.gyro_lowpass_hz>0?t.FILTER_CONFIG.gyro_lowpass_hz:o.gyro_lowpass_hz,f=t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz>0?t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz:o.gyro_lowpass_dyn_min_hz,X=t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz>0?t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz:o.gyro_lowpass_dyn_max_hz;me.val(a?0:u),Ne.val(a?f:0),Ie.val(a?X:0),i.calculateNewGyroFilters(),Le.toggle(!a),Z.toggle(!!a)}),De.change(function(){const a=e(this).is(":checked"),u=t.FILTER_CONFIG.gyro_lowpass2_hz>0?t.FILTER_CONFIG.gyro_lowpass2_hz:o.gyro_lowpass2_hz;Fe.val(a?u:0).attr("disabled",!a),i.calculateNewGyroFilters(),he.toggle(a),i.updateFilterWarning()}),ge.change(function(){const a=e(this).is(":checked");a?t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz>0||t.FILTER_CONFIG.dterm_lowpass_hz>0?fe.val(t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz>0?1:0).change():fe.val(1).change():(r.val(0),d.val(0),R.val(0),i.calculateNewDTermFilters()),Oe.toggle(a),ze.toggle(a&&t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz===0),ke.toggle(a&&t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz!==0)}),fe.change(function(){const a=parseInt(e(this).val()),u=t.FILTER_CONFIG.dterm_lowpass_hz>0?t.FILTER_CONFIG.dterm_lowpass_hz:o.dterm_lowpass_hz,f=t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz>0?t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz:o.dterm_lowpass_dyn_min_hz,X=t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz>0?t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz:o.dterm_lowpass_dyn_max_hz;R.val(a?0:u),r.val(a?f:0),d.val(a?X:0),i.calculateNewDTermFilters(),ze.toggle(!a),ke.toggle(!!a)}),Ce.change(function(){const a=e(this).is(":checked"),u=t.FILTER_CONFIG.dterm_lowpass2_hz>0?t.FILTER_CONFIG.dterm_lowpass2_hz:o.dterm_lowpass2_hz;O.val(a?u:0).attr("disabled",!a),i.calculateNewDTermFilters(),se.toggle(a),i.updateFilterWarning()}),e('input[id="yawLowpassEnabled"]').change(function(){const a=e(this).is(":checked"),u=t.FILTER_CONFIG.yaw_lowpass_hz>0?t.FILTER_CONFIG.yaw_lowpass_hz:o.yaw_lowpass_hz;e('.pid_filter input[name="yawLowpassFrequency"]').val(a?u:0).attr("disabled",!a),e(".yawLowpass span.suboption").toggle(a)});function Te(a,u){const f=parseInt(e(`.pid_filter input[name='${a}']`).val()),X=parseInt(e(`.pid_filter input[name='${u}']`).val()),P=f==0?0:f-1;e(`.pid_filter input[name='${u}']`).attr("max",P),X>=f&&e(`.pid_filter input[name='${u}']`).val(P)}e('input[name="gyroNotch1Frequency"]').change(function(){Te("gyroNotch1Frequency","gyroNotch1Cutoff")}).change(),e('input[name="gyroNotch2Frequency"]').change(function(){Te("gyroNotch2Frequency","gyroNotch2Cutoff")}).change(),e('input[name="dTermNotchFrequency"]').change(function(){Te("dTermNotchFrequency","dTermNotchCutoff")}).change(),e('input[id="gyroNotch1Enabled"]').prop("checked",t.FILTER_CONFIG.gyro_notch_hz!==0).change(),e('input[id="gyroNotch2Enabled"]').prop("checked",t.FILTER_CONFIG.gyro_notch2_hz!==0).change(),e('input[id="dtermNotchEnabled"]').prop("checked",t.FILTER_CONFIG.dterm_notch_hz!==0).change(),Ge.prop("checked",t.FILTER_CONFIG.gyro_lowpass_hz!==0||t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz!==0).change(),ge.prop("checked",t.FILTER_CONFIG.dterm_lowpass_hz!==0||t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz!==0).change(),De.prop("checked",t.FILTER_CONFIG.gyro_lowpass2_hz!==0).change(),Ce.prop("checked",t.FILTER_CONFIG.dterm_lowpass2_hz!==0).change(),e('input[id="yawLowpassEnabled"]').prop("checked",t.FILTER_CONFIG.yaw_lowpass_hz!==0).change(),i.updatePIDColors()}function T(){b.gte(t.CONFIG.apiVersion,"1.45.0")&&(t.CONFIG.pidProfileNames[t.CONFIG.profile]=e('input[name="pidProfileName"]').val().trim(),t.CONFIG.rateProfileNames[t.CONFIG.rateProfile]=e('input[name="rateProfileName"]').val().trim()),t.PID_NAMES.forEach(function(oe,ee){e(`.pid_tuning .${oe} input`).each(function(M){e(this).val()&&(t.PIDS[ee][M]=parseInt(e(this).val()))})});const m=e('.pid_tuning input[name="pitch_rate"]'),N=e('.pid_tuning input[name="roll_rate"]'),I=e('.pid_tuning input[name="yaw_rate"]'),C=e('.pid_tuning input[name="rc_rate_pitch"]'),w=e('.pid_tuning input[name="rc_rate"]'),D=e('.pid_tuning input[name="rc_rate_yaw"]'),x=e('.pid_tuning input[name="rc_pitch_expo"]'),v=e('.pid_tuning input[name="rc_expo"]'),V=e('.pid_tuning input[name="rc_yaw_expo"]');switch(t.RC_TUNING.roll_pitch_rate=parseFloat(e('.pid_tuning input[name="roll_pitch_rate"]').val()),t.RC_TUNING.RC_RATE=parseFloat(w.val()),t.RC_TUNING.roll_rate=parseFloat(N.val()),t.RC_TUNING.pitch_rate=parseFloat(m.val()),t.RC_TUNING.yaw_rate=parseFloat(I.val()),t.RC_TUNING.RC_EXPO=parseFloat(v.val()),t.RC_TUNING.RC_YAW_EXPO=parseFloat(V.val()),t.RC_TUNING.rcYawRate=parseFloat(D.val()),t.RC_TUNING.rcPitchRate=parseFloat(C.val()),t.RC_TUNING.RC_PITCH_EXPO=parseFloat(x.val()),i.currentRatesType){case t.RATES_TYPE.RACEFLIGHT:t.RC_TUNING.pitch_rate=parseFloat(m.val())/100,t.RC_TUNING.roll_rate=parseFloat(N.val())/100,t.RC_TUNING.yaw_rate=parseFloat(I.val())/100,t.RC_TUNING.rcPitchRate=parseFloat(C.val())/1e3,t.RC_TUNING.RC_RATE=parseFloat(w.val())/1e3,t.RC_TUNING.rcYawRate=parseFloat(D.val())/1e3,t.RC_TUNING.RC_PITCH_EXPO=parseFloat(x.val())/100,t.RC_TUNING.RC_EXPO=parseFloat(v.val())/100,t.RC_TUNING.RC_YAW_EXPO=parseFloat(V.val())/100;break;case t.RATES_TYPE.ACTUAL:t.RC_TUNING.pitch_rate=parseFloat(m.val())/1e3,t.RC_TUNING.roll_rate=parseFloat(N.val())/1e3,t.RC_TUNING.yaw_rate=parseFloat(I.val())/1e3,t.RC_TUNING.rcPitchRate=parseFloat(C.val())/1e3,t.RC_TUNING.RC_RATE=parseFloat(w.val())/1e3,t.RC_TUNING.rcYawRate=parseFloat(D.val())/1e3;break;case t.RATES_TYPE.QUICKRATES:t.RC_TUNING.pitch_rate=parseFloat(m.val())/1e3,t.RC_TUNING.roll_rate=parseFloat(N.val())/1e3,t.RC_TUNING.yaw_rate=parseFloat(I.val())/1e3;break}t.RC_TUNING.throttle_MID=parseFloat(e('.throttle input[name="mid"]').val()),t.RC_TUNING.throttle_EXPO=parseFloat(e('.throttle input[name="expo"]').val()),b.gte(t.CONFIG.apiVersion,q)?(t.ADVANCED_TUNING.tpaMode=e('select[id="tpaMode"]').val(),t.ADVANCED_TUNING.tpaRate=parseInt(e('input[id="tpaRate"]').val())/100,t.ADVANCED_TUNING.tpaBreakpoint=parseInt(e('input[id="tpaBreakpoint"]').val())):(t.RC_TUNING.dynamic_THR_PID=parseFloat(e('.tpa-old input[name="tpa"]').val()),t.RC_TUNING.dynamic_THR_breakpoint=parseInt(e('.tpa-old input[name="tpa-breakpoint"]').val())),t.FILTER_CONFIG.gyro_lowpass_hz=parseInt(e('.pid_filter input[name="gyroLowpassFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_hz=parseInt(e('.pid_filter input[name="dtermLowpassFrequency"]').val()),t.FILTER_CONFIG.yaw_lowpass_hz=parseInt(e('.pid_filter input[name="yawLowpassFrequency"]').val()),t.ADVANCED_TUNING.deltaMethod=e("#pid-tuning .delta select").val(),t.ADVANCED_TUNING.dtermSetpointTransition=parseInt(e('input[name="dtermSetpointTransition-number"]').val()*100),t.ADVANCED_TUNING.dtermSetpointWeight=parseInt(e('input[name="dtermSetpoint-number"]').val()*100),t.FILTER_CONFIG.gyro_notch_hz=parseInt(e('.pid_filter input[name="gyroNotch1Frequency"]').val()),t.FILTER_CONFIG.gyro_notch_cutoff=parseInt(e('.pid_filter input[name="gyroNotch1Cutoff"]').val()),t.FILTER_CONFIG.dterm_notch_hz=parseInt(e('.pid_filter input[name="dTermNotchFrequency"]').val()),t.FILTER_CONFIG.dterm_notch_cutoff=parseInt(e('.pid_filter input[name="dTermNotchCutoff"]').val()),t.FILTER_CONFIG.gyro_notch2_hz=parseInt(e('.pid_filter input[name="gyroNotch2Frequency"]').val()),t.FILTER_CONFIG.gyro_notch2_cutoff=parseInt(e('.pid_filter input[name="gyroNotch2Cutoff"]').val()),t.ADVANCED_TUNING.levelAngleLimit=parseInt(e('.pid_tuning input[name="angleLimit"]').val());const S=e('.antigravity input[name="itermAcceleratorGain"]');t.FILTER_CONFIG.dterm_lowpass_type=parseInt(e('.pid_filter select[name="dtermLowpassType"]').val()),b.gte(t.CONFIG.apiVersion,q)?t.ADVANCED_TUNING.antiGravityGain=parseInt(S.val()*10):(t.ADVANCED_TUNING.itermThrottleThreshold=parseInt(e('.antigravity input[name="itermThrottleThreshold"]').val()),t.ADVANCED_TUNING.itermAcceleratorGain=parseInt(S.val()*1e3)),t.FILTER_CONFIG.gyro_lowpass2_hz=parseInt(e('.pid_filter input[name="gyroLowpass2Frequency"]').val()),t.FILTER_CONFIG.gyro_lowpass_type=parseInt(e('.pid_filter select[name="gyroLowpassType"]').val()),t.FILTER_CONFIG.gyro_lowpass2_type=parseInt(e('.pid_filter select[name="gyroLowpass2Type"]').val()),t.FILTER_CONFIG.dterm_lowpass2_hz=parseInt(e('.pid_filter input[name="dtermLowpass2Frequency"]').val()),t.FILTER_CONFIG.dterm_lowpass2_type=parseInt(e('.pid_filter select[name="dtermLowpass2Type"]').val()),t.ADVANCED_TUNING.itermRotation=e('input[id="itermrotation"]').is(":checked")?1:0,t.ADVANCED_TUNING.smartFeedforward=e('input[id="smartfeedforward"]').is(":checked")?1:0,t.ADVANCED_TUNING.itermRelax=e('input[id="itermrelax"]').is(":checked")?e('select[id="itermrelaxAxes"]').val():0,t.ADVANCED_TUNING.itermRelaxType=e('select[id="itermrelaxType"]').val(),t.ADVANCED_TUNING.itermRelaxCutoff=parseInt(e('input[name="itermRelaxCutoff"]').val()),t.ADVANCED_TUNING.absoluteControlGain=e('input[name="absoluteControlGain-number"]').val(),t.ADVANCED_TUNING.throttleBoost=e('input[name="throttleBoost-number"]').val(),t.ADVANCED_TUNING.acroTrainerAngleLimit=e('input[name="acroTrainerAngleLimit-number"]').val(),t.ADVANCED_TUNING.feedforwardRoll=parseInt(e('.pid_tuning .ROLL input[name="f"]').val()),t.ADVANCED_TUNING.feedforwardPitch=parseInt(e('.pid_tuning .PITCH input[name="f"]').val()),t.ADVANCED_TUNING.feedforwardYaw=parseInt(e('.pid_tuning .YAW input[name="f"]').val()),t.ADVANCED_TUNING.feedforwardTransition=parseInt(e('input[name="feedforwardTransition-number"]').val()*100),t.ADVANCED_TUNING.antiGravityMode=b.lt(t.CONFIG.apiVersion,q)?e('select[id="antiGravityMode"]').val():0,t.RC_TUNING.throttleLimitType=e('select[id="throttleLimitType"]').val(),t.RC_TUNING.throttleLimitPercent=parseInt(e('.throttle_limit input[name="throttleLimitPercent"]').val()),t.FILTER_CONFIG.gyro_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="gyroLowpassDynMinFrequency"]').val()),t.FILTER_CONFIG.gyro_lowpass_dyn_max_hz=parseInt(e('.pid_filter input[name="gyroLowpassDynMaxFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_dyn_min_hz=parseInt(e('.pid_filter input[name="dtermLowpassDynMinFrequency"]').val()),t.FILTER_CONFIG.dterm_lowpass_dyn_max_hz=parseInt(e('.pid_filter input[name="dtermLowpassDynMaxFrequency"]').val()),t.ADVANCED_TUNING.dMinRoll=parseInt(e('.pid_tuning input[name="dMinRoll"]').val()),t.ADVANCED_TUNING.dMinPitch=parseInt(e('.pid_tuning input[name="dMinPitch"]').val()),t.ADVANCED_TUNING.dMinYaw=parseInt(e('.pid_tuning input[name="dMinYaw"]').val()),t.ADVANCED_TUNING.dMinGain=parseInt(e('.dminGroup input[name="dMinGain"]').val()),t.ADVANCED_TUNING.dMinAdvance=parseInt(e('.dminGroup input[name="dMinAdvance"]').val()),t.ADVANCED_TUNING.useIntegratedYaw=e('input[id="useIntegratedYaw"]').is(":checked")?1:0,t.FILTER_CONFIG.dyn_notch_range=parseInt(e('.pid_filter select[name="dynamicNotchRange"]').val()),t.FILTER_CONFIG.dyn_notch_width_percent=parseInt(e('.pid_filter input[name="dynamicNotchWidthPercent"]').val()),t.FILTER_CONFIG.dyn_notch_q=parseInt(e('.pid_filter input[name="dynamicNotchQ"]').val()),t.FILTER_CONFIG.dyn_notch_min_hz=parseInt(e('.pid_filter input[name="dynamicNotchMinHz"]').val());const j=e(".pid_filter #rpmFilterEnabled").is(":checked");t.FILTER_CONFIG.gyro_rpm_notch_harmonics=j?parseInt(e('.pid_filter input[name="rpmFilterHarmonics"]').val()):0,t.FILTER_CONFIG.gyro_rpm_notch_min_hz=parseInt(e('.pid_filter input[name="rpmFilterMinHz"]').val()),t.FILTER_CONFIG.dyn_notch_max_hz=parseInt(e('.pid_filter input[name="dynamicNotchMaxHz"]').val()),t.ADVANCED_TUNING.motorOutputLimit=parseInt(e('.tab-pid_tuning input[name="motorLimit"]').val()),t.ADVANCED_TUNING.autoProfileCellCount=parseInt(e('.tab-pid_tuning select[name="cellCount"]').val()),t.ADVANCED_TUNING.idleMinRpm=parseInt(e('input[name="idleMinRpm-number"]').val());const B=e('select[id="ratesType"]').val();let U;B!==t.RC_TUNING.rates_type&&(U=e('select[id="ratesType"]').find("option:selected").text()),i.analyticsChanges.RatesType=U,t.RC_TUNING.rates_type=B,t.ADVANCED_TUNING.feedforward_averaging=e('select[id="feedforwardAveraging"]').val(),t.ADVANCED_TUNING.feedforward_smooth_factor=parseInt(e('input[name="feedforwardSmoothFactor"]').val()),t.ADVANCED_TUNING.feedforward_boost=parseInt(e('input[name="feedforwardBoost"]').val()),t.ADVANCED_TUNING.feedforward_max_rate_limit=parseInt(e('input[name="feedforwardMaxRateLimit"]').val()),t.ADVANCED_TUNING.feedforward_jitter_factor=parseInt(e('input[name="feedforwardJitterFactor"]').val()),t.FILTER_CONFIG.dyn_lpf_curve_expo=parseInt(e('.pid_filter input[name="dtermLowpassDynExpo"]').val()),t.ADVANCED_TUNING.vbat_sag_compensation=e('input[id="vbatSagCompensation"]').is(":checked")?parseInt(e('input[name="vbatSagValue"]').val()):0,t.ADVANCED_TUNING.thrustLinearization=e('input[id="thrustLinearization"]').is(":checked")?parseInt(e('input[name="thrustLinearValue"]').val()):0,t.FILTER_CONFIG.dyn_lpf_curve_expo=parseInt(e('.pid_filter input[name="dtermLowpassExpo"]').val());const Q=e('.pid_filter input[id="dynamicNotchEnabled"]').is(":checked");t.FILTER_CONFIG.dyn_notch_count=Q?parseInt(e('.pid_filter input[name="dynamicNotchCount"]').val()):0,t.TUNING_SLIDERS.slider_pids_mode=s.sliderPidsMode,t.TUNING_SLIDERS.slider_master_multiplier=Math.round(s.sliderMasterMultiplier*20)*5,t.TUNING_SLIDERS.slider_d_gain=Math.round(s.sliderDGain*20)*5,t.TUNING_SLIDERS.slider_pi_gain=Math.round(s.sliderPIGain*20)*5,t.TUNING_SLIDERS.slider_feedforward_gain=Math.round(s.sliderFeedforwardGain*20)*5,t.TUNING_SLIDERS.slider_i_gain=Math.round(s.sliderIGain*20)*5,t.TUNING_SLIDERS.slider_dmax_gain=Math.round(s.sliderDMaxGain*20)*5,t.TUNING_SLIDERS.slider_roll_pitch_ratio=Math.round(s.sliderRollPitchRatio*20)*5,t.TUNING_SLIDERS.slider_pitch_pi_gain=Math.round(s.sliderPitchPIGain*20)*5,t.TUNING_SLIDERS.slider_dterm_filter=s.sliderDTermFilter,t.TUNING_SLIDERS.slider_dterm_filter_multiplier=Math.round(s.sliderDTermFilterMultiplier*20)*5,t.TUNING_SLIDERS.slider_gyro_filter=s.sliderGyroFilter,t.TUNING_SLIDERS.slider_gyro_filter_multiplier=Math.round(s.sliderGyroFilterMultiplier*20)*5}function _(){e(".pid_optional tr").hide(),e(".pid_optional table").hide(),e(".pid_optional").hide(),t.PID_NAMES.forEach(function(m){e(`.pid_tuning .${m}`).show(),e(`.needed_by_${m}`).show()})}function p(){it(t.CONFIG.activeSensors,"acc")||(e("#pid_accel").hide(),e(".acroTrainerAngleLimit").hide()),e("#pid_baro_mag_gps").hide()}function E(m,N,I){m.strokeStyle="#000000",m.lineWidth=4,m.beginPath(),m.moveTo(0,I/2),m.lineTo(N,I/2),m.stroke(),m.beginPath(),m.moveTo(N/2,0),m.lineTo(N/2,I),m.stroke()}function A(m){let N=parseFloat(m.val());return(N<parseFloat(m.prop("min"))||N>parseFloat(m.prop("max")))&&(N=void 0),N}const G=!1;i.rateCurve=new nt(G),e('.pid_tuning input[name="sensitivity"]').hide(),e(".pid_tuning .levelSensitivityHeader").empty();function z(m,N,I,C,w,D,x){const v=i.rateCurve.getMaxAngularVel(m,N,I,C,w,D).toFixed(0);return x.text(v),v}function k(m,N,I,C,w,D,x,v,V,S){S.save(),S.strokeStyle=v,S.translate(0,V),i.rateCurve.draw(m,N,I,C,w,D,x,S),S.restore()}function ce(){Ue.pid_tuning.isHtmlProcessing=!0,t.FEATURE_CONFIG.features.generateElements(e(".tab-pid_tuning .features")),e(".tab-pid_tuning .pidTuningSuperexpoRates").hide(),F.localizePage(),i.currentRates=i.rateCurve.getCurrentRates(),e(".tab-pid_tuning .tab-container .pid").on("click",()=>ee("pid")),e(".tab-pid_tuning .tab-container .rates").on("click",()=>ee("rates")),e(".tab-pid_tuning .tab-container .filter").on("click",()=>ee("filter"));function m(){const r=t.CONFIG.numProfiles,d=[];for(let R=0;R<r;R++)d.push(F.getMessage("pidTuningProfileOption",[R+1]));return d}function N(){let r=6;b.gte(t.CONFIG.apiVersion,q)&&(r=4);const d=[];for(let R=0;R<r;R++)d.push(F.getMessage("pidTuningRateProfileOption",[R+1]));return d}const I=N(),C=m();function w(r){const d=e('select[name="profile"]');r.forEach(function(R,O){d.append(`<option value="${O}">${R}</option>`)})}w(C);function D(r){const d=e('select[name="rate_profile"]');r.forEach(function(R,O){d.append(`<option value="${O}">${R}</option>`)})}D(I);const x=e("#showAllPids");function v(){i.showAllPids?(_(),x.text(F.getMessage("pidTuningHideUnusedPids"))):(p(),x.text(F.getMessage("pidTuningShowAllPids")))}_(),v(),x.on("click",function(){i.showAllPids=!i.showAllPids,v()}),e("#resetPidProfile").on("click",function(){i.updating=!0,y.promise(h.MSP_SET_RESET_CURR_PID).then(function(){i.refresh(function(){i.updating=!1,Se(F.getMessage("pidTuningPidProfileReset"))})})}),e('.tab-pid_tuning select[name="profile"]').change(function(){i.currentProfile=parseInt(e(this).val()),i.updating=!0,e(this).prop("disabled","true"),y.promise(h.MSP_SELECT_SETTING,[i.currentProfile]).then(function(){i.refresh(function(){i.updating=!1,e('.tab-pid_tuning select[name="profile"]').prop("disabled","false"),t.CONFIG.profile=i.currentProfile,Se(F.getMessage("pidTuningLoadedProfile",[i.currentProfile+1]))})})}),e('.tab-pid_tuning select[name="rate_profile"]').change(function(){i.currentRateProfile=parseInt(e(this).val()),i.updating=!0,e(this).prop("disabled","true"),y.promise(h.MSP_SELECT_SETTING,[i.currentRateProfile+i.RATE_PROFILE_MASK]).then(function(){i.refresh(function(){i.updating=!1,e('.tab-pid_tuning select[name="rate_profile"]').prop("disabled","false"),t.CONFIG.rateProfile=i.currentRateProfile,i.currentRates=i.rateCurve.getCurrentRates(),Se(F.getMessage("pidTuningLoadedRateProfile",[i.currentRateProfile+1]))})})});const V=e('input[name="dtermSetpointTransition-number"]'),S=e("#pid-tuning .dtermSetpointTransitionWarning");function j(r){r>0&&r<.1?S.show():S.hide()}j(V.val()),V.on("input",function(){j(e(this).val())}),e("#pid-tuning .delta").hide(),e(".tab-pid_tuning .note").hide(),e(".pid_tuning tr").each(function(){for(const r of t.PID_NAMES)if(e(this).hasClass(r)){const d=e(this).find("td:first");d.text()||d.text(r)}});function B(){const r=[];return r.push("PT1"),r.push("BIQUAD"),r.push("PT2"),r.push("PT3"),r}function U(r,d){const R=e(`select[name="${r}"]`);d.forEach(function(O,ge){R.append(`<option value="${ge}">${O}</option>`)})}function Q(){return["HIGH","MEDIUM","LOW","AUTO"]}function oe(r){const d=e('select[name="dynamicNotchRange"]');r.forEach(function(R,O){d.append(`<option value="${O}">${R}</option>`)})}oe(Q()),U("gyroLowpassType",B()),U("gyroLowpass2Type",B()),U("dtermLowpassType",B()),U("dtermLowpass2Type",B()),l();function ee(r){const d=["pid","rates","filter"];if(!d.includes(r)){console.debug(`Invalid subtab name: "${r}"`);return}for(const R of d)e(`.tab-pid_tuning .subtab-${R}`)[R===r?"show":"hide"]();e(".tab-pid_tuning .tab-container .tab").removeClass("active"),e(`.tab-pid_tuning .tab-container .${r}`).addClass("active"),i.activeSubtab=r,r==="rates"?(le(!0),i.throttleDrawInterval=setInterval(le,100)):i.throttleDrawInterval&&(clearInterval(i.throttleDrawInterval),i.throttleDrawInterval=null)}ee(i.activeSubtab),e(".tab-pid_tuning div.controller").hide(),i.updatePidControllerParameters(),e(".pid_tuning .roll_pitch_rate").hide(),b.gte(t.CONFIG.apiVersion,q)?e(".tpa-old").hide():e(".tpa").hide(),e(".pid_tuning .bracket").hide(),e(".pid_tuning input[name=rc_rate]").parent().attr("class","pid_data"),e(".pid_tuning input[name=rc_rate]").parent().attr("rowspan",1),e(".pid_tuning input[name=rc_expo]").parent().attr("class","pid_data"),e(".pid_tuning input[name=rc_expo]").parent().attr("rowspan",1);const J=e(".rate_curve canvas#rate_curve_layer0").get(0),M=J.getContext("2d");let Y=!0,$;i.maxAngularVelRollElement=e(".pid_tuning .maxAngularVelRoll"),i.maxAngularVelPitchElement=e(".pid_tuning .maxAngularVelPitch"),i.maxAngularVelYawElement=e(".pid_tuning .maxAngularVelYaw"),i.acroCenterSensitivityRollElement=e(".pid_tuning .acroCenterSensitivityRoll"),i.acroCenterSensitivityPitchElement=e(".pid_tuning .acroCenterSensitivityPitch"),i.acroCenterSensitivityYawElement=e(".pid_tuning .acroCenterSensitivityYaw"),J.width=1e3,J.height=1e3;function de(r){setTimeout(function(){if(r){const d=e(r.target);let R=A(d);if(i.currentRates.hasOwnProperty(d.attr("name"))&&R!==void 0){const O=parseFloat(d.prop("step"));O!=null&&(R=Math.round(R/O)*O),i.currentRates[d.attr("name")]=R,Y=!0}d.attr("name")==="SUPEREXPO_RATES"&&(i.currentRates.superexpo=d.is(":checked"),Y=!0),d.attr("id")==="ratesType"&&(i.changeRatesType(R),Y=!0)}else Y=!0;if(Y){const d=J.height,R=J.width,O=M.canvas.width/M.canvas.clientWidth;M.clearRect(0,0,R,d),$=Math.max(z(i.currentRates.roll_rate,i.currentRates.rc_rate,i.currentRates.rc_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.roll_rate_limit,i.maxAngularVelRollElement),z(i.currentRates.pitch_rate,i.currentRates.rc_rate_pitch,i.currentRates.rc_pitch_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.pitch_rate_limit,i.maxAngularVelPitchElement),z(i.currentRates.yaw_rate,i.currentRates.rc_rate_yaw,i.currentRates.rc_yaw_expo,i.currentRates.superexpo,i.currentRates.yawDeadband,i.currentRates.yaw_rate_limit,i.maxAngularVelYawElement)),$=i.rateCurve.setMaxAngularVel($),E(M,R,d),M.lineWidth=2*O,k(i.currentRates.roll_rate,i.currentRates.rc_rate,i.currentRates.rc_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.roll_rate_limit,$,"#ff0000",0,M),k(i.currentRates.pitch_rate,i.currentRates.rc_rate_pitch,i.currentRates.rc_pitch_expo,i.currentRates.superexpo,i.currentRates.deadband,i.currentRates.pitch_rate_limit,$,"#00ff00",-4,M),k(i.currentRates.yaw_rate,i.currentRates.rc_rate_yaw,i.currentRates.rc_yaw_expo,i.currentRates.superexpo,i.currentRates.yawDeadband,i.currentRates.yaw_rate_limit,$,"#0000ff",4,M),i.updateRatesLabels(),Y=!1}},0)}e("input.feature").on("input change",function(){const r=e(this);t.FEATURE_CONFIG.features.updateData(r),de()}),e(".pid_tuning").on("input change",de).trigger("input");function le(r=!1){if(!r&&!i.checkThrottle())return;function d(ne,pe,H,Re){const ae=1-ne;return ae*ae*pe+2*ae*ne*H+ne*ne*Re}function R(ne,pe,H,Re,ae,xe,Ve){return{x:d(Ve,ne,H,ae),y:d(Ve,pe,Re,xe)}}function O(ne,pe,H,Re){const ae=pe+Re-2*H,xe=2*(H-pe),Ve=pe-ne;return ae==0?-Ve/xe:(-xe-Math.sqrt(Math.pow(xe,2)-4*ae*Ve))/(2*ae)}const ge={OFF:0,SCALE:1,CLIP:2},Ce=e('.throttle input[name="mid"]'),Oe=e('.throttle input[name="expo"]'),ze=e('.throttle_limit input[name="throttleLimitPercent"]'),ke=e('.throttle_limit select[id="throttleLimitType"]'),se=parseFloat(Ce.val()),fe=parseFloat(Oe.val()),Te=parseInt(ze.val())/100,a=parseInt(ke.val()),u=e(".throttle .throttle_curve canvas").get(0),f=u.getContext("2d");if(!(se>=parseFloat(Ce.prop("min"))&&se<=parseFloat(Ce.prop("max"))&&fe>=parseFloat(Oe.prop("min"))&&fe<=parseFloat(Oe.prop("max"))))return;u.width=u.height*(u.clientWidth/u.clientHeight);const X=a===ge.SCALE?Te:1,P=u.height,_e=u.width,Ae=P*(1-X),W=_e*se,Ye=W*.5,qe=(_e-W)*.5+W,ie=P-X*(W*(P/_e)),ve=P-(P-ie)*.5*(fe+1),Me=Ae+(ie-Ae)*.5*(fe+1);let Pe=(t.RC.channels[3]-1e3)/1e3,we=Pe<=se?R(0,P,Ye,ve,W,ie,Pe*(1/se)):R(W,ie,qe,Me,_e,Ae,(Pe-se)*(1/(1-se)));if(f.clearRect(0,0,_e,P),f.beginPath(),f.moveTo(0,P),a===ge.CLIP){const ne=P*(1-Te);we.y=we.y<ne?ne:we.y;const pe=Te<=se?O(ne,P,ve,ie):O(ne,ie,Me,Ae);let H=R(0,P,Ye,ve,W,ie,pe),Re=H.x/2,ae=ve+(P-ve)*(W-H.x)/W;Te>se&&(f.quadraticCurveTo(Ye,ve,W,ie),f.moveTo(W,ie),H=R(W,ie,qe,Me,_e,Ae,pe),Re=W+(H.x-W)/2,ae=Me+(ie-Me)*(_e-H.x)/(_e-W)),f.quadraticCurveTo(Re,ae,H.x,H.y),f.moveTo(H.x,H.y),f.lineTo(_e,H.y)}else f.quadraticCurveTo(Ye,ve,W,ie),f.moveTo(W,ie),f.quadraticCurveTo(qe,Me,_e,Ae);f.lineWidth=2,f.strokeStyle="#ffbb00",f.stroke(),f.beginPath(),f.arc(we.x,we.y,4,0,2*Math.PI),f.fillStyle=f.strokeStyle,f.fill(),f.save();let He=10;f.font=`${He}pt Verdana, Arial, sans-serif`;let Ke=Pe*100,je=100-we.y/P*100,$e=`${Math.round(Pe<=0?0:Ke)}% = ${Math.round(Pe<=0?0:je)}%`,Je=f.measureText($e);f.fillStyle="#000",f.scale(Je/u.clientWidth,1),f.fillText($e,5,5+He),f.restore()}e(".throttle input, .throttle_limit input, .throttle_limit select").on("change",()=>setTimeout(()=>le(!0),0)),e("a.refresh").click(function(){i.refresh(function(){Se(F.getMessage("pidTuningDataRefreshed"))})}),e("#pid-tuning").find("input").each(function(r,d){e(d).attr("class")!=="feature toggle"&&e(d).attr("class")!=="nonProfile"&&e(d).change(function(){i.setDirty(!0)})});const re=e(".dialogCopyProfile")[0],te=0,ue=1;let Ne;const Ie=e(".selectProfile"),me=e(".selectRateProfile");e.each(C,function(r,d){r!==t.CONFIG.profile&&Ie.append(new Option(d,r))}),e.each(I,function(r,d){r!==t.CONFIG.rateProfile&&me.append(new Option(d,r))}),e(".copyprofilebtn").click(function(){e(".dialogCopyProfile").find(".contentProfile").show(),e(".dialogCopyProfile").find(".contentRateProfile").hide(),Ne=te,re.showModal()}),e(".copyrateprofilebtn").click(function(){e(".dialogCopyProfile").find(".contentProfile").hide(),e(".dialogCopyProfile").find(".contentRateProfile").show(),Ne=ue,re.showModal()}),e(".dialogCopyProfile-cancelbtn").click(function(){re.close()}),e(".dialogCopyProfile-confirmbtn").click(function(){switch(Ne){case te:t.COPY_PROFILE.type=te,t.COPY_PROFILE.dstProfile=parseInt(Ie.val()),t.COPY_PROFILE.srcProfile=t.CONFIG.profile,y.send_message(h.MSP_COPY_PROFILE,K.crunch(h.MSP_COPY_PROFILE),!1,r);break;case ue:t.COPY_PROFILE.type=ue,t.COPY_PROFILE.dstProfile=parseInt(me.val()),t.COPY_PROFILE.srcProfile=t.CONFIG.rateProfile,y.send_message(h.MSP_COPY_PROFILE,K.crunch(h.MSP_COPY_PROFILE),!1,r);break;default:r();break}function r(){re.close()}}),s.initialize();const Fe=1.4,Ge=.7,De=e("#sliderPidsModeSelect"),be=e("#sliderGyroFilterModeSelect"),Le=e("#sliderDTermFilterModeSelect"),Z=e('input[id="useIntegratedYaw"]');Z.on("change",()=>{Z.is(":checked")&&s.sliderPidsMode&&De.val(1).trigger("change")}),De.on("change",function(){const r=parseInt(e(this).val());s.sliderPidsMode=r,s.calculateNewPids(),s.updatePidSlidersDisplay(),r===2&&Z.prop("checked",!1).trigger("change")}),be.change(function(){parseInt(e(this).find(":selected").val())===1?s.gyroFilterSliderEnable():s.gyroFilterSliderDisable()}),Le.change(function(){parseInt(e(this).find(":selected").val())!==0?s.dtermFilterSliderEnable():s.dtermFilterSliderDisable()});const he=e("#sliderMasterMultiplier, #sliderDGain, #sliderPIGain, #sliderFeedforwardGain, #sliderIGain, #sliderDMaxGain, #sliderRollPitchRatio, #sliderPitchPIGain");e(".tab-pid-tuning .legacySlider").hide(),he.on("input mouseup",function(){const r=e(this);s.expertMode||(r.val()>Fe?r.val(Fe):r.val()<Ge&&r.val(Ge));const d=We(r.val())?parseInt(r.val()):parseFloat(r.val());r.is("#sliderDGain")?s.sliderDGain=d:r.is("#sliderPIGain")?s.sliderPIGain=d:r.is("#sliderFeedforwardGain")?s.sliderFeedforwardGain=d:r.is("#sliderDMaxGain")?s.sliderDMaxGain=d:r.is("#sliderIGain")?s.sliderIGain=d:r.is("#sliderRollPitchRatio")?s.sliderRollPitchRatio=d:r.is("#sliderPitchPIGain")?s.sliderPitchPIGain=d:r.is("#sliderMasterMultiplier")&&(s.sliderMasterMultiplier=d),i.calculateNewPids(),i.analyticsChanges.PidTuningSliders="On"}),he.each(function(r){i.sliderOnScroll(e(this))}),he.dblclick(function(){const r=e(this);let d;r.is("#sliderDGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_d_gain/100,s.sliderDGain=d):r.is("#sliderPIGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_pi_gain/100,s.sliderPIGain=d):r.is("#sliderFeedforwardGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_feedforward_gain/100,s.sliderFeedforwardGain=d):r.is("#sliderDMaxGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_dmax_gain/100,s.sliderDMaxGain=d):r.is("#sliderIGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_i_gain/100,s.sliderIGain=d):r.is("#sliderRollPitchRatio")?(d=t.DEFAULT_TUNING_SLIDERS.slider_roll_pitch_ratio/100,s.sliderRollPitchRatio=d):r.is("#sliderPitchPIGain")?(d=t.DEFAULT_TUNING_SLIDERS.slider_pitch_pi_gain/100,s.sliderPitchPIGain=d):r.is("#sliderMasterMultiplier")&&(d=t.DEFAULT_TUNING_SLIDERS.slider_master_multiplier/100,s.sliderMasterMultiplier=d),r.val(d),i.calculateNewPids()});const ye=e("#sliderGyroFilterMultiplier, #sliderDTermFilterMultiplier");ye.on("input mouseup",function(){const r=e(this);s.expertMode||(r.is("#sliderGyroFilterMultiplier")?r.val()>1.5?r.val(1.5):r.val()<.5&&r.val(.5):r.is("#sliderDTermFilterMultiplier")&&(r.val()>1.2?r.val(1.2):r.val()<.8&&r.val(.8)));let d=We(r.val())?parseInt(r.val()):parseFloat(r.val());r.is("#sliderGyroFilterMultiplier")?(s.sliderGyroFilterMultiplier=d,i.calculateNewGyroFilters(),i.analyticsChanges.GyroFilterTuningSlider="On"):r.is("#sliderDTermFilterMultiplier")&&(s.sliderDTermFilterMultiplier=d,i.calculateNewDTermFilters(),i.analyticsChanges.DTermFilterTuningSlider="On")}),ye.each(function(){i.sliderOnScroll(e(this))}),ye.dblclick(function(){const r=e(this);r.val(1),r.is("#sliderGyroFilterMultiplier")?(s.sliderGyroFilterMultiplier=1,i.calculateNewGyroFilters()):r.is("#sliderDTermFilterMultiplier")&&(s.sliderDTermFilterMultiplier=1,i.calculateNewDTermFilters())}),e(".pid_filter tr:not(.newFilter) input, .pid_filter tr:not(.newFilter) select").on("input",function(r){r.target.type==="number"?e(`.pid_filter input[name="${r.target.name}"]`).val(r.target.value):r.target.type==="select-one"&&e(`.pid_filter select[name="${r.target.name}"]`).val(r.target.value),s.GyroSliderUnavailable&&(i.analyticsChanges.GyroFilterTuningSlider="Off"),s.DTermSliderUnavailable&&(i.analyticsChanges.DTermFilterTuningSlider="Off")}),e(".pid_filter tr:not(.newFilter) .inputSwitch input").change(()=>{e(".pid_filter input").triggerHandler("input"),i.setDirty(!0)}),e(".tuningHelp").hide(),e("#pid-tuning .delta select").change(function(){i.setDirty(!0)}),e("a.update").click(function(){T(),i.updating=!0,y.promise(h.MSP_SET_PID,K.crunch(h.MSP_SET_PID)).then(()=>y.promise(h.MSP_SET_PID_ADVANCED,K.crunch(h.MSP_SET_PID_ADVANCED))).then(()=>b.gte(t.CONFIG.apiVersion,q)?y.promise(h.MSP2_SET_TEXT,K.crunch(h.MSP2_SET_TEXT,h.PID_PROFILE_NAME)):!0).then(()=>b.gte(t.CONFIG.apiVersion,q)?y.promise(h.MSP2_SET_TEXT,K.crunch(h.MSP2_SET_TEXT,h.RATE_PROFILE_NAME)):!0).then(()=>(i.updatePIDColors(),y.promise(h.MSP_SET_FILTER_CONFIG,K.crunch(h.MSP_SET_FILTER_CONFIG)))).then(()=>y.promise(h.MSP_SET_RC_TUNING,K.crunch(h.MSP_SET_RC_TUNING))).then(()=>y.promise(h.MSP_SET_FEATURE_CONFIG,K.crunch(h.MSP_SET_FEATURE_CONFIG))).then(()=>y.promise(h.MSP_SET_SIMPLIFIED_TUNING,K.crunch(h.MSP_SET_SIMPLIFIED_TUNING))).then(()=>y.promise(h.MSP_EEPROM_WRITE)).then(()=>{i.updating=!1,i.setDirty(!1),Se(F.getMessage("pidTuningEepromSaved")),i.refresh()}),Be.sendSaveAndChangeEvents(Be.EVENT_CATEGORIES.FLIGHT_CONTROLLER,i.analyticsChanges,"pid_tuning"),i.analyticsChanges={}}),i.initRatesPreview(),i.renderModel(),i.updating=!1,Ee.interval_add("receiver_pull",i.getReceiverData,250,!0),Ee.interval_add("update_profile",function(){i.checkUpdateProfile(!0)},500,!0),i.analyticsChanges={},Ee.content_ready(n),Ue.pid_tuning.isHtmlProcessing=!1}};L.getReceiverData=function(){y.send_message(h.MSP_RC,!1,!1)};L.initRatesPreview=function(){this.keepRendering=!0,this.model=new et(e(".rates_preview"),e(".rates_preview canvas")),e(".tab-pid_tuning .tab-container .rates").on("click",e.proxy(this.model.resize,this.model)),e(".tab-pid_tuning .tab-container .rates").on("click",e.proxy(this.updateRatesLabels,this)),e(window).on("resize",e.proxy(this.model.resize,this.model)),e(window).on("resize",e.proxy(this.updateRatesLabels,this))};L.renderModel=function(){if(this.keepRendering&&(requestAnimationFrame(this.renderModel.bind(this)),this.clock||(this.clock=new tt),t.RC.channels[0]&&t.RC.channels[1]&&t.RC.channels[2])){const n=this.clock.getDelta(),i=n*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[0],this.currentRates.roll_rate,this.currentRates.rc_rate,this.currentRates.rc_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.roll_rate_limit),o=n*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[1],this.currentRates.pitch_rate,this.currentRates.rc_rate_pitch,this.currentRates.rc_pitch_expo,this.currentRates.superexpo,this.currentRates.deadband,this.currentRates.pitch_rate_limit),c=n*this.rateCurve.rcCommandRawToDegreesPerSecond(t.RC.channels[2],this.currentRates.yaw_rate,this.currentRates.rc_rate_yaw,this.currentRates.rc_yaw_expo,this.currentRates.superexpo,this.currentRates.yawDeadband,this.currentRates.yaw_rate_limit);this.model.rotateBy(-Xe(o),-Xe(c),-Xe(i)),this.checkRC()&&this.updateRatesLabels()}};L.cleanup=function(n){const i=this;i.keepRendering=!1,i.model&&(e(window).off("resize",e.proxy(i.model.resize,i.model)),i.model.dispose()),e(window).off("resize",e.proxy(this.updateRatesLabels,this)),i.throttleDrawInterval&&clearInterval(i.throttleDrawInterval),n&&n()};L.refresh=function(n){const i=this;Ee.tab_switch_cleanup(function(){i.initialize(),i.setDirty(!1),n&&n()})};L.setProfile=function(){const n=this;n.currentProfile=t.CONFIG.profile,e('.tab-pid_tuning select[name="profile"]').val(n.currentProfile)};L.setRateProfile=function(){const n=this;n.currentRateProfile=t.CONFIG.rateProfile,e('.tab-pid_tuning select[name="rate_profile"]').val(n.currentRateProfile)};L.setDirty=function(n){const i=this;i.dirty=n,e('.tab-pid_tuning select[name="profile"]').prop("disabled",n),e('.tab-pid_tuning select[name="rate_profile"]').prop("disabled",n)};L.checkUpdateProfile=function(n){const i=this;if(Ee.active_tab==="pid_tuning"&&!i.updating&&!i.dirty){let o=!1;i.currentProfile!==t.CONFIG.profile&&(i.setProfile(),o=!0);let c=!1;n&&i.currentRateProfile!==t.CONFIG.rateProfile&&(i.setRateProfile(),c=!0),(o||c)&&(i.updating=!0,i.refresh(function(){i.updating=!1,o&&(Se(F.getMessage("pidTuningReceivedProfile",[t.CONFIG.profile+1])),t.CONFIG.profile=i.currentProfile),c&&(Se(F.getMessage("pidTuningReceivedRateProfile",[t.CONFIG.rateProfile+1])),t.CONFIG.rateProfile=i.currentRateProfile)}))}};L.checkRC=function(){this.oldRC||(this.oldRC=[t.RC.channels[0],t.RC.channels[1],t.RC.channels[2]]);let n=!1;for(let i=0;i<this.oldRC.length;i++)this.oldRC[i]!==t.RC.channels[i]&&(this.oldRC[i]=t.RC.channels[i],n=!0);return n};L.checkThrottle=function(){if(!this.oldThrottle)return this.oldThrottle=t.RC.channels[3],!0;const n=this.oldThrottle!==t.RC.channels[3];return this.oldThrottle=t.RC.channels[3],n};L.updatePidControllerParameters=function(){e(".pid_tuning .YAW_JUMP_PREVENTION").hide(),e("#pid-tuning .dtermSetpointTransition").hide(),e("#pid-tuning .dtermSetpoint").hide(),e("#pid-tuning .delta").hide()};L.updateRatesLabels=function(){const n=this;if(!n.rateCurve.useLegacyCurve&&n.rateCurve.maxAngularVel){const i=function(l,T,_,p,E,A){l.fillStyle=A||"#000000",l.textAlign=E||"center",l.fillText(T,_,p)},o=function(l,T,_,p,E,A,G){const m=parseInt(l.font),N=l.measureText(T).width*1.2,I=m*1.5,C=p;l.fillStyle=A.color||"#ffffff",l.strokeStyle=A.border||"#000000",_*=l.canvas.clientWidth/l.canvas.clientHeight,_+=(E=="right"?-(N+125):0)+(E=="left"?125:0),p-=I/2,p<0?p=0:p>l.height&&(p=l.height);for(let D=0;D<G.length;D++)(_>=G[D].left&&_<=G[D].right||_+N>=G[D].left&&_+N<=G[D].right)&&(p>=G[D].top&&p<=G[D].bottom||p+I>=G[D].top&&p+I<=G[D].bottom)&&(p<=(G[D].bottom-G[D].top)/2&&G[D].top-I>0?p=G[D].top-I:p=G[D].bottom);G.push({left:_,right:_+N,top:p-5,bottom:p+I+5});const w=(I-2*10)/6;l.beginPath(),l.moveTo(_+10,p),l.lineTo(_+N-10,p),l.quadraticCurveTo(_+N,p,_+N,p+10),E==="right"&&(l.lineTo(_+N,p+10+w),l.lineTo(_+N+125,C),l.lineTo(_+N,p+I-10-w)),l.lineTo(_+N,p+I-10),l.quadraticCurveTo(_+N,p+I,_+N-10,p+I),l.lineTo(_+10,p+I),l.quadraticCurveTo(_,p+I,_,p+I-10),E==="left"&&(l.lineTo(_,p+I-10-w),l.lineTo(_-125,C),l.lineTo(_,p+10-w)),l.lineTo(_,p+10),l.quadraticCurveTo(_,p,_+10,p),l.closePath(),l.fill(),l.stroke(),i(l,T,_+N/2,p+(I+m)/2-4,"center",A.text)},c={roll:{color:"rgba(255,128,128,0.4)",border:"rgba(255,128,128,0.6)",text:"#000000"},pitch:{color:"rgba(128,255,128,0.4)",border:"rgba(128,255,128,0.6)",text:"#000000"},yaw:{color:"rgba(128,128,255,0.4)",border:"rgba(128,128,255,0.6)",text:"#000000"}},g=e(".rate_curve canvas#rate_curve_layer1").get(0);if(g){let ee=function(M){return z-Math.ceil(l.measureText(M).width)/(l.canvas.clientWidth/l.canvas.clientHeight)-40};g.width=1e3,g.height=1e3;const l=g.getContext("2d");l.save();const T=`${n.maxAngularVelRollElement.text()} deg/s`,_=`${n.maxAngularVelPitchElement.text()} deg/s`,p=`${n.maxAngularVelYawElement.text()} deg/s`;let E=[],A=[];const G=g.height,z=g.width,k=n.rateCurve.maxAngularVel,ce=400/l.canvas.clientHeight,m=G/2/k,N=l.canvas.width/l.canvas.clientWidth,I=l.canvas.clientHeight/l.canvas.clientWidth;l.clearRect(0,0,z,G),ce<=1?l.font="24pt Verdana, Arial, sans-serif":l.font=`${24*ce}pt Verdana, Arial, sans-serif`,t.RC.channels[0]&&t.RC.channels[1]&&t.RC.channels[2]?(E.push(`${n.rateCurve.drawStickPosition(t.RC.channels[0],n.currentRates.roll_rate,n.currentRates.rc_rate,n.currentRates.rc_expo,n.currentRates.superexpo,n.currentRates.deadband,n.currentRates.roll_rate_limit,k,l,"#FF8080")} deg/s`),E.push(`${n.rateCurve.drawStickPosition(t.RC.channels[1],n.currentRates.pitch_rate,n.currentRates.rc_rate_pitch,n.currentRates.rc_pitch_expo,n.currentRates.superexpo,n.currentRates.deadband,n.currentRates.pitch_rate_limit,k,l,"#80FF80")} deg/s`),E.push(`${n.rateCurve.drawStickPosition(t.RC.channels[2],n.currentRates.yaw_rate,n.currentRates.rc_rate_yaw,n.currentRates.rc_yaw_expo,n.currentRates.superexpo,n.currentRates.yawDeadband,n.currentRates.yaw_rate_limit,k,l,"#8080FF")} deg/s`)):E=[],l.lineWidth=N,l.scale(I,1),i(l,`${k.toFixed(0)} deg/s`,(z/2-10)/I,parseInt(l.font)*1.2,"right"),A=[];const C=[{value:parseInt(T),balloon:function(){o(l,T,z,m*(k-parseInt(T)),"right",c.roll,A)}},{value:parseInt(_),balloon:function(){o(l,_,z,m*(k-parseInt(_)),"right",c.pitch,A)}},{value:parseInt(p),balloon:function(){o(l,p,z,m*(k-parseInt(p)),"right",c.yaw,A)}}],w=1800,D=parseInt(T)>w||parseInt(_)>w||parseInt(p)>w;e(".maxRateWarning").toggle(D),C.sort(function(M,Y){return Y.value-M.value}),E[0]&&E[1]&&E[2]&&C.push({value:parseInt(E[0]),balloon:function(){o(l,E[0],10,150,"none",c.roll,A)}},{value:parseInt(E[1]),balloon:function(){o(l,E[1],10,250,"none",c.pitch,A)}},{value:parseInt(E[2]),balloon:function(){o(l,E[2],10,350,"none",c.yaw,A)}});const x=e("#pid-tuning .pid_titlebar .centerSensitivity"),v=n.currentRatesType===t.RATES_TYPE.BETAFLIGHT;x.toggle(v),n.acroCenterSensitivityRollElement.toggle(v),n.acroCenterSensitivityPitchElement.toggle(v),n.acroCenterSensitivityYawElement.toggle(v),e("#pid-tuning .pid_titlebar .maxVel").toggle(!v),n.maxAngularVelRollElement.toggle(!v),n.maxAngularVelPitchElement.toggle(!v),n.maxAngularVelYawElement.toggle(!v);const V=t.ADVANCED_TUNING.levelAngleLimit,S=parseInt(T),j=parseInt(_),B=parseInt(p),U=n.currentRates.rc_rate,Q=n.currentRates.rc_rate_pitch,oe=n.currentRates.rc_rate_yaw,J="Angle Mode";if(n.currentRatesType===t.RATES_TYPE.ACTUAL){i(l,J,(z-10)/I,G-250,"right");const M=(U/S*V).toFixed(1),Y=(Q/j*V).toFixed(1),$=`${M}...${V}`,de=`${Y}...${V}`,le=ee($),re=ee(de);C.push({value:parseInt(M),balloon:function(){o(l,$,le,G-150,"none",c.roll,A)}},{value:parseInt(Y),balloon:function(){o(l,de,re,G-50,"none",c.pitch,A)}})}if(n.currentRatesType===t.RATES_TYPE.BETAFLIGHT){i(l,J,(z-10)/I,G-250,"right");const M=14.54,Y=Z=>Z>2?(Z-2)*M+2:Z,$=(Z,he)=>((1-Z)*Y(he)*200).toFixed(0),de=(Z,he)=>(V*((1-Z)*Y(he)*200/S)).toFixed(1),le=n.currentRates.rc_expo,re=de(le,U),te=`${re} - ${V}`,ue=ee(te),Ne=$(le,U);n.acroCenterSensitivityRollElement.text(`${Ne} - ${S}`);const Ie=n.currentRates.rc_pitch_expo,me=de(Ie,Q),Fe=`${me} - ${V}`,Ge=ee(Fe),De=$(Ie,Q);n.acroCenterSensitivityPitchElement.text(`${De} - ${j}`);const be=n.currentRates.rc_yaw_expo,Le=$(be,oe);n.acroCenterSensitivityYawElement.text(`${Le} - ${B}`),C.push({value:parseInt(re),balloon:function(){o(l,te,ue,G-150,"none",c.roll,A)}},{value:parseInt(me),balloon:function(){o(l,Fe,Ge,G-50,"none",c.pitch,A)}})}for(const M of C)M.balloon();l.restore()}}};L.calculateNewPids=function(){Ue.pid_tuning.isHtmlProcessing||s.calculateNewPids()};L.calculateNewGyroFilters=function(){Ue.pid_tuning.isHtmlProcessing||s.sliderGyroFilter&&s.calculateNewGyroFilters()};L.calculateNewDTermFilters=function(){Ue.pid_tuning.isHtmlProcessing||s.sliderDTermFilter&&s.calculateNewDTermFilters()};L.updateFilterWarning=function(){const n=parseInt(e('.pid_filter select[name="gyroLowpassFilterMode"]').val()),i=n===1,o=!n,c=parseInt(e('.pid_filter select[name="dtermLowpassFilterMode"]').val()),g=c===1,l=!c,T=e("#pid-tuning .filterWarning"),_=e("#pid-tuning .dynamicNotchNyquistWarningNote");T.toggle(!(i||o)||!(g||l)),_.toggle(t.CONFIG.sampleRateHz/t.PID_ADVANCED_CONFIG.pid_process_denom<2e3)};L.updatePIDColors=function(n=!1){if(b.gte(t.CONFIG.apiVersion,"1.44.0"))return;const i=function(o,c,g){if(n){o.css({"background-color":"transparent"});return}if(g===void 0||c===void 0)return;const l=(g-c)/50;o.css({"background-color":rt(l,Qe.pidSlider)})};t.PID_NAMES.forEach(function(o,c){e(`.pid_tuning .${o} input`).each(function(g){i(e(this),t.PIDS_ACTIVE[c][g],t.PIDS[c][g])})}),i(e('.pid_tuning input[name="dMinRoll"]'),t.ADVANCED_TUNING_ACTIVE.dMinRoll,t.ADVANCED_TUNING.dMinRoll),i(e('.pid_tuning input[name="dMinPitch"]'),t.ADVANCED_TUNING_ACTIVE.dMinPitch,t.ADVANCED_TUNING.dMinPitch),i(e('.pid_tuning input[name="dMinYaw"]'),t.ADVANCED_TUNING_ACTIVE.dMinYaw,t.ADVANCED_TUNING.dMinYaw),i(e('.pid_tuning .ROLL input[name="f"]'),t.ADVANCED_TUNING_ACTIVE.feedforwardRoll,t.ADVANCED_TUNING.feedforwardRoll),i(e('.pid_tuning .PITCH input[name="f"]'),t.ADVANCED_TUNING_ACTIVE.feedforwardPitch,t.ADVANCED_TUNING.feedforwardPitch),i(e('.pid_tuning .YAW input[name="f"]'),t.ADVANCED_TUNING_ACTIVE.feedforwardYaw,t.ADVANCED_TUNING.feedforwardYaw)};L.changeRatesType=function(n){const i=this,o=e(".dialogRatesType")[0];if(i.previousRatesType==null){i.currentRatesType=n,i.changeRatesTypeLogo(),i.changeRatesSystem(!0),i.previousRatesType=i.currentRatesType;return}o.hasAttribute("open")||(o.showModal(),e(".dialogRatesType-cancelbtn").click(function(){e('.rates_type select[id="ratesType"]').val(i.currentRatesType),i.previousRatesType=i.currentRatesType,o.close()}),e(".dialogRatesType-confirmbtn").click(function(){i.currentRatesType=n,i.changeRatesTypeLogo(),i.changeRatesSystem(!1),i.previousRatesType=i.currentRatesType,o.close(),t.RC_TUNING.rates_type=i.currentRatesType,i.currentRates=i.rateCurve.getCurrentRates()}))};L.changeRatesSystem=function(n){const i=this;let o=2.55,c=.01,g=.01,l=1,T=.01,_=1,p=.01,E=0;const A=0,G=e('.pid_tuning input[name="pitch_rate"]'),z=e('.pid_tuning input[name="roll_rate"]'),k=e('.pid_tuning input[name="yaw_rate"]'),ce=e('.pid_tuning input[name="rc_rate_pitch"]'),m=e('.pid_tuning input[name="rc_rate"]'),N=e('.pid_tuning input[name="rc_rate_yaw"]'),I=e('.pid_tuning input[name="rc_pitch_expo"]'),C=e('.pid_tuning input[name="rc_expo"]'),w=e('.pid_tuning input[name="rc_yaw_expo"]'),D=e("#pid-tuning .pid_titlebar .rc_rate"),x=e("#pid-tuning .pid_titlebar .rate"),v=e("#pid-tuning .pid_titlebar .rc_expo"),V=e("#pid-tuning .pid_titlebar .centerSensitivity");let S=1 .toFixed(2),j=.7.toFixed(2),B=0 .toFixed(2);switch(n&&(G.val(t.RC_TUNING.pitch_rate.toFixed(2)),z.val(t.RC_TUNING.roll_rate.toFixed(2)),k.val(t.RC_TUNING.yaw_rate.toFixed(2)),ce.val(t.RC_TUNING.rcPitchRate.toFixed(2)),m.val(t.RC_TUNING.RC_RATE.toFixed(2)),N.val(t.RC_TUNING.rcYawRate.toFixed(2)),I.val(t.RC_TUNING.RC_PITCH_EXPO.toFixed(2)),C.val(t.RC_TUNING.RC_EXPO.toFixed(2)),w.val(t.RC_TUNING.RC_YAW_EXPO.toFixed(2))),i.currentRatesType){case t.RATES_TYPE.RACEFLIGHT:D.text(F.getMessage("pidTuningRcRateRaceflight")),x.text(F.getMessage("pidTuningRateRaceflight")),v.text(F.getMessage("pidTuningRcExpoRaceflight")),o=2e3,c=10,g=10,l=255,T=1,_=100,p=1,n?(G.val((t.RC_TUNING.pitch_rate*100).toFixed(0)),z.val((t.RC_TUNING.roll_rate*100).toFixed(0)),k.val((t.RC_TUNING.yaw_rate*100).toFixed(0)),ce.val((t.RC_TUNING.rcPitchRate*1e3).toFixed(0)),m.val((t.RC_TUNING.RC_RATE*1e3).toFixed(0)),N.val((t.RC_TUNING.rcYawRate*1e3).toFixed(0)),I.val((t.RC_TUNING.RC_PITCH_EXPO*100).toFixed(0)),C.val((t.RC_TUNING.RC_EXPO*100).toFixed(0)),w.val((t.RC_TUNING.RC_YAW_EXPO*100).toFixed(0))):(S=370 .toFixed(0),j=80 .toFixed(0),B=50 .toFixed(0));break;case t.RATES_TYPE.KISS:D.text(F.getMessage("pidTuningRcRate")),x.text(F.getMessage("pidTuningRcRateRaceflight")),v.text(F.getMessage("pidTuningRcExpoKISS")),l=.99;break;case t.RATES_TYPE.ACTUAL:D.text(F.getMessage("pidTuningRcRateActual")),x.text(F.getMessage("pidTuningRateQuickRates")),v.text(F.getMessage("pidTuningRcExpoRaceflight")),E=10,l=2e3,T=10,o=2e3,c=10,g=10,n?(G.val((t.RC_TUNING.pitch_rate*1e3).toFixed(0)),z.val((t.RC_TUNING.roll_rate*1e3).toFixed(0)),k.val((t.RC_TUNING.yaw_rate*1e3).toFixed(0)),ce.val((t.RC_TUNING.rcPitchRate*1e3).toFixed(0)),m.val((t.RC_TUNING.RC_RATE*1e3).toFixed(0)),N.val((t.RC_TUNING.rcYawRate*1e3).toFixed(0))):(S=70 .toFixed(0),j=670 .toFixed(0),B=0 .toFixed(2));break;case t.RATES_TYPE.QUICKRATES:D.text(F.getMessage("pidTuningRcRate")),x.text(F.getMessage("pidTuningRateQuickRates")),v.text(F.getMessage("pidTuningRcExpoRaceflight")),E=10,l=2e3,T=10,n?(G.val((t.RC_TUNING.pitch_rate*1e3).toFixed(0)),z.val((t.RC_TUNING.roll_rate*1e3).toFixed(0)),k.val((t.RC_TUNING.yaw_rate*1e3).toFixed(0))):j=670 .toFixed(0);break;default:D.text(F.getMessage("pidTuningRcRate")),x.text(F.getMessage("pidTuningRate")),v.text(F.getMessage("pidTuningRcExpo")),V.text(F.getMessage("pidTuningAcroCenterSensitiviy"));break}const U=e('#pid-tuning input[class="rc_rate_input"]'),Q=e('#pid-tuning input[class="rate_input"]'),oe=e('#pid-tuning input[class="expo_input"]');n||(Q.val(j),U.val(S),oe.val(B)),U.attr({max:o,min:c,step:g}).change(),Q.attr({max:l,min:E,step:T}).change(),oe.attr({max:_,min:A,step:p}).change(),n&&i.setDirty(!1)};L.changeRatesTypeLogo=function(){const n=this,i=e('.rates_type img[id="ratesLogo"]');switch(n.currentRatesType){case t.RATES_TYPE.RACEFLIGHT:i.attr("src","./images/rate_logos/raceflight.svg");break;case t.RATES_TYPE.KISS:i.attr("src","./images/rate_logos/kiss.svg");break;case t.RATES_TYPE.ACTUAL:i.attr("src","./images/rate_logos/actual.svg");break;case t.RATES_TYPE.QUICKRATES:i.attr("src","./images/rate_logos/quickrates.svg");break;default:i.attr("src","./images/rate_logos/betaflight.svg");break}};L.expertModeChanged=function(n){s.setExpertMode(n)};L.sliderOnScroll=function(n,i){n.parent().on("input wheel",function(o){var _,p;if(n.prop("disabled")||!((_=o.originalEvent)!=null&&_.deltaY&&((p=o.originalEvent)!=null&&p.altKey)))return;o.preventDefault();const c=parseFloat(n.attr("step")),g=o.originalEvent.deltaY>0?-c:c,l=We(n.val())?parseInt(n.val()):parseFloat(n.val()),T=(Math.floor(l*100)+Math.floor(g*100))/100;n.val(T),n.trigger("input"),n.trigger("change")})};Ue.pid_tuning=L;export{L as pid_tuning};
