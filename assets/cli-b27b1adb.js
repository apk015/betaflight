import{e as U,G as m,$ as s,c as g,T as C,C as d,b as T,t as x,k as _}from"./DarkTheme-2fd54461.js";import{C as E}from"./Clipboard-99e3cea4.js";import{g as F}from"./generate_filename-f7fae895.js";import{C as r,v as P,e as B,B as R}from"./main-ef562b84.js";const G=U(),f={lineDelayMs:5,profileSwitchDelayMs:100,outputHistory:"",cliBuffer:"",startProcessing:!1,GUI:{snippetPreviewWindow:null,copyButton:null,windowWrapper:null},lastArrival:0};function D(e){return e.replace(/^# /,"")}function O(e,t){let n=0;for(let i=0;i<t.length&&e[i]===t[i];i++)n++;return t.length-n}function H(e,t,n){return String.fromCharCode(127).repeat(n)+e.substring(t.length-n,e.length)}function S(e,t){const n=D(t),i=new RegExp(`^${n}`,"g");if(e.match(i))return e.replace(i,"");const c=O(e,n);return H(e,n,c)}function M(e){function t(){x.sendEvent(x.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"CliCopyToClipboard",{length:e.length});const i=C.cli.GUI.copyButton,c=i.text(),h=i.css("width");i.text(g.getMessage("cliCopySuccessful")),i.css({width:h,textAlign:"center"}),setTimeout(()=>{i.text(c),i.css({width:"",textAlign:""})},1500)}function n(i){console.warn(i)}E.writeText(e,t,n)}f.initialize=function(e){const t=this;m.active_tab!=="cli"&&(m.active_tab="cli"),t.outputHistory="",t.cliBuffer="",t.startProcessing=!1;const n=13;function i(){t.outputHistory="",t.GUI.windowWrapper.empty()}async function c(o){t.history.add(o.trim());function a(u){let p=u.shift().trim(),w=t.lineDelayMs;p.toLowerCase().startsWith("profile")&&(w=t.profileSwitchDelayMs);const b=l.length===0;b&&t.cliBuffer&&(p=S(p,t.cliBuffer)),t.sendLine(p),b||m.timeout_add("CLI_send_slowly",function(){a(u)},w)}const l=o.split(`
`);a(l)}async function h(){const o=s("#snippetpreviewcontent textarea#preview");function a(p){const w=o.val();x.sendEvent(x.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"CliExecuteFromFile",{filename:p}),c(w),t.GUI.snippetPreviewWindow.close()}function l(p,w){t.GUI.snippetPreviewWindow||(t.GUI.snippetPreviewWindow=new _("Modal",{id:"snippetPreviewWindow",width:"auto",height:"auto",closeButton:"title",animation:!1,isolateScroll:!1,title:g.getMessage("cliConfirmSnippetDialogTitle",{fileName:w}),content:s("#snippetpreviewcontent"),onCreated:()=>s("#snippetpreviewcontent a.confirm").click(()=>a(w))})),o.val(p),t.GUI.snippetPreviewWindow.open()}const u=await B.pickOpenFile(g.getMessage("fileSystemPickerFiles",{typeof:"TXT"}),".txt"),y=await B.readFile(u);l(y,u.name)}async function k(o,a){const l=await B.pickSaveFile(o,g.getMessage("fileSystemPickerFiles",{typeof:"TXT"}),".txt");await B.writeFile(l,a)}s("#content").load("./tabs/cli.html",function(){g.localizePage(),C.cli.adaptPhones(),d.cliActive=!0,t.GUI.copyButton=s("a.copy"),t.GUI.windowWrapper=s(".tab-cli .window .wrapper");const o=s('.tab-cli textarea[name="commands"]');r.initialize(o,t.sendLine.bind(t),v),s(r).on("build:start",function(){o.val("").attr("placeholder",g.getMessage("cliInputPlaceholderBuilding")).prop("disabled",!0)}),s(r).on("build:stop",function(){o.attr("placeholder",g.getMessage("cliInputPlaceholder")).prop("disabled",!1).focus()}),s("a.save").on("click",function(){const a=F("cli","txt");k(a,t.outputHistory)}),s("a.clear").click(function(){i()}),t.GUI.copyButton.click(function(){M(t.outputHistory)}),s("a.load").on("click",function(){h()}),s("a.support").toggle(navigator.onLine).on("click",function(){function a(l){i();const u=new R;u.getSupportCommands(async y=>{y=[`###
# Problem description
# ${l}
###`,...y],await c(y.join(`
`));const p=setInterval(()=>{const w=new Date().getTime();if(t.lastArrival<w-250){clearInterval(p);const b=t.outputHistory;u.submitSupportData(b,L=>{v(g.getMessage("buildServerSupportRequestSubmission",[L]))})}},250)})}t.supportWarningDialog(a)}),o.keydown(function(a){if(a.which===9)if(a.preventDefault(),r.isEnabled())!r.isOpen()&&!r.isBuilding()&&r.openLater(!0);else{const y=o.val().split(`
`).pop(),p=S(y,t.cliBuffer);p&&(t.sendNativeAutoComplete(p),o.val(""))}}),o.keypress(function(a){if(a.which===n){if(a.preventDefault(),r.isBuilding())return;const l=o.val();c(l),o.val("")}}),o.keyup(function(a){const l={38:!0},u={40:!0};r.isOpen()||(a.keyCode in l&&o.val(t.history.prev()),a.keyCode in u&&o.val(t.history.next()))}),o.focus(),m.timeout_add("enter_cli",function(){const l=new ArrayBuffer(1),u=new Uint8Array(l);u[0]=35,G.send(l)},250),m.content_ready(e)})};f.adaptPhones=function(){if(s(window).width()<575){const e=s(".note").height()+22+38;s(".backdrop").css("height",`calc(100% - ${e}px)`)}};f.history={history:[],index:0};f.history.add=function(e){this.history.push(e),this.index=this.history.length};f.history.prev=function(){return this.index>0&&(this.index-=1),this.history[this.index]};f.history.next=function(){return this.index<this.history.length&&(this.index+=1),this.history[this.index-1]};const V=8,A=10,I=13;function v(e){C.cli.GUI.windowWrapper.append(e);const t=s(".tab-cli .window");t.scrollTop(t.prop("scrollHeight"))}function W(e){if(r.isBuilding()){r.builderParseLine(e);return}e.startsWith("###ERROR")?v(`<span class="error_message">${e}</span><br>`):v(`${e}<br>`)}function $(e){s(".tab-cli textarea").val(e)}f.read=function(e){const t=new Uint8Array(e.data??e);let n="",i=0;for(let c=0;c<t.length;c++){const h=String.fromCharCode(t[c]),k=h.charCodeAt()===A||h.charCodeAt()===I;if(!d.cliValid&&(k||this.startProcessing)){this.startProcessing=!0,n+=h,v(h);continue}const o=27,a=3;if(t[c]===o&&!i&&(i=a),i){i--;continue}if(d.cliValid)switch(t[c]){case A:m.operating_system==="Windows"&&(W(this.cliBuffer),this.cliBuffer="");break;case I:m.operating_system!=="Windows"&&(W(this.cliBuffer),this.cliBuffer="");break;case 60:this.cliBuffer+="&lt";break;case 62:this.cliBuffer+="&gt";break;case V:this.cliBuffer=this.cliBuffer.slice(0,-1),this.outputHistory=this.outputHistory.slice(0,-1);continue;default:this.cliBuffer+=h}r.isBuilding()||(this.outputHistory+=h),this.cliBuffer==="Rebooting"&&(d.cliActive=!1,d.cliValid=!1,T(g.getMessage("cliReboot")),P())}if(this.lastArrival=new Date().getTime(),!d.cliValid&&n.indexOf("CLI")!==-1){T(g.getMessage("cliEnter")),d.cliValid=!0;const c=n.split(`
`).pop();this.outputHistory=c,r.isEnabled()&&!r.isBuilding()&&r.builderStart()}r.isEnabled()||$(D(this.cliBuffer))};f.sendLine=function(e,t){this.send(`${e}
`,t)};f.sendNativeAutoComplete=function(e,t){this.send(`${e}	`,t)};f.send=function(e,t){const n=new ArrayBuffer(e.length),i=new Uint8Array(n);for(let c=0;c<e.length;c++)i[c]=e.charCodeAt(c);G.send(n,t)};f.supportWarningDialog=function(e){const t=s(".supportWarningDialog")[0],n=s('.tab-cli textarea[name="supportWarningDialogInput"]');t.hasAttribute("open")||(t.showModal(),s(".cancel").on("click",function(){t.close()}),s(".submit").on("click",function(){t.close(),e(n.val()),n.val("")}))};f.cleanup=function(e){if(C.cli.GUI.snippetPreviewWindow&&(C.cli.GUI.snippetPreviewWindow.destroy(),C.cli.GUI.snippetPreviewWindow=null),!(d.connectionValid&&d.cliValid&&d.cliActive)){e&&e();return}this.send(S("exit\r",this.cliBuffer),function(){P(function(){m.timeout_add("tab_change_callback",e,500)})}),d.cliActive=!1,d.cliValid=!1,r.cleanup(),s(r).off()};C.cli=f;export{f as cli};
