import{G as b,C as M,M as i,a as k,$ as e,c as l,t as _,T as Q,b as G,d as ee}from"./DarkTheme-2fd54461.js";import{a as d,s as L,F as a,m as c,l as ae,z as se,e as S,N as w}from"./main-ef562b84.js";import{g as te}from"./generate_filename-f7fae895.js";import{D as T}from"./debug-6343d986.js";let A;const m={blockSize:128,writeError:!1,BLOCK_SIZE:4096};m.initialize=function(p){const u=this;let D,R;b.active_tab!=="onboard_logging"&&(b.active_tab="onboard_logging"),M.connectionValid&&i.send_message(d.MSP_FEATURE_CONFIG,!1,!1,function(){i.send_message(d.MSP_DATAFLASH_SUMMARY,!1,!1,function(){i.send_message(d.MSP_SDCARD_SUMMARY,!1,!1,function(){i.send_message(d.MSP_BLACKBOX_CONFIG,!1,!1,function(){i.send_message(d.MSP_ADVANCED_CONFIG,!1,!1,function(){L.gte(a.CONFIG.apiVersion,k)?i.send_message(d.MSP2_GET_TEXT,c.crunch(d.MSP2_GET_TEXT,d.CRAFT_NAME),!1,O):i.send_message(d.MSP_NAME,!1,!1,O)})})})})});function N(s,t){return t===0?s:N(t,s%t)}function O(){e("#content").load("./tabs/onboard_logging.html",function(){l.localizePage();const s=a.DATAFLASH.totalSize>0;let t;a.BLACKBOX.supported||a.DATAFLASH.supported||a.FEATURE_CONFIG.features.isEnabled("BLACKBOX")?t="yes":t="no",e(".tab-onboard_logging").addClass("serial-supported").toggleClass("dataflash-supported",a.DATAFLASH.supported).toggleClass("dataflash-present",s).toggleClass("sdcard-supported",a.SDCARD.supported).toggleClass("blackbox-config-supported",a.BLACKBOX.supported).toggleClass("blackbox-supported",t==="yes").toggleClass("blackbox-maybe-supported",t==="maybe").toggleClass("blackbox-unsupported",t==="no"),s&&(e(".tab-onboard_logging a.erase-flash").click(Z),e(".tab-onboard_logging a.erase-flash-confirm").click(W),e(".tab-onboard_logging a.erase-flash-cancel").click(j),e(".tab-onboard_logging a.save-flash").click(Y),e(".tab-onboard_logging a.save-flash-cancel").click(U),e(".tab-onboard_logging a.save-flash-dismiss").click(F));const o=e(".blackboxDevice select"),n=e(".blackboxRate select"),g=e(".blackboxDebugMode select"),f=e(".blackboxDebugFields select");a.BLACKBOX.supported&&e(".tab-onboard_logging a.save-settings").on("click",async function(){if(L.gte(a.CONFIG.apiVersion,k)){let r=0;e(".blackboxDebugFields select option:not(:selected)").each(function(){r|=1<<e(this).val()}),a.BLACKBOX.blackboxDisabledMask=r}a.BLACKBOX.blackboxSampleRate=parseInt(n.val(),10),a.BLACKBOX.blackboxPDenom=parseInt(n.val(),10),a.BLACKBOX.blackboxDevice=parseInt(o.val(),10),await i.promise(d.MSP_SET_BLACKBOX_CONFIG,c.crunch(d.MSP_SET_BLACKBOX_CONFIG)),a.PID_ADVANCED_CONFIG.debugMode=parseInt(g.val()),await i.promise(d.MSP_SET_ADVANCED_CONFIG,c.crunch(d.MSP_SET_ADVANCED_CONFIG)),c.writeConfiguration(!0)}),H(n),y(o),K(g),$(f),o.change(function(){e(this).val()==="0"?e("div.blackboxRate").hide():e("div.blackboxRate").show()}).change(),(a.SDCARD.supported&&o.val()==2||a.DATAFLASH.supported&&o.val()==1)&&(e(".tab-onboard_logging").toggleClass("msc-supported",!0),e("a.onboardLoggingRebootMsc").click(function(){_.sendEvent(_.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"RebootMsc");const r=[];b.operating_system==="Linux"?r.push(c.REBOOT_TYPES.MSC_UTC):r.push(c.REBOOT_TYPES.MSC),i.send_message(d.MSP_SET_REBOOT,r,!1)})),E(),b.content_ready(p)})}function y(s){s.empty(),s.append(`<option value="0">${l.getMessage("blackboxLoggingNone")}</option>`),a.DATAFLASH.supported&&s.append(`<option value="1">${l.getMessage("blackboxLoggingFlash")}</option>`),a.SDCARD.supported&&s.append(`<option value="2">${l.getMessage("blackboxLoggingSdCard")}</option>`),s.append(`<option value="3">${l.getMessage("blackboxLoggingSerial")}</option>`),s.val(a.BLACKBOX.blackboxDevice)}function H(s){const t=a.CONFIG.sampleRateHz/a.PID_ADVANCED_CONFIG.pid_process_denom,o=5;for(let n=0;n<o;n++){let g=Math.round(t/2**n),f="Hz";N(g,1e3)===1e3&&(g/=1e3,f="kHz"),s.append(`<option value="${n}">1/${2**n} (${g}${f})</option>`)}s.val(a.BLACKBOX.blackboxSampleRate)}function K(s){e(".blackboxDebugMode").show();for(let t=0;t<a.PID_ADVANCED_CONFIG.debugModeCount;t++)t<T.modes.length?s.append(new Option(T.modes[t].text,t)):s.append(new Option(l.getMessage("onboardLoggingDebugModeUnknown"),t));s.val(a.PID_ADVANCED_CONFIG.debugMode).select2().sortSelect("NONE")}function $(s){if(L.gte(a.CONFIG.apiVersion,k)){e(".blackboxDebugFields").show();let t=a.BLACKBOX.blackboxDisabledMask;for(let o=0;o<T.enableFields.length;o++){const n=(t&1<<o)===0;s.append(new Option(T.enableFields[o].text,o,!1,n))}s.sortSelect().multipleSelect()}else e(".blackboxDebugFields").hide()}function v(s){if(s<1024)return`${Math.round(s)}kB`;const t=s/1024;let o;return t<900?`${t.toFixed(1)}MB`:(o=t/1024,`${o.toFixed(1)}GB`)}function X(s){return s<1024?`${s}B`:v(s/1024)}function C(s,t,o,n,g){t>0?(s.css({width:`${t/o*100}%`,display:"block"}),e("div",s).text((n?`${n} `:"")+(g?v(t):X(t)))):s.css({display:"none"})}e('input[name="expertModeCheckbox"]').on("change",()=>e("a.regular-button.require-msc-supported.save-flash").toggle(ae()));function E(){const s=a.DATAFLASH.totalSize>0;C(e(".tab-onboard_logging .dataflash-used"),a.DATAFLASH.usedSize,a.DATAFLASH.totalSize,l.getMessage("dataflashUsedSpace"),!1),C(e(".tab-onboard_logging .dataflash-free"),a.DATAFLASH.totalSize-a.DATAFLASH.usedSize,a.DATAFLASH.totalSize,l.getMessage("dataflashFreeSpace"),!1),C(e(".tab-onboard_logging .sdcard-other"),a.SDCARD.totalSizeKB-a.SDCARD.freeSizeKB,a.SDCARD.totalSizeKB,l.getMessage("dataflashUnavSpace"),!0),C(e(".tab-onboard_logging .sdcard-free"),a.SDCARD.freeSizeKB,a.SDCARD.totalSizeKB,l.getMessage("dataflashLogsSpace"),!0),e("a.regular-button erase-flash, a.regular-button.require-msc-supported.save-flash").toggleClass("disabled",a.DATAFLASH.usedSize===0),e(".tab-onboard_logging").toggleClass("sdcard-error",a.SDCARD.state===i.SDCARD_STATE_FATAL).toggleClass("sdcard-initializing",a.SDCARD.state===i.SDCARD_STATE_CARD_INIT||a.SDCARD.state===i.SDCARD_STATE_FS_INIT).toggleClass("sdcard-ready",a.SDCARD.state===i.SDCARD_STATE_READY);const t=s||a.SDCARD.state===i.SDCARD_STATE_READY;e(".tab-onboard_logging").toggleClass("msc-not-ready",!t),t?e("a.onboardLoggingRebootMsc").removeClass("disabled"):e("a.onboardLoggingRebootMsc").addClass("disabled");let o;switch(a.SDCARD.state){case i.SDCARD_STATE_NOT_PRESENT:e(".sdcard-status").text(l.getMessage("sdcardStatusNoCard")),o="SdCard: NotPresent";break;case i.SDCARD_STATE_FATAL:e(".sdcard-status").html(l.getMessage("sdcardStatusReboot")),o="SdCard: Error";break;case i.SDCARD_STATE_READY:e(".sdcard-status").text(l.getMessage("sdcardStatusReady")),o="SdCard: Ready";break;case i.SDCARD_STATE_CARD_INIT:e(".sdcard-status").text(l.getMessage("sdcardStatusStarting")),o="SdCard: Init";break;case i.SDCARD_STATE_FS_INIT:e(".sdcard-status").text(l.getMessage("sdcardStatusFileSystem")),o="SdCard: FsInit";break;default:e(".sdcard-status").text(l.getMessage("sdcardStatusUnknown",[a.SDCARD.state]))}s&&a.SDCARD.state===i.SDCARD_STATE_NOT_PRESENT&&(o="Dataflash"),_.sendEvent(_.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"DataLogging",{logSize:a.DATAFLASH.usedSize,logStatus:o}),a.SDCARD.supported&&!A&&(A=setTimeout(function(){A=!1,M.connectionValid&&i.send_message(d.MSP_SDCARD_SUMMARY,!1,!1,function(){E()})},2e3))}function U(){D=!0}function V(){e(".dataflash-saving progress").attr("value",0),D=!1,e(".dataflash-saving").removeClass("done"),e(".dataflash-saving")[0].showModal()}function F(){e(".dataflash-saving")[0].close()}function B(s,t,o){_.sendEvent(_.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"SaveDataflash");const n=(new Date().getTime()-s)/1e3;console.log(`Received ${t} bytes in ${n.toFixed(2)}s (${(t/n/1024).toFixed(2)}kB / s) with block size ${u.blockSize}.`),isNaN(o)||console.log("Compressed into",o,"bytes with mean compression factor of",t/o),e(".dataflash-saving").addClass("done"),w.showNotification("Betaflight Configurator",{body:l.getMessage("flashDownloadDoneNotification"),icon:"/images/pwa/favicon.ico"})}function I(s){i.send_message(d.MSP_DATAFLASH_SUMMARY,!1,!1,function(){E(),s&&s()})}function Y(){b.connected_to&&(u.blockSize=u.BLOCK_SIZE,I(function(){const s=a.DATAFLASH.usedSize;let t;q(function(o){let n=0,g=0;V();function f(P,h,z){if(h!==null)if(h.byteLength>0){n+=h.byteLength,isNaN(z)||isNaN(g)?g=null:g+=z,e(".dataflash-saving progress").attr("value",n/s*100);const J=new Blob([h]);S.writeChunck(t,J).then(()=>{D||n>=s?(D?F():B(r,n,g),S.closeFile(t)):u.writeError?(F(),S.closeFile(t)):c.dataflashRead(n,u.blockSize,f)})}else B(r,n,g),S.closeFile(t);else c.dataflashRead(n,u.blockSize,f)}const r=new Date().getTime();S.openFile(o).then(P=>{t=P,c.dataflashRead(n,u.blockSize,f)})})}))}function q(s){const t="BLACKBOX_LOG",o="BBL",n=te(t,o);S.pickSaveFile(n,l.getMessage("fileSystemPickerFiles",{typeof:o}),`.${o}`).then(g=>{console.log("File picked:",g),s(g)}).then(()=>{console.log("FINISHED")}).catch(g=>{console.error("Error saving blackbox file:",g),G(l.getMessage("dataflashFileWriteFailed")),G(`<strong><span class="message-negative">${l.getMessage("error",{errorMessage:g})}</span class="message-negative></strong>`)})}function Z(){R=!1,e(".dataflash-confirm-erase").removeClass("erasing"),e(".dataflash-confirm-erase")[0].showModal()}function x(){I(function(){M.connectionValid&&!R&&(a.DATAFLASH.ready?(e(".dataflash-confirm-erase")[0].close(),ee("showNotifications")&&w.showNotification("Betaflight Configurator",{body:l.getMessage("flashEraseDoneNotification"),icon:"/images/pwa/favicon.ico"})):setTimeout(x,500))})}function W(){e(".dataflash-confirm-erase").addClass("erasing"),i.send_message(d.MSP_DATAFLASH_ERASE,!1,!1,x)}function j(){R=!0,e(".dataflash-confirm-erase")[0].close()}};m.cleanup=function(p){A&&(clearTimeout(A),A=!1),p&&p()};m.mscRebootFailedCallback=function(){e(".tab-onboard_logging").toggleClass("msc-supported",!1),se(l.getMessage("operationNotSupported"))};Q.onboard_logging=m;export{m as onboard_logging};
